<!DOCTYPE html>
<html lang="en-US">
  <head>
    <title>Awesome Frontend</title><meta name="description" content="这是一个自以为是的前端技术选择和推荐网站"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.23">
    <link rel="modulepreload" href="/assets/app.969c9eca.js"><link rel="modulepreload" href="/assets/c0232eb08d0f4fb5a1ed997bbd04e130.html.9820d2a1.js"><link rel="modulepreload" href="/assets/c0232eb08d0f4fb5a1ed997bbd04e130.html.21e0509f.js">
    <link rel="stylesheet" href="/assets/style.ab239ff8.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button"><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><span><a href="/" class=""><!----><span class="site-name">Awesome Frontend</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/" class="nav-link" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/rxliuli/wiki" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/" class="nav-link" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/rxliuli/wiki" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item">其他</p><ul class=""><li><!--[--><p class="sidebar-item">Git</p><ul class="sidebar-sub-items"><li><!--[--><a href="/p/b63ba6ff31c049f8a6703ce7022a79e6.html" class="nav-link sidebar-item" aria-label="Git 速查清单"><!--[--><!--]--> Git 速查清单 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/1db27f8106cc48218641490889f37793.html" class="nav-link sidebar-item" aria-label="Git 设置和取消代理"><!--[--><!--]--> Git 设置和取消代理 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">IDEA</p><ul class="sidebar-sub-items"><li><!--[--><a href="/p/4196df6a040f4c0aa3016547d895bf6b.html" class="nav-link sidebar-item" aria-label="WebStorm 使用技巧"><!--[--><!--]--> WebStorm 使用技巧 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/b80cb42493004bb482cc1762d5e90c9e.html" class="nav-link sidebar-item" aria-label="IDEA 设置 Git-Bash 为默认 Terminal"><!--[--><!--]--> IDEA 设置 Git-Bash 为默认 Terminal <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">VSCode</p><ul class="sidebar-sub-items"><li><!--[--><a href="/p/522048077c1343b79eb9f42640c02bd0.html" class="nav-link sidebar-item" aria-label="VSCode 搭建 markdown 写作环境"><!--[--><!--]--> VSCode 搭建 markdown 写作环境 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/a305aafaac2b4ee8b9fa2f97898f1eea.html" class="nav-link sidebar-item" aria-label="VSCode 与 WebStorm 横向对比"><!--[--><!--]--> VSCode 与 WebStorm 横向对比 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Windows</p><ul class="sidebar-sub-items"><li><!--[--><a href="/p/d25cb9b2f5d446ce852b03c15e8fb8e5.html" class="nav-link sidebar-item" aria-label="Windows 上的工具清单"><!--[--><!--]--> Windows 上的工具清单 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/7f94aa8c6eff4eaaab7004361fe0614f.html" class="nav-link sidebar-item" aria-label="Windows 使用技巧"><!--[--><!--]--> Windows 使用技巧 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/cdeb250dd4e04b168bc608cc9a118697.html" class="nav-link sidebar-item" aria-label="优化 Google Chrome 的使用体验"><!--[--><!--]--> 优化 Google Chrome 的使用体验 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">工具</p><ul class="sidebar-sub-items"><li><!--[--><a href="/p/e46fa2086bea40d087ac8bd8e30d02ae.html" class="nav-link sidebar-item" aria-label="使用 VSCode 在 Markdown 中绘图"><!--[--><!--]--> 使用 VSCode 在 Markdown 中绘图 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">杂谈</p><ul class="sidebar-sub-items"><li><!--[--><a href="/p/0391e85b82f5465cb1ab0ff962a50ea7.html" class="nav-link sidebar-item" aria-label="为什么要用现代前端"><!--[--><!--]--> 为什么要用现代前端 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/1a01dae8fd924bb6a0d5f4ee7f6847cf.html" class="nav-link sidebar-item" aria-label="前端与后端的选择（个人理解）"><!--[--><!--]--> 前端与后端的选择（个人理解） <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item active">前端</p><ul class=""><li><!--[--><p class="sidebar-item">Electron</p><ul class="sidebar-sub-items"><li><!--[--><a href="/p/624ba71c53634ea591de1338111da396.html" class="nav-link sidebar-item" aria-label="electron 开发经验之谈系列-简介"><!--[--><!--]--> electron 开发经验之谈系列-简介 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/76393a60949c47c7add910df0206734c.html" class="nav-link sidebar-item" aria-label="electron 开发经验之谈系列-渲染、主进程通信"><!--[--><!--]--> electron 开发经验之谈系列-渲染、主进程通信 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/0a4259c97ca440d1b5375f4e21eaaace.html" class="nav-link sidebar-item" aria-label="electron 开发经验之谈系列-electron 自定义协议"><!--[--><!--]--> electron 开发经验之谈系列-electron 自定义协议 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/5ce7d75fe2dc46838b49f9e5e14ac738.html" class="nav-link sidebar-item" aria-label="electron 开发经验之谈系列-在渲染、主进程间共享数据"><!--[--><!--]--> electron 开发经验之谈系列-在渲染、主进程间共享数据 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/6edf2cfaf7ec46f0bfb659d8c7246c52.html" class="nav-link sidebar-item" aria-label="electron 开发经验之谈系列-技术栈简介及选择"><!--[--><!--]--> electron 开发经验之谈系列-技术栈简介及选择 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/c68829779f5449d0afe0e67806dc7fc1.html" class="nav-link sidebar-item" aria-label="electron 开发经验之谈系列-常见问题"><!--[--><!--]--> electron 开发经验之谈系列-常见问题 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/33dd9a3fccaf4666b04935237f885772.html" class="nav-link sidebar-item" aria-label="electron 开发经验之谈系列-使用 electron-builder 打包"><!--[--><!--]--> electron 开发经验之谈系列-使用 electron-builder 打包 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/23ec4673a06f41b59bfaf5a7da6d98db.html" class="nav-link sidebar-item" aria-label="electron 开发经验之谈系列-基本项目搭建"><!--[--><!--]--> electron 开发经验之谈系列-基本项目搭建 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/5cc9156517484576a64b4d253ae28af8.html" class="nav-link sidebar-item" aria-label="electron 开发经验之谈系列-开发环境优化"><!--[--><!--]--> electron 开发经验之谈系列-开发环境优化 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/85f539d2cc4e4ae89093df537111cec8.html" class="nav-link sidebar-item" aria-label="electron 开发经验之谈系列-自定义窗口顶栏"><!--[--><!--]--> electron 开发经验之谈系列-自定义窗口顶栏 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/bf7621c04d9f45098fb0ecf2acad336e.html" class="nav-link sidebar-item" aria-label="electron 开发经验之谈系列-自动更新"><!--[--><!--]--> electron 开发经验之谈系列-自动更新 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">React</p><ul class="sidebar-sub-items"><li><!--[--><a href="/p/e76cfaa1f454465bbeb62006b53b2c78.html" class="nav-link sidebar-item" aria-label="基本的国际化 i18next"><!--[--><!--]--> 基本的国际化 i18next <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">TypeScript</p><ul class="sidebar-sub-items"><li><!--[--><a href="/p/f1d61494bcdd4cad8f7dbf73c908c884.html" class="nav-link sidebar-item" aria-label="TypeScript 技巧总结"><!--[--><!--]--> TypeScript 技巧总结 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/d101451820354652a932ffe820d9d1c5.html" class="nav-link sidebar-item" aria-label="TypeScript 类型编程"><!--[--><!--]--> TypeScript 类型编程 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/03ee7047ae3c4203b0c4c4ebfd6d7bd9.html" class="nav-link sidebar-item" aria-label="JavaScript =&gt; TypeScript 迁移体验"><!--[--><!--]--> JavaScript =&gt; TypeScript 迁移体验 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">前端资源管理</p><ul class="sidebar-sub-items"><li><!--[--><a href="/p/12431937fef84d9eac1af65d170ac802.html" class="nav-link sidebar-item" aria-label="工程化"><!--[--><!--]--> 工程化 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/b39ddde71e3f489a9e4c9f5591815b27.html" class="nav-link sidebar-item" aria-label="实用 cli"><!--[--><!--]--> 实用 cli <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/747540dfc3224b2eb1620f4aafdac930.html" class="nav-link sidebar-item" aria-label="简介"><!--[--><!--]--> 简介 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/bf906b7fd7484a72ae06ada322bd9958.html" class="nav-link sidebar-item" aria-label="文档"><!--[--><!--]--> 文档 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/b1530f57cd9344b7b5b76dabcfcf454f.html" class="nav-link sidebar-item" aria-label="框架及社区"><!--[--><!--]--> 框架及社区 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/98e7ab6570ff4b55a698750423d39d2d.html" class="nav-link sidebar-item" aria-label="工具函数库"><!--[--><!--]--> 工具函数库 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item active">基于 Web 的扩展系统设计</p><ul class="sidebar-sub-items"><li><!--[--><a href="/p/1b058aecef544bebbe805c469d65bd54.html" class="nav-link sidebar-item" aria-label="基于 WebWorker 封装 JavaScript 沙箱"><!--[--><!--]--> 基于 WebWorker 封装 JavaScript 沙箱 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/53784162ade2454498a210a59796fae6.html" class="nav-link sidebar-item" aria-label="基于 EventEmitter 封装更上层的 api"><!--[--><!--]--> 基于 EventEmitter 封装更上层的 api <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/5683c73c8ccc4aeeb4685c2a9b0c5f9a.html" class="nav-link sidebar-item" aria-label="在 Web 上实现窗口"><!--[--><!--]--> 在 Web 上实现窗口 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/bafce41b0e6840908c5b5452c0fca1db.html" class="nav-link sidebar-item" aria-label="JavaScript 沙箱探索"><!--[--><!--]--> JavaScript 沙箱探索 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/p/c0232eb08d0f4fb5a1ed997bbd04e130.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="基于 quickjs 封装 JavaScript 沙箱"><!--[--><!--]--> 基于 quickjs 封装 JavaScript 沙箱 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/p/c0232eb08d0f4fb5a1ed997bbd04e130.html#场景" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="场景"><!--[--><!--]--> 场景 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/p/c0232eb08d0f4fb5a1ed997bbd04e130.html#简化底层-api" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="简化底层 api"><!--[--><!--]--> 简化底层 api <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/p/c0232eb08d0f4fb5a1ed997bbd04e130.html#自动调用-dispose" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="自动调用 dispose"><!--[--><!--]--> 自动调用 dispose <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/p/c0232eb08d0f4fb5a1ed997bbd04e130.html#提供更好的创建-vm-值的方法" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="提供更好的创建 vm 值的方法"><!--[--><!--]--> 提供更好的创建 vm 值的方法 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/p/c0232eb08d0f4fb5a1ed997bbd04e130.html#实现-console-settimeout-setinterval-等常见-api" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="实现 console/setTimeout/setInterval 等常见 api"><!--[--><!--]--> 实现 console/setTimeout/setInterval 等常见 api <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/p/c0232eb08d0f4fb5a1ed997bbd04e130.html#实现-console" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="实现 console"><!--[--><!--]--> 实现 console <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/p/c0232eb08d0f4fb5a1ed997bbd04e130.html#实现-settimeout" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="实现 setTimeout"><!--[--><!--]--> 实现 setTimeout <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/p/c0232eb08d0f4fb5a1ed997bbd04e130.html#实现-setinterval" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="实现 setInterval"><!--[--><!--]--> 实现 setInterval <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/p/c0232eb08d0f4fb5a1ed997bbd04e130.html#实现事件循环" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="实现事件循环"><!--[--><!--]--> 实现事件循环 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/p/c0232eb08d0f4fb5a1ed997bbd04e130.html#实现沙箱与系统之间的通信" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="实现沙箱与系统之间的通信"><!--[--><!--]--> 实现沙箱与系统之间的通信 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/p/c0232eb08d0f4fb5a1ed997bbd04e130.html#实现-ijavascriptshadowbox" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="实现 IJavaScriptShadowbox"><!--[--><!--]--> 实现 IJavaScriptShadowbox <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/p/c0232eb08d0f4fb5a1ed997bbd04e130.html#目前-quickjs-沙箱的限制" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="目前 quickjs 沙箱的限制"><!--[--><!--]--> 目前 quickjs 沙箱的限制 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">工程化</p><ul class="sidebar-sub-items"><li><!--[--><a href="/p/f35319c382cf488082a1df13dad35005.html" class="nav-link sidebar-item" aria-label="如何减少 monorepo 中 lib 的初始化时间"><!--[--><!--]--> 如何减少 monorepo 中 lib 的初始化时间 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/556ea9eee38842c0be108ada810b711f.html" class="nav-link sidebar-item" aria-label="yarn2 使用"><!--[--><!--]--> yarn2 使用 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/0171bcd51b1343d6a9ad54557d567c46.html" class="nav-link sidebar-item" aria-label="在现代前端项目中使用 Worker"><!--[--><!--]--> 在现代前端项目中使用 Worker <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/d9b7ea8e049b42628164019b16f762d2.html" class="nav-link sidebar-item" aria-label="lerna 使用踩坑"><!--[--><!--]--> lerna 使用踩坑 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/1a6dda43a5a84e61b4b16865d8e52373.html" class="nav-link sidebar-item" aria-label="实践 lerna monorepo"><!--[--><!--]--> 实践 lerna monorepo <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/d984e195f1b1469ca49ff364374ce3d8.html" class="nav-link sidebar-item" aria-label="关于前端组件通信的一些理解"><!--[--><!--]--> 关于前端组件通信的一些理解 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/b8a95af9134a488e9d94463bd18768c9.html" class="nav-link sidebar-item" aria-label="编写兼容 nodejs/浏览器的库"><!--[--><!--]--> 编写兼容 nodejs/浏览器的库 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/6be33848912b4a63bd0bfebe0e99fda1.html" class="nav-link sidebar-item" aria-label="React 根据状态动态化功能的一些思考"><!--[--><!--]--> React 根据状态动态化功能的一些思考 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/3b1502f22ad645b5a6521b39b145e560.html" class="nav-link sidebar-item" aria-label="使用 React Context 结合 EventEmitter"><!--[--><!--]--> 使用 React Context 结合 EventEmitter <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/7b0fe35b00b345618a9323977a2e552a.html" class="nav-link sidebar-item" aria-label="使用 gh-pages 发布前端项目"><!--[--><!--]--> 使用 gh-pages 发布前端项目 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">框架</p><ul class="sidebar-sub-items"><li><!--[--><a href="/p/349ef4aeec0c466c8566d8383f596941.html" class="nav-link sidebar-item" aria-label="在 ts 中使用 graphql"><!--[--><!--]--> 在 ts 中使用 graphql <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/664f86d038744a01894699e368cc2708.html" class="nav-link sidebar-item" aria-label="前端资源管理"><!--[--><!--]--> 前端资源管理 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/c55a6470683e498f92ba05d7ff710b3a.html" class="nav-link sidebar-item" aria-label="react 通用列表组件封装"><!--[--><!--]--> react 通用列表组件封装 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/8c57648407fa4b72ac30c3a61b1c1fef.html" class="nav-link sidebar-item" aria-label="在传统项目中使用 babel 编译 ES6"><!--[--><!--]--> 在传统项目中使用 babel 编译 ES6 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/p/d7c0007c37f24d4cb4a3c5a1dbb9d3d6.html" class="nav-link sidebar-item" aria-label="前端如何根据不同权限分割逻辑代码？（state/method）"><!--[--><!--]--> 前端如何根据不同权限分割逻辑代码？（state/method） <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h2 id="场景" tabindex="-1"><a class="header-anchor" href="#场景" aria-hidden="true">#</a> 场景</h2><p>在前文 <a href="/p/bafce41b0e6840908c5b5452c0fca1db">JavaScript 沙箱探索</a> 中声明了沙箱的接口，并且给出了一些简单的执行任意第三方 js 脚本的代码，但并未实现完整的 <code>IJavaScriptShadowbox</code>，下面便讲一下如何基于 quickjs 实现它。</p><p>quickjs 在 js 的封装库是 <a href="https://github.com/justjake/quickjs-emscripten/" target="_blank" rel="noopener noreferrer">quickjs-emscripten<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>，基本原理是将 c 编译为 wasm 然后运行在浏览器、nodejs 上，它提供了以下基础的 api。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">LowLevelJavascriptVm<span class="token operator">&lt;</span>VmHandle<span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  global<span class="token operator">:</span> VmHandle<span class="token punctuation">;</span>
  <span class="token keyword">undefined</span><span class="token operator">:</span> VmHandle<span class="token punctuation">;</span>
  <span class="token keyword">typeof</span><span class="token punctuation">(</span>handle<span class="token operator">:</span> VmHandle<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token function">getNumber</span><span class="token punctuation">(</span>handle<span class="token operator">:</span> VmHandle<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  <span class="token function">getString</span><span class="token punctuation">(</span>handle<span class="token operator">:</span> VmHandle<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token function">newNumber</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> VmHandle<span class="token punctuation">;</span>
  <span class="token function">newString</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> VmHandle<span class="token punctuation">;</span>
  <span class="token function">newObject</span><span class="token punctuation">(</span>prototype<span class="token operator">?</span><span class="token operator">:</span> VmHandle<span class="token punctuation">)</span><span class="token operator">:</span> VmHandle<span class="token punctuation">;</span>
  <span class="token function">newFunction</span><span class="token punctuation">(</span>
    name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    value<span class="token operator">:</span> VmFunctionImplementation<span class="token operator">&lt;</span>VmHandle<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> VmHandle<span class="token punctuation">;</span>
  <span class="token function">getProp</span><span class="token punctuation">(</span>handle<span class="token operator">:</span> VmHandle<span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> VmHandle<span class="token punctuation">)</span><span class="token operator">:</span> VmHandle<span class="token punctuation">;</span>
  <span class="token function">setProp</span><span class="token punctuation">(</span>handle<span class="token operator">:</span> VmHandle<span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> VmHandle<span class="token punctuation">,</span> value<span class="token operator">:</span> VmHandle<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">defineProp</span><span class="token punctuation">(</span>
    handle<span class="token operator">:</span> VmHandle<span class="token punctuation">,</span>
    key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> VmHandle<span class="token punctuation">,</span>
    descriptor<span class="token operator">:</span> VmPropertyDescriptor<span class="token operator">&lt;</span>VmHandle<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">callFunction</span><span class="token punctuation">(</span>
    func<span class="token operator">:</span> VmHandle<span class="token punctuation">,</span>
    thisVal<span class="token operator">:</span> VmHandle<span class="token punctuation">,</span>
    <span class="token operator">...</span>args<span class="token operator">:</span> VmHandle<span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> VmCallResult<span class="token operator">&lt;</span>VmHandle<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token function">evalCode</span><span class="token punctuation">(</span>code<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> VmCallResult<span class="token operator">&lt;</span>VmHandle<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>下面是一段官方的代码示例</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> getQuickJS <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;quickjs-emscripten&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> QuickJS <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getQuickJS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> vm <span class="token operator">=</span> QuickJS<span class="token punctuation">.</span><span class="token function">createVm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> world <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">newString</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  vm<span class="token punctuation">.</span><span class="token function">setProp</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>global<span class="token punctuation">,</span> <span class="token string">&quot;NAME&quot;</span><span class="token punctuation">,</span> world<span class="token punctuation">)</span><span class="token punctuation">;</span>
  world<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> result <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;Hello &quot; + NAME + &quot;!&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Execution failed:&quot;</span><span class="token punctuation">,</span> vm<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span>error<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Success:&quot;</span><span class="token punctuation">,</span> vm<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  vm<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>可以看到，创建 vm 中的变量后还必须留意调用 <code>dispose</code>，有点像是后端连接数据库时必须注意关闭连接，而这其实是比较繁琐的，尤其是在复杂的情况下。简而言之，它的 api 太过于底层了。在 github issue 中有人创建了 <a href="https://github.com/reearth/quickjs-emscripten-sync" target="_blank" rel="noopener noreferrer">quickjs-emscripten-sync<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>，这给了吾辈很多灵感，所以吾辈基于 quickjs-emscripten 封装了一些工具函数，辅助而非替代它。</p><h2 id="简化底层-api" tabindex="-1"><a class="header-anchor" href="#简化底层-api" aria-hidden="true">#</a> 简化底层 api</h2><p>主要目的有两个</p><ul><li>自动调用 <code>dispose</code></li><li>提供更好的创建 vm 值的方法</li></ul><h3 id="自动调用-dispose" tabindex="-1"><a class="header-anchor" href="#自动调用-dispose" aria-hidden="true">#</a> 自动调用 <code>dispose</code></h3><p>主要思路是自动收集所有需要调用 <code>dispose</code> 的值，使用高阶函数在 callback 执行完之后自动调用。</p><blockquote><p>这里还需要注意避免不需要的多层嵌套代理，主要是考虑到下面更多的底层 api 基于它实现，而它们之间可能存在嵌套调用。</p></blockquote><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> QuickJSHandle<span class="token punctuation">,</span> QuickJSVm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;quickjs-emscripten&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> QuickJSVmScopeSymbol <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;QuickJSVmScope&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 为 QuickJSVm 添加局部作用域，局部作用域的所有方法调用不再需要手动释放内存
 * <span class="token keyword">@param</span> <span class="token parameter">vm</span>
 * <span class="token keyword">@param</span> <span class="token parameter">handle</span>
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> withScope<span class="token operator">&lt;</span><span class="token constant">F</span> <span class="token keyword">extends</span> <span class="token punctuation">(</span>vm<span class="token operator">:</span> QuickJSVm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  vm<span class="token operator">:</span> QuickJSVm<span class="token punctuation">,</span>
  handle<span class="token operator">:</span> <span class="token constant">F</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> ReturnType<span class="token operator">&lt;</span><span class="token constant">F</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> disposes<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">wrap</span><span class="token punctuation">(</span>handle<span class="token operator">:</span> QuickJSHandle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    disposes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> handle<span class="token punctuation">.</span>alive <span class="token operator">&amp;&amp;</span> handle<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> handle<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//避免多层代理</span>
  <span class="token keyword">const</span> isProxy <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> QuickJSVmScopeSymbol<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> QuickJSVmScopeSymbol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    disposes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dispose<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//手动释放闭包变量的内存</span>
    disposes<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">handle</span><span class="token punctuation">(</span>
    isProxy
      <span class="token operator">?</span> vm
      <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          <span class="token function">get</span><span class="token punctuation">(</span>
            target<span class="token operator">:</span> QuickJSVm<span class="token punctuation">,</span>
            p<span class="token operator">:</span> <span class="token keyword">keyof</span> QuickJSVm <span class="token operator">|</span> <span class="token keyword">typeof</span> QuickJSVmScopeSymbol
          <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">===</span> QuickJSVmScopeSymbol<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> dispose<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//锁定所有方法的 this 值为 QuickJSVm 对象而非 Proxy 对象</span>
            <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>
              p<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;new&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span>
              <span class="token punctuation">[</span><span class="token string">&quot;getProp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;unwrapResult&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> QuickJSHandle <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token function">Reflect</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> target<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;evalCode&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;callFunction&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                disposes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                  <span class="token keyword">const</span> handle <span class="token operator">=</span> res<span class="token punctuation">.</span>error <span class="token operator">??</span> res<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
                  handle<span class="token punctuation">.</span>alive <span class="token operator">&amp;&amp;</span> handle<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> res<span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> res <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">Reflect</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> target<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> dispose <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br></div></div><p>使用</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token function">withScope</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> _hello <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">newFunction</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> _object <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  vm<span class="token punctuation">.</span><span class="token function">setProp</span><span class="token punctuation">(</span>_object<span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> _hello<span class="token punctuation">)</span><span class="token punctuation">;</span>
  vm<span class="token punctuation">.</span><span class="token function">setProp</span><span class="token punctuation">(</span>_object<span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> vm<span class="token punctuation">.</span><span class="token function">newString</span><span class="token punctuation">(</span><span class="token string">&quot;liuli&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">getProp</span><span class="token punctuation">(</span>_object<span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toBeNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  vm<span class="token punctuation">.</span><span class="token function">setProp</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>global<span class="token punctuation">,</span> <span class="token string">&quot;VM_GLOBAL&quot;</span><span class="token punctuation">,</span> _object<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>甚至支持嵌套调用，而且仅需要在最外层统一调用 <code>dispose</code> 即可</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token function">withScope</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">withScope</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">unwrapResult</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token string">&quot;1+1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="提供更好的创建-vm-值的方法" tabindex="-1"><a class="header-anchor" href="#提供更好的创建-vm-值的方法" aria-hidden="true">#</a> 提供更好的创建 vm 值的方法</h3><p>主要思路是判断创建 vm 变量的类型，自动调用相应的函数，然后返回创建的变量。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> QuickJSHandle<span class="token punctuation">,</span> QuickJSVm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;quickjs-emscripten&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> withScope <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./withScope&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">MarshalValue</span> <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> QuickJSHandle<span class="token punctuation">;</span> <span class="token function-variable function">dispose</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 简化使用 QuickJSVm 创建复杂对象的操作
 * <span class="token keyword">@param</span> <span class="token parameter">vm</span>
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">marshal</span><span class="token punctuation">(</span>vm<span class="token operator">:</span> QuickJSVm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">marshal</span><span class="token punctuation">(</span><span class="token function-variable function">value</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> MarshalValue<span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">marshal</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> MarshalValue<span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">marshal</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> name<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> MarshalValue <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">withScope</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">function</span> <span class="token function">_f</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> name<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> QuickJSHandle <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">newString</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">newNumber</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">&quot;boolean&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">unwrapResult</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> vm<span class="token punctuation">.</span>undefined<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> vm<span class="token punctuation">.</span>null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">&quot;bigint&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">unwrapResult</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">BigInt(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">newFunction</span><span class="token punctuation">(</span>name<span class="token operator">!</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> _array <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">newArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            value<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> v <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;数组中禁止包含函数，因为无法指定名字&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              vm<span class="token punctuation">.</span><span class="token function">callFunction</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">getProp</span><span class="token punctuation">(</span>_array<span class="token punctuation">,</span> <span class="token string">&quot;push&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _array<span class="token punctuation">,</span> <span class="token function">_f</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> _array<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> _map <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">unwrapResult</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token string">&quot;new Map()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            value<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              vm<span class="token punctuation">.</span><span class="token function">unwrapResult</span><span class="token punctuation">(</span>
                vm<span class="token punctuation">.</span><span class="token function">callFunction</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">getProp</span><span class="token punctuation">(</span>_map<span class="token punctuation">,</span> <span class="token string">&quot;set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _map<span class="token punctuation">,</span> <span class="token function">_f</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_f</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> _map<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">const</span> _object <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span>k<span class="token punctuation">,</span> v<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            vm<span class="token punctuation">.</span><span class="token function">setProp</span><span class="token punctuation">(</span>_object<span class="token punctuation">,</span> k<span class="token punctuation">,</span> <span class="token function">_f</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> _object<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;不支持的类型&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token function">_f</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> marshal<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>使用</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> mockHello <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> dispose <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">marshal</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">&quot;liuli&quot;</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  sex<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  hobby<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  account<span class="token operator">:</span> <span class="token punctuation">{</span>
    username<span class="token operator">:</span> <span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  hello<span class="token operator">:</span> mockHello<span class="token punctuation">,</span>
  map<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  date<span class="token operator">:</span> now<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
vm<span class="token punctuation">.</span><span class="token function">setProp</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>global<span class="token punctuation">,</span> <span class="token string">&quot;vm_global&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">evalCode</span><span class="token punctuation">(</span>code<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">unwrapResult</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">evalCode</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">consume</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token string">&quot;vm_global.name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">&quot;liuli&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token string">&quot;vm_global.age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token string">&quot;vm_global.sex&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token string">&quot;vm_global.hobby&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token string">&quot;vm_global.date&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token string">&quot;vm_global.account.username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token string">&quot;vm_global.hello()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>mockHello<span class="token punctuation">.</span>mock<span class="token punctuation">.</span>calls<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token string">&quot;vm_global.map.size&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token string">&quot;vm_global.map.get(1)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>目前支持的类型与 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Structured_clone_algorithm" target="_blank" rel="noopener noreferrer">JavaScript 结构化克隆算法<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> 对比，后者在很多地方（iframe/web worker/worker_threads）均有使用</p><table><thead><tr><th>对象类型</th><th>quickjs</th><th>结构化克隆</th><th>注意</th></tr></thead><tbody><tr><td>所有的原始类型</td><td>✔️</td><td>❌</td><td>symbols 除外</td></tr><tr><td>Function</td><td>✔️</td><td>✔️</td><td></td></tr><tr><td>Array</td><td>✔️</td><td>✔️</td><td></td></tr><tr><td>Object</td><td>✔️</td><td>✔️</td><td>仅包括普通对象（如对象字面量）</td></tr><tr><td>Map</td><td>✔️</td><td>✔️</td><td></td></tr><tr><td>Set</td><td>✔️</td><td>✔️</td><td></td></tr><tr><td>Date</td><td>✔️</td><td>✔️</td><td></td></tr><tr><td>Error</td><td>❌</td><td>❌</td><td></td></tr><tr><td>Boolean</td><td>❌</td><td>✔️</td><td>对象</td></tr><tr><td>String</td><td>❌</td><td>✔️</td><td>对象</td></tr><tr><td>RegExp</td><td>❌</td><td>✔️</td><td>lastIndex 字段不会被保留。</td></tr><tr><td>Blob</td><td>❌</td><td>✔️</td><td></td></tr><tr><td>File</td><td>❌</td><td>✔️</td><td></td></tr><tr><td>FileList</td><td>❌</td><td>✔️</td><td></td></tr><tr><td>ArrayBuffer</td><td>❌</td><td>✔️</td><td></td></tr><tr><td>ArrayBufferView</td><td>❌</td><td>✔️</td><td>这基本上意味着所有的类型化数组</td></tr><tr><td>ImageData</td><td>❌</td><td>✔️</td><td></td></tr></tbody></table><blockquote><p>以上不支持的非常见类型并非 quickjs 不支持，仅仅是 marshal 暂未支持。</p></blockquote><h2 id="实现-console-settimeout-setinterval-等常见-api" tabindex="-1"><a class="header-anchor" href="#实现-console-settimeout-setinterval-等常见-api" aria-hidden="true">#</a> 实现 console/setTimeout/setInterval 等常见 api</h2><p>由于 console/setTimeout/setInterval 均不是 js 语言级别的 api（但是浏览器、nodejs 均实现了），所以吾辈必须手动实现并注入它们。</p><h3 id="实现-console" tabindex="-1"><a class="header-anchor" href="#实现-console" aria-hidden="true">#</a> 实现 console</h3><p>基本思路：为 vm 注入全局 console 对象，将参数 dump 之后转发到真正的 console api</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> QuickJSVm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;quickjs-emscripten&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> marshal <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../util/marshal&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">IVmConsole</span> <span class="token punctuation">{</span>
  <span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">info</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">warn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">error</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 定义 vm 中的 console api
 * <span class="token keyword">@param</span> <span class="token parameter">vm</span>
 * <span class="token keyword">@param</span> <span class="token parameter">logger</span>
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineConsole</span><span class="token punctuation">(</span>vm<span class="token operator">:</span> QuickJSVm<span class="token punctuation">,</span> logger<span class="token operator">:</span> IVmConsole<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;log&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;info&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;warn&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> dump <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> dispose <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">marshal</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">(</span>
    fields<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>dump<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">Function</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  vm<span class="token punctuation">.</span><span class="token function">setProp</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>global<span class="token punctuation">,</span> <span class="token string">&quot;console&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BasicVmConsole</span> <span class="token keyword">implements</span> <span class="token class-name">IVmConsole</span> <span class="token punctuation">{</span>
  <span class="token function">error</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">info</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">warn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>使用</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token function">defineConsole</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BasicVmConsole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="实现-settimeout" tabindex="-1"><a class="header-anchor" href="#实现-settimeout" aria-hidden="true">#</a> 实现 setTimeout</h3><p>基本思路</p><p><img src="/assets/f4568d723eb942838d7a068d46f721a1.153f9ace.svg" alt="基于 quickjs 实现 setTimeout 与 clearTimeout.drawio.svg"></p><ol><li>为 vm 注入全局 <code>setTimeout/clearTimeout</code> 函数</li><li>setTimeout <ol><li>将传过来的 <code>callbackFunc</code> 注册为 vm 全局变量</li><li>在系统层执行 <code>setTimeout</code></li><li>将 <code>clearTimeoutId =&gt; timeoutId</code> 写到 map，返回一个 <code>clearTimeoutId</code></li><li>执行刚刚注册的全局 vm 变量，并清除回调</li></ol></li><li>clearTimeout: 根据 <code>clearTimeoutId</code> 在系统层调用真实的 <code>clearTimeout</code></li></ol><blockquote><p>不直接返回 setTimeout 返回值的原因在于在 nodejs 中返回值是一个对象而非一个数字，所以需要使用 map 兼容</p></blockquote><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> QuickJSVm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;quickjs-emscripten&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> withScope <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../util/withScope&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> VmSetInterval <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./defineSetInterval&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> deleteKey <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../util/deleteKey&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CallbackIdGenerator <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@webos/ipc-main&quot;</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 注入 setTimeout 方法
 * 需要在注入后调用 <span class="token punctuation">{</span><span class="token keyword">@link</span> defineEventLoop<span class="token punctuation">}</span> 让 vm 的事件循环跑起来
 * <span class="token keyword">@param</span> <span class="token parameter">vm</span>
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineSetTimeout</span><span class="token punctuation">(</span>vm<span class="token operator">:</span> QuickJSVm<span class="token punctuation">)</span><span class="token operator">:</span> VmSetInterval <span class="token punctuation">{</span>
  <span class="token keyword">const</span> callbackMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">clear</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">withScope</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">deleteKey</span><span class="token punctuation">(</span>
        vm<span class="token punctuation">,</span>
        vm<span class="token punctuation">.</span><span class="token function">unwrapResult</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">VM_GLOBAL.setTimeoutCallback</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        id
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span>callbackMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    callbackMap<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">withScope</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vmGlobal <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">getProp</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>global<span class="token punctuation">,</span> <span class="token string">&quot;VM_GLOBAL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token function">of</span><span class="token punctuation">(</span>vmGlobal<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;VM_GLOBAL 不存在，需要先执行 defineVmGlobal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    vm<span class="token punctuation">.</span><span class="token function">setProp</span><span class="token punctuation">(</span>vmGlobal<span class="token punctuation">,</span> <span class="token string">&quot;setTimeoutCallback&quot;</span><span class="token punctuation">,</span> vm<span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vm<span class="token punctuation">.</span><span class="token function">setProp</span><span class="token punctuation">(</span>
      vm<span class="token punctuation">.</span>global<span class="token punctuation">,</span>
      <span class="token string">&quot;setTimeout&quot;</span><span class="token punctuation">,</span>
      vm<span class="token punctuation">.</span><span class="token function">newFunction</span><span class="token punctuation">(</span><span class="token string">&quot;setTimeout&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>callback<span class="token punctuation">,</span> ms<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> id <span class="token operator">=</span> CallbackIdGenerator<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//此处已经是异步了，必须再包一层</span>
        <span class="token function">withScope</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> callbacks <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">unwrapResult</span><span class="token punctuation">(</span>
            vm<span class="token punctuation">.</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token string">&quot;VM_GLOBAL.setTimeoutCallback&quot;</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          vm<span class="token punctuation">.</span><span class="token function">setProp</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">,</span> id<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//此处还是异步的，必须再包一层</span>
          <span class="token keyword">const</span> timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
              <span class="token function">withScope</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> callbacks <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">unwrapResult</span><span class="token punctuation">(</span>
                  vm<span class="token punctuation">.</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">VM_GLOBAL.setTimeoutCallback</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> callback <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">getProp</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                vm<span class="token punctuation">.</span><span class="token function">callFunction</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> vm<span class="token punctuation">.</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                callbackMap<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            vm<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          callbackMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">newString</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    vm<span class="token punctuation">.</span><span class="token function">setProp</span><span class="token punctuation">(</span>
      vm<span class="token punctuation">.</span>global<span class="token punctuation">,</span>
      <span class="token string">&quot;clearTimeout&quot;</span><span class="token punctuation">,</span>
      vm<span class="token punctuation">.</span><span class="token function">newFunction</span><span class="token punctuation">(</span><span class="token string">&quot;clearTimeout&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">clear</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    callbackMap<span class="token punctuation">,</span>
    <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">[</span><span class="token operator">...</span>callbackMap<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>clear<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><p>使用</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> vmSetTimeout <span class="token operator">=</span> <span class="token function">defineSetTimeout</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">withScope</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  vm<span class="token punctuation">.</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      const begin = Date.now()
      setInterval(() =&gt; {
        console.log(Date.now() - begin)
      }, 100)
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
vmSetTimeout<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="实现-setinterval" tabindex="-1"><a class="header-anchor" href="#实现-setinterval" aria-hidden="true">#</a> 实现 setInterval</h3><p>基本上，与实现 setTimeout 流程差不多</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> QuickJSVm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;quickjs-emscripten&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> withScope <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../util/withScope&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> deleteKey <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../util/deleteKey&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CallbackIdGenerator <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@webos/ipc-main&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">VmSetInterval</span> <span class="token punctuation">{</span>
  callbackMap<span class="token operator">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 注入 setInterval 方法
 * 需要在注入后调用 <span class="token punctuation">{</span><span class="token keyword">@link</span> defineEventLoop<span class="token punctuation">}</span> 让 vm 的事件循环跑起来
 * <span class="token keyword">@param</span> <span class="token parameter">vm</span>
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineSetInterval</span><span class="token punctuation">(</span>vm<span class="token operator">:</span> QuickJSVm<span class="token punctuation">)</span><span class="token operator">:</span> VmSetInterval <span class="token punctuation">{</span>
  <span class="token keyword">const</span> callbackMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">clear</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">withScope</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">deleteKey</span><span class="token punctuation">(</span>
        vm<span class="token punctuation">,</span>
        vm<span class="token punctuation">.</span><span class="token function">unwrapResult</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">VM_GLOBAL.setTimeoutCallback</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        id
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span>callbackMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    callbackMap<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">withScope</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vmGlobal <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">getProp</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>global<span class="token punctuation">,</span> <span class="token string">&quot;VM_GLOBAL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token function">of</span><span class="token punctuation">(</span>vmGlobal<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;VM_GLOBAL 不存在，需要先执行 defineVmGlobal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    vm<span class="token punctuation">.</span><span class="token function">setProp</span><span class="token punctuation">(</span>vmGlobal<span class="token punctuation">,</span> <span class="token string">&quot;setIntervalCallback&quot;</span><span class="token punctuation">,</span> vm<span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vm<span class="token punctuation">.</span><span class="token function">setProp</span><span class="token punctuation">(</span>
      vm<span class="token punctuation">.</span>global<span class="token punctuation">,</span>
      <span class="token string">&quot;setInterval&quot;</span><span class="token punctuation">,</span>
      vm<span class="token punctuation">.</span><span class="token function">newFunction</span><span class="token punctuation">(</span><span class="token string">&quot;setInterval&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>callback<span class="token punctuation">,</span> ms<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> id <span class="token operator">=</span> CallbackIdGenerator<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//此处已经是异步了，必须再包一层</span>
        <span class="token function">withScope</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> callbacks <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">unwrapResult</span><span class="token punctuation">(</span>
            vm<span class="token punctuation">.</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token string">&quot;VM_GLOBAL.setIntervalCallback&quot;</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          vm<span class="token punctuation">.</span><span class="token function">setProp</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">,</span> id<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> interval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">withScope</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              vm<span class="token punctuation">.</span><span class="token function">callFunction</span><span class="token punctuation">(</span>
                vm<span class="token punctuation">.</span><span class="token function">unwrapResult</span><span class="token punctuation">(</span>
                  vm<span class="token punctuation">.</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">VM_GLOBAL.setIntervalCallback[&#39;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&#39;]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
                vm<span class="token punctuation">.</span>null
              <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> vm<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          callbackMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">newString</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    vm<span class="token punctuation">.</span><span class="token function">setProp</span><span class="token punctuation">(</span>
      vm<span class="token punctuation">.</span>global<span class="token punctuation">,</span>
      <span class="token string">&quot;clearInterval&quot;</span><span class="token punctuation">,</span>
      vm<span class="token punctuation">.</span><span class="token function">newFunction</span><span class="token punctuation">(</span><span class="token string">&quot;clearInterval&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">clear</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    callbackMap<span class="token punctuation">,</span>
    <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">[</span><span class="token operator">...</span>callbackMap<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>clear<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><h3 id="实现事件循环" tabindex="-1"><a class="header-anchor" href="#实现事件循环" aria-hidden="true">#</a> 实现事件循环</h3><p>但有一点麻烦的是，quickjs-emscripten 不会自动执行事件循环，即 Promise 在 resolve 之后不会自动执行下一步。官方提供了 <code>executePendingJobs</code> 方法让我们手动执行事件循环，如下所示</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> log <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">defineMockConsole</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">withScope</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  vm<span class="token punctuation">.</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Promise.resolve().then(()=&gt;console.log(1))</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>mock<span class="token punctuation">.</span>calls<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
vm<span class="token punctuation">.</span><span class="token function">executePendingJobs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>mock<span class="token punctuation">.</span>calls<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>所以我们实现可以使用一个自动调用 <code>executePendingJobs</code> 的函数</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> QuickJSVm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;quickjs-emscripten&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">VmEventLoop</span> <span class="token punctuation">{</span>
  <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 定义 vm 中的事件循环机制，尝试循环执行等待的异步操作
 * <span class="token keyword">@param</span> <span class="token parameter">vm</span>
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineEventLoop</span><span class="token punctuation">(</span>vm<span class="token operator">:</span> QuickJSVm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> interval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span><span class="token function">executePendingJobs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">clearInterval</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>现在只要调用 defineEventLoop 即会循环执行 <code>executePendingJobs</code> 函数了</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> log <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">defineMockConsole</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> eventLoop <span class="token operator">=</span> <span class="token function">defineEventLoop</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token function">withScope</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Promise.resolve().then(()=&gt;console.log(1))</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>mock<span class="token punctuation">.</span>calls<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>mock<span class="token punctuation">.</span>calls<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
  eventLoop<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="实现沙箱与系统之间的通信" tabindex="-1"><a class="header-anchor" href="#实现沙箱与系统之间的通信" aria-hidden="true">#</a> 实现沙箱与系统之间的通信</h2><p>现在，我们沙箱还欠缺的就是通信机制了，下面我们便实现一个 <code>EventEmiiter</code>。</p><p>核心是让系统层和沙箱都实现 EventEmitter，quickjs 允许我们向沙箱中注入方法，所以我们可以注入一个 Map 和 <code>emitMain</code> 函数。让沙箱既能够向 Map 中注册事件以供系统层调用，也能通过 <code>emitMain</code> 向系统层发送事件。</p><p><img src="/assets/ff279700bc3646e68b53ba833dce9a5f.f3fd4baf.svg" alt="沙箱与系统之间的通信.drawio.svg"></p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> QuickJSHandle<span class="token punctuation">,</span> QuickJSVm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;quickjs-emscripten&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> marshal <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../util/marshal&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> withScope <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../util/withScope&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IEventEmitter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@webos/ipc-main&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">VmMessageChannel</span> <span class="token operator">=</span> IEventEmitter <span class="token operator">&amp;</span> <span class="token punctuation">{</span>
  listenerMap<span class="token operator">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 定义消息通信
 * <span class="token keyword">@param</span> <span class="token parameter">vm</span>
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineMessageChannel</span><span class="token punctuation">(</span>vm<span class="token operator">:</span> QuickJSVm<span class="token punctuation">)</span><span class="token operator">:</span> VmMessageChannel <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">withScope</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vmGlobal <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">getProp</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>global<span class="token punctuation">,</span> <span class="token string">&quot;VM_GLOBAL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token function">of</span><span class="token punctuation">(</span>vmGlobal<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;VM_GLOBAL 不存在，需要先执行 defineVmGlobal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> listenerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span></span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> messagePort <span class="token operator">=</span> <span class="token function">marshal</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">//region vm 进程回调函数定义</span>
      listenerMap<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">//给 vm 进程用的</span>
      <span class="token function">emitMain</span><span class="token punctuation">(</span>channel<span class="token operator">:</span> QuickJSHandle<span class="token punctuation">,</span> msg<span class="token operator">:</span> QuickJSHandle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> key <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>listenerMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;主进程没有监听 api: &quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        listenerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">fn</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;执行回调函数发生错误: &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">//endregion</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vm<span class="token punctuation">.</span><span class="token function">setProp</span><span class="token punctuation">(</span>vmGlobal<span class="token punctuation">,</span> <span class="token string">&quot;MessagePort&quot;</span><span class="token punctuation">,</span> messagePort<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//给主进程用的</span>
    <span class="token keyword">function</span> <span class="token function">emitVM</span><span class="token punctuation">(</span>channel<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> msg<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">withScope</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> _map <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">unwrapResult</span><span class="token punctuation">(</span>
          vm<span class="token punctuation">.</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token string">&quot;VM_GLOBAL.MessagePort.listenerMap&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> _get <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">getProp</span><span class="token punctuation">(</span>_map<span class="token punctuation">,</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> _array <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">unwrapResult</span><span class="token punctuation">(</span>
          vm<span class="token punctuation">.</span><span class="token function">callFunction</span><span class="token punctuation">(</span>_get<span class="token punctuation">,</span> _map<span class="token punctuation">,</span> vm<span class="token punctuation">.</span><span class="token function">newString</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vm<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>_array<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>
          <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">getProp</span><span class="token punctuation">(</span>_array<span class="token punctuation">,</span> <span class="token string">&quot;length&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span>
          i<span class="token operator">++</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          vm<span class="token punctuation">.</span><span class="token function">callFunction</span><span class="token punctuation">(</span>
            vm<span class="token punctuation">.</span><span class="token function">getProp</span><span class="token punctuation">(</span>_array<span class="token punctuation">,</span> vm<span class="token punctuation">.</span><span class="token function">newNumber</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            vm<span class="token punctuation">.</span>null<span class="token punctuation">,</span>
            <span class="token function">marshal</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">.</span>value
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      emit<span class="token operator">:</span> emitVM<span class="token punctuation">,</span>
      <span class="token function">offByChannel</span><span class="token punctuation">(</span>channel<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
        listenerMap<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">on</span><span class="token punctuation">(</span>channel<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token function-variable function">handle</span><span class="token operator">:</span> <span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>listenerMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          listenerMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        listenerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      listenerMap<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token keyword">as</span> VmMessageChannel<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div><blockquote><p>可以看到，我们除了实现了 IEventEmitter，还额外添加了字段 listenerMap，这主要是希望向上层暴露更多细节，便于在需要的时候（例如清理全部注册的事件）可以直接实现。</p></blockquote><p>使用</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token function">defineVmGlobal</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> messageChannel <span class="token operator">=</span> <span class="token function">defineMessageChannel</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mockFn <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
messageChannel<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> mockFn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">withScope</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  vm<span class="token punctuation">.</span><span class="token function">evalCode</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
class QuickJSEventEmitter {
    emit(channel, data) {
        VM_GLOBAL.MessagePort.emitMain(channel, data);
    }
    on(channel, handle) {
        if (!VM_GLOBAL.MessagePort.listenerMap.has(channel)) {
            VM_GLOBAL.MessagePort.listenerMap.set(channel, []);
        }
        VM_GLOBAL.MessagePort.listenerMap.get(channel).push(handle);
    }
    offByChannel(channel) {
        VM_GLOBAL.MessagePort.listenerMap.delete(channel);
    }
}

const em = new QuickJSEventEmitter()
em.emit(&#39;hello&#39;, &#39;liuli&#39;)
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>mockFn<span class="token punctuation">.</span>mock<span class="token punctuation">.</span>calls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">&quot;liuli&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
messageChannel<span class="token punctuation">.</span>listenerMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h2 id="实现-ijavascriptshadowbox" tabindex="-1"><a class="header-anchor" href="#实现-ijavascriptshadowbox" aria-hidden="true">#</a> 实现 IJavaScriptShadowbox</h2><p>最终，我们以上实现的功能集合起来，便实现了 <code>IJavaScriptShadowbox</code></p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> IJavaScriptShadowbox <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./IJavaScriptShadowbox&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getQuickJS<span class="token punctuation">,</span> QuickJS<span class="token punctuation">,</span> QuickJSVm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;quickjs-emscripten&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  BasicVmConsole<span class="token punctuation">,</span>
  defineConsole<span class="token punctuation">,</span>
  defineEventLoop<span class="token punctuation">,</span>
  defineMessageChannel<span class="token punctuation">,</span>
  defineSetInterval<span class="token punctuation">,</span>
  defineSetTimeout<span class="token punctuation">,</span>
  defineVmGlobal<span class="token punctuation">,</span>
  VmEventLoop<span class="token punctuation">,</span>
  VmMessageChannel<span class="token punctuation">,</span>
  VmSetInterval<span class="token punctuation">,</span>
  withScope<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@webos/quickjs-emscripten-utils&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">QuickJSShadowbox</span> <span class="token keyword">implements</span> <span class="token class-name">IJavaScriptShadowbox</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> vmMessageChannel<span class="token operator">:</span> VmMessageChannel<span class="token punctuation">;</span>
  <span class="token keyword">private</span> vmEventLoop<span class="token operator">:</span> VmEventLoop<span class="token punctuation">;</span>
  <span class="token keyword">private</span> vmSetInterval<span class="token operator">:</span> VmSetInterval<span class="token punctuation">;</span>
  <span class="token keyword">private</span> vmSetTimeout<span class="token operator">:</span> VmSetInterval<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">readonly</span> vm<span class="token operator">:</span> QuickJSVm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">defineConsole</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BasicVmConsole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">defineVmGlobal</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vmSetTimeout <span class="token operator">=</span> <span class="token function">defineSetTimeout</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vmSetInterval <span class="token operator">=</span> <span class="token function">defineSetInterval</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vmEventLoop <span class="token operator">=</span> <span class="token function">defineEventLoop</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vmMessageChannel <span class="token operator">=</span> <span class="token function">defineMessageChannel</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vmMessageChannel<span class="token punctuation">.</span>listenerMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vmEventLoop<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vmSetInterval<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vmSetTimeout<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">eval</span><span class="token punctuation">(</span>code<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token function">withScope</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span><span class="token function">unwrapResult</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">evalCode</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">emit</span><span class="token punctuation">(</span>channel<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> data<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vmMessageChannel<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">on</span><span class="token punctuation">(</span>channel<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token function-variable function">handle</span><span class="token operator">:</span> <span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vmMessageChannel<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">offByChannel</span><span class="token punctuation">(</span>channel<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vmMessageChannel<span class="token punctuation">.</span><span class="token function">offByChannel</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> quickJS<span class="token operator">:</span> QuickJS<span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>QuickJSShadowbox<span class="token punctuation">.</span>quickJS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      QuickJSShadowbox<span class="token punctuation">.</span>quickJS <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getQuickJS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">QuickJSShadowbox</span><span class="token punctuation">(</span>QuickJSShadowbox<span class="token punctuation">.</span>quickJS<span class="token punctuation">.</span><span class="token function">createVm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    QuickJSShadowbox<span class="token punctuation">.</span>quickJS <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>在系统层使用</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> shadowbox <span class="token operator">=</span> <span class="token keyword">await</span> QuickJSShadowbox<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mockConsole <span class="token operator">=</span> <span class="token function">defineMockConsole</span><span class="token punctuation">(</span>shadowbox<span class="token punctuation">.</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
shadowbox<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
shadowbox<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>AppChannelEnum<span class="token punctuation">.</span>Open<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>mockConsole<span class="token punctuation">.</span>log<span class="token punctuation">.</span>mock<span class="token punctuation">.</span>calls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
shadowbox<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>WindowChannelEnum<span class="token punctuation">.</span>AllClose<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>mockConsole<span class="token punctuation">.</span>log<span class="token punctuation">.</span>mock<span class="token punctuation">.</span>calls<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">&quot;all close&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
shadowbox<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在沙箱使用</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> eventEmitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuickJSEventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
eventEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>AppChannelEnum<span class="token punctuation">.</span>Open<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
eventEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>WindowChannelEnum<span class="token punctuation">.</span>AllClose<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;all close&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="目前-quickjs-沙箱的限制" tabindex="-1"><a class="header-anchor" href="#目前-quickjs-沙箱的限制" aria-hidden="true">#</a> 目前 quickjs 沙箱的限制</h2><p>下面是目前实现的一些限制，也是以后可以继续改进的点</p><ul><li><code>console</code> 仅支持常见的 <code>log/info/warn/error</code> 方法</li><li><code>setTimeout/setInterval</code> 事件循环时间没有保证，目前大约在 100ms 调用一次</li><li>无法使用 chrome devtool 调试，也不会处理 sourcemap（figma 至今的开发体验仍然如此，后面可能添加开关支持在 web worker 中调试）</li><li>vm 中出现错误不会将错误抛出来并打印在控制台</li><li>各个 api 调用的顺序与清理顺序必须手动保证是相反的，例如 vm 创建必须在 <code>defineSetTimeout</code> 之前，而 <code>defineSetTimeout</code> 的清理函数调用必须在 <code>vm.dispose</code> 之前</li><li>不能在 <code>messageChannel.on</code> 回调中同步调用 <code>vm.dispose</code>，因为是同步调用的</li></ul><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"> ← <a href="/p/bafce41b0e6840908c5b5452c0fca1db.html" class="nav-link" aria-label="JavaScript 沙箱探索"><!--[--><!--]--> JavaScript 沙箱探索 <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.969c9eca.js" defer></script>
  </body>
</html>
