import{r as n,o as a,c as s,a as e,F as l,b as o,d as r}from"./app.9afc683c.js";const t={},c=e("h2",{id:"动机",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#动机","aria-hidden":"true"},"#"),o(" 动机")],-1),p=e("li",null,"不再同时使用两个 monorepo 管理工具，或者说将 monorepo 整合到 yarn 里（新的依赖管理工具 npm7/pnpm/rush 都是这样干的），专注于对增强 yarn（yarn.build 是一个不错的例子）",-1),u=e("li",null,"使用 yarn2 逐渐发展的生态（yarn1 基本没什么更新了）",-1),i=o("lerna 的高级功能不太好用，主要是 "),k=e("code",null,"lerna run",-1),d=o(" 不支持缓存导致每次重新构建会很烦 -- 考虑使用 ultra 支持，但 yarn2 似乎有参见可以支持，参考: "),b={href:"https://github.com/yarnpkg/berry/issues/2374",target:"_blank",rel:"noopener noreferrer"},h=o("https://github.com/yarnpkg/berry/issues/2374"),y=o("yarn2 不需要使用 "),g=e("code",null,"lerna clean -y && lerna bootstrap",-1),m=o(" 来将动态构建的 cli 写入到 "),f=e("code",null,"node_modules/.bin",-1),x=o("，它查找 "),w=e("code",null,"cli",-1),j=o(" 的方式发生了变化（完全动态化），参考 "),v={href:"https://yarnpkg.com/getting-started/migration#call-binaries-using-yarn-run-rather-than-node_modulesbin",target:"_blank",rel:"noopener noreferrer"},_=o("https://yarnpkg.com/getting-started/migration#call-binaries-using-yarn-run-rather-than-node_modulesbin"),C=e("ul",null,[e("li",null,[o("该优化大约能将每个 cli 的构建时间从 40s 降低至 10s 内，之前大部分时间都是写入 "),e("code",null,"node_modules/.bin")])],-1),U=e("h2",{id:"如何使用类似于-lerna-run-exec-之类的命令",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#如何使用类似于-lerna-run-exec-之类的命令","aria-hidden":"true"},"#"),o(" 如何使用类似于 lerna run/exec 之类的命令")],-1),P=e("ol",null,[e("li",null,[o("使用 workspaces 插件 "),e("code",null,"yarn plugin import @yarnpkg/plugin-workspace-tools")]),e("li",null,[o("使用 "),e("code",null,"yarn workspaces foreach"),o(" 在所有模块执行命令")])],-1),q=e("p",null,"下面是在所有模块中按照依赖顺序尽可能地并行构建包",-1),L=e("div",{class:"language-bash ext-sh line-numbers-mode"},[e("pre",{class:"language-bash"},[e("code",null,[e("span",{class:"token function"},"yarn"),o(" workspaces foreach -p --topological-dev run build\n"),e("span",{class:"token comment"},"# 或删除所有 dist"),o("\n"),e("span",{class:"token function"},"yarn"),o(" workspaces foreach -p "),e("span",{class:"token builtin class-name"},"exec"),o(" rimraf dist\n"),e("span",{class:"token comment"},"# 如果希望删除 node_modules，则需要使用 yarn dlx"),o("\n"),e("span",{class:"token function"},"yarn"),o(" workspaces foreach -p "),e("span",{class:"token builtin class-name"},"exec"),o(),e("span",{class:"token function"},"yarn"),o(" dlx rimraf node_modules\n")])]),e("div",{class:"line-numbers"},[e("span",{class:"line-number"},"1"),e("br"),e("span",{class:"line-number"},"2"),e("br"),e("span",{class:"line-number"},"3"),e("br"),e("span",{class:"line-number"},"4"),e("br"),e("span",{class:"line-number"},"5"),e("br")])],-1),D=e("h2",{id:"如何像-lerna-publish-那样为所有模块全部升级",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#如何像-lerna-publish-那样为所有模块全部升级","aria-hidden":"true"},"#"),o(" 如何像 lerna publish 那样为所有模块全部升级？")],-1),E=e("p",null,[o("升级全部模块目前可以使用 "),e("code",null,"yarn workspaces foreach"),o(" 模拟 "),e("code",null,"lerna publish"),o("，但对于独立模式则是另外一套完全不同的模式了。")],-1),F=e("div",{class:"language-bash ext-sh line-numbers-mode"},[e("pre",{class:"language-bash"},[e("code",null,[e("span",{class:"token function"},"yarn"),o(" workspaces foreach "),e("span",{class:"token builtin class-name"},"exec"),o(),e("span",{class:"token function"},"yarn"),o(" version patch\n")])]),e("div",{class:"line-numbers"},[e("span",{class:"line-number"},"1"),e("br")])],-1),A=e("p",null,"缺点是无法按照是否修改决定是否发布新版本。。。",-1),M=e("p",null,"发布所有包",-1),N=e("blockquote",null,[e("p",null,[e("code",null,"yarn npm publish"),o(" 仍有 bug，所以只能直接 "),e("code",null,"npm publish"),o(" 了")])],-1),R=e("div",{class:"language-bash ext-sh line-numbers-mode"},[e("pre",{class:"language-bash"},[e("code",null,[e("span",{class:"token function"},"yarn"),o(" workspaces foreach -A --no-private "),e("span",{class:"token builtin class-name"},"exec"),o(),e("span",{class:"token function"},"npm"),o(" publish\n")])]),e("div",{class:"line-numbers"},[e("span",{class:"line-number"},"1"),e("br")])],-1),T=e("blockquote",null,[e("p",null,"感觉还是需要实现缓存的功能，只是将缓存文件加到 git 而已。考虑到不是所有命令都需要，也许可以使用缓存目录。")],-1),B=e("h2",{id:"如果包含-cli-子模块怎么办",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#如果包含-cli-子模块怎么办","aria-hidden":"true"},"#"),o(" 如果包含 cli 子模块怎么办？")],-1),G=e("p",null,[o("打包完成之后 "),e("code",null,"yarn"),o(" 安装即可，yarn 会负责将命令写入到依赖的其他子模块的 "),e("em",null,"node_modules/.bin/"),o(" 中。")],-1),O=e("h2",{id:"编写插件",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#编写插件","aria-hidden":"true"},"#"),o(" 编写插件")],-1),S={href:"https://yarnpkg.com/advanced/plugin-tutorial",target:"_blank",rel:"noopener noreferrer"},W=o("插件教程文档"),Y=e("p",null,[e("img",{src:"/assets/cf84da80c9d143cdb4163cc7a1d34fb4.0c729548.svg",alt:"monorepo 构建.drawio.svg"})],-1),Z=e("h2",{id:"问题",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#问题","aria-hidden":"true"},"#"),o(" 问题")],-1),I=r("<li>不能使用 lerna 那种拼接脚本的方式，即将 <code>lerna run --include-dependencies --stream</code> 放在 <code>stream</code> 脚本，然后使用 <code>yarn stream &lt;cmd&gt;</code> 拼接命令的形式。</li><li>不确定 yarn 是否包含 <code>lerna publish</code> 那种自动检测和批量发布的命令 -- 支持不太好用</li><li>不确定 yarn 是否有类似于 <code>rush/nx</code> 的构建缓存功能 -- 没有原生支持，两个插件也都有各自的问题</li><li>概念太多实在太麻烦了，各种奇怪的问题 <ul><li><code>yarn npm publish</code> 会说权限错误，但实际上 <code>yarn npm login</code> 已经成功了，文档上说可以配置 <code>npmAuthToken</code>，但这是不合理的（将 token 加到 git 管理中）</li><li><code>yarn workspaces foreach exec yarn jest --all</code> 会报一个错误</li></ul></li>",4),$=o("对于 yarn2 pnp，目前 webstorm 仍然只有非常基本的支持，包括 prettier/jest 都存在问题，参考："),z={href:"https://youtrack.jetbrains.com/issue/WEB-35034",target:"_blank",rel:"noopener noreferrer"},H=o("https://youtrack.jetbrains.com/issue/WEB-35034"),J=o("yarn 2 的社区接受度似乎极低，github 上依赖它的库不超过 100 个，参考："),K={href:"https://github.com/yarnpkg/berry/network/dependents?package_id=UGFja2FnZS03MDE5NDg3MjU%3D",target:"_blank",rel:"noopener noreferrer"},Q=o("https://github.com/yarnpkg/berry/network/dependents?package_id=UGFja2FnZS03MDE5NDg3MjU%3D"),V=o(" -- 实际上这是错的，由于 yarn2 不在 package.json 中声明而已，目前 storybook 等流行库也升级了 yarn2，但它们也混用 lerna 和 nx。。。"),X=e("li",null,[o("无法使用 "),e("code",null,"patch-package"),o("，但可以使用 "),e("code",null,"yarn patch"),o(" 命令。。。")],-1),nn=e("h2",{id:"其他优点",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#其他优点","aria-hidden":"true"},"#"),o(" 其他优点")],-1),an=e("ul",null,[e("li",null,"原生支持 workspaces"),e("li",null,"有插件 api，可以为自定义需求编写插件"),e("li",null,[o("cli 命令执行不再强绑定到 "),e("em",null,"node_modules/.bin")]),e("li",null,[o("重新安装依赖时时不需要停止 "),e("code",null,"vite dev"),o("（目前无法安装成功）")])],-1),sn=e("h2",{id:"编写插件之后应该怎么在本地测试",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#编写插件之后应该怎么在本地测试","aria-hidden":"true"},"#"),o(" 编写插件之后应该怎么在本地测试？")],-1),en=e("ol",null,[e("li",null,[e("p",null,"单元测试"),e("div",{class:"language-typescript ext-ts line-numbers-mode"},[e("pre",{class:"language-typescript"},[e("code",null,[e("span",{class:"token keyword"},"const"),o(" dir "),e("span",{class:"token operator"},"="),o(" npath"),e("span",{class:"token punctuation"},"."),e("span",{class:"token function"},"toPortablePath"),e("span",{class:"token punctuation"},"("),o("path"),e("span",{class:"token punctuation"},"."),e("span",{class:"token function"},"resolve"),e("span",{class:"token punctuation"},"("),e("span",{class:"token string"},'""'),e("span",{class:"token punctuation"},")"),e("span",{class:"token punctuation"},")"),e("span",{class:"token punctuation"},";"),o("\n"),e("span",{class:"token keyword"},"const"),o(" configuration "),e("span",{class:"token operator"},"="),o(),e("span",{class:"token keyword"},"await"),o(" Configuration"),e("span",{class:"token punctuation"},"."),e("span",{class:"token function"},"create"),e("span",{class:"token punctuation"},"("),o("dir"),e("span",{class:"token punctuation"},","),o(" dir"),e("span",{class:"token punctuation"},")"),e("span",{class:"token punctuation"},";"),o("\n"),e("span",{class:"token keyword"},"const"),o(" project "),e("span",{class:"token operator"},"="),o(),e("span",{class:"token punctuation"},"("),e("span",{class:"token keyword"},"await"),o(" Project"),e("span",{class:"token punctuation"},"."),e("span",{class:"token function"},"find"),e("span",{class:"token punctuation"},"("),o("configuration"),e("span",{class:"token punctuation"},","),o(" dir"),e("span",{class:"token punctuation"},")"),e("span",{class:"token punctuation"},")"),e("span",{class:"token punctuation"},"."),o("project"),e("span",{class:"token punctuation"},";"),o("\n")])]),e("div",{class:"line-numbers"},[e("span",{class:"line-number"},"1"),e("br"),e("span",{class:"line-number"},"2"),e("br"),e("span",{class:"line-number"},"3"),e("br")])])]),e("li",null,[e("p",null,[e("code",null,"yarn plugin import <>")])])],-1),ln=e("h2",{id:"yarn-workspace-有办法包含一个不在-workspace-管理的子目录么",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#yarn-workspace-有办法包含一个不在-workspace-管理的子目录么","aria-hidden":"true"},"#"),o(" yarn workspace 有办法包含一个不在 workspace 管理的子目录么？")],-1),on=e("p",null,"例如项目可能有一个 website 目录用以存放网站的文档，而又不希望将之放到 yarn workspace 管理（有可能是不同的技术栈，例如 vuepress）。",-1),rn=e("p",null,[o("在 "),e("code",null,"workspace"),o(" 字段中排除，然后在目录中添加空的 "),e("code",null,"yarn.lock"),o(" 文件")],-1),tn=e("h2",{id:"npmrc-yarnrc-yml",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#npmrc-yarnrc-yml","aria-hidden":"true"},"#"),o(" npmrc => yarnrc.yml")],-1),cn=e("h2",{id:"yarn2-在-monorepo-中根模块无法直接-import-子模块的-yarn-插件",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#yarn2-在-monorepo-中根模块无法直接-import-子模块的-yarn-插件","aria-hidden":"true"},"#"),o(" yarn2 在 monorepo 中根模块无法直接 import 子模块的 yarn 插件")],-1),pn={href:"https://github.com/rxliuli/liuli-tools",target:"_blank",rel:"noopener noreferrer"},un=o("复现仓库"),kn=e("p",null,"复现步骤",-1),dn=e("ol",null,[e("li",null,[e("code",null,"yarn && yarn setup"),o(" 安装依赖及初始化")]),e("li",null,[e("code",null,"cd libs/yarn-plugin-changed && yarn build"),o(" 打包插件")]),e("li",null,[e("code",null,"cd ../.. && yarn plugin import libs/yarn-plugin-changed/bundles/\\@yarnpkg/plugin-changed.js"),o(" 回到根目录安装插件")]),e("li",null,"得到错误")],-1),bn=e("div",{class:"language-javascript ext-js line-numbers-mode"},[e("pre",{class:"language-javascript"},[e("code",null,[o("$ yarn plugin "),e("span",{class:"token keyword"},"import"),o(" libs"),e("span",{class:"token operator"},"/"),o("yarn"),e("span",{class:"token operator"},"-"),o("plugin"),e("span",{class:"token operator"},"-"),o("changed"),e("span",{class:"token operator"},"/"),o("bundles"),e("span",{class:"token operator"},"/"),o("\\@yarnpkg"),e("span",{class:"token operator"},"/"),o("plugin"),e("span",{class:"token operator"},"-"),o("changed"),e("span",{class:"token punctuation"},"."),o("js\n➤ "),e("span",{class:"token constant"},"YN0001"),e("span",{class:"token operator"},":"),o(" Error"),e("span",{class:"token operator"},":"),o(" Invalid "),e("span",{class:"token function"},"locator"),o(),e("span",{class:"token punctuation"},"("),o("@yarnpkg"),e("span",{class:"token operator"},"/"),o("plugin"),e("span",{class:"token operator"},"-"),o("libs"),e("span",{class:"token operator"},"/"),o("yarn"),e("span",{class:"token operator"},"-"),o("plugin"),e("span",{class:"token operator"},"-"),o("changed"),e("span",{class:"token operator"},"/"),o("bundles"),e("span",{class:"token operator"},"/"),o("@yarnpkg"),e("span",{class:"token operator"},"/"),o("plugin"),e("span",{class:"token operator"},"-"),o("changed"),e("span",{class:"token punctuation"},"."),o("js"),e("span",{class:"token punctuation"},")"),o("\n    at Object"),e("span",{class:"token punctuation"},"."),e("span",{class:"token function"},"hA"),o(),e("span",{class:"token punctuation"},"("),e("span",{class:"token constant"},"C"),e("span",{class:"token operator"},":"),o("\\Users\\rxliuli\\Code\\Pkg\\liuli"),e("span",{class:"token operator"},"-"),o("tools\\"),e("span",{class:"token punctuation"},"."),o("yarn\\releases\\yarn"),e("span",{class:"token operator"},"-"),o("berry"),e("span",{class:"token punctuation"},"."),o("cjs"),e("span",{class:"token operator"},":"),e("span",{class:"token number"},"242"),e("span",{class:"token operator"},":"),e("span",{class:"token number"},"12395"),e("span",{class:"token punctuation"},")"),o("\n    at "),e("span",{class:"token constant"},"C"),e("span",{class:"token operator"},":"),o("\\Users\\rxliuli\\Code\\Pkg\\liuli"),e("span",{class:"token operator"},"-"),o("tools\\"),e("span",{class:"token punctuation"},"."),o("yarn\\releases\\yarn"),e("span",{class:"token operator"},"-"),o("berry"),e("span",{class:"token punctuation"},"."),o("cjs"),e("span",{class:"token operator"},":"),e("span",{class:"token number"},"387"),e("span",{class:"token operator"},":"),e("span",{class:"token number"},"1702"),o("\n    at "),e("span",{class:"token keyword"},"async"),o(" Function"),e("span",{class:"token punctuation"},"."),e("span",{class:"token function"},"start"),o(),e("span",{class:"token punctuation"},"("),e("span",{class:"token constant"},"C"),e("span",{class:"token operator"},":"),o("\\Users\\rxliuli\\Code\\Pkg\\liuli"),e("span",{class:"token operator"},"-"),o("tools\\"),e("span",{class:"token punctuation"},"."),o("yarn\\releases\\yarn"),e("span",{class:"token operator"},"-"),o("berry"),e("span",{class:"token punctuation"},"."),o("cjs"),e("span",{class:"token operator"},":"),e("span",{class:"token number"},"275"),e("span",{class:"token operator"},":"),e("span",{class:"token number"},"2287"),e("span",{class:"token punctuation"},")"),o("\n    at "),e("span",{class:"token keyword"},"async"),o(" Rp"),e("span",{class:"token punctuation"},"."),e("span",{class:"token function"},"execute"),o(),e("span",{class:"token punctuation"},"("),e("span",{class:"token constant"},"C"),e("span",{class:"token operator"},":"),o("\\Users\\rxliuli\\Code\\Pkg\\liuli"),e("span",{class:"token operator"},"-"),o("tools\\"),e("span",{class:"token punctuation"},"."),o("yarn\\releases\\yarn"),e("span",{class:"token operator"},"-"),o("berry"),e("span",{class:"token punctuation"},"."),o("cjs"),e("span",{class:"token operator"},":"),e("span",{class:"token number"},"387"),e("span",{class:"token operator"},":"),e("span",{class:"token number"},"1110"),e("span",{class:"token punctuation"},")"),o("\n    at "),e("span",{class:"token keyword"},"async"),o(" Rp"),e("span",{class:"token punctuation"},"."),e("span",{class:"token function"},"validateAndExecute"),o(),e("span",{class:"token punctuation"},"("),e("span",{class:"token constant"},"C"),e("span",{class:"token operator"},":"),o("\\Users\\rxliuli\\Code\\Pkg\\liuli"),e("span",{class:"token operator"},"-"),o("tools\\"),e("span",{class:"token punctuation"},"."),o("yarn\\releases\\yarn"),e("span",{class:"token operator"},"-"),o("berry"),e("span",{class:"token punctuation"},"."),o("cjs"),e("span",{class:"token operator"},":"),e("span",{class:"token number"},"197"),e("span",{class:"token operator"},":"),e("span",{class:"token number"},"620"),e("span",{class:"token punctuation"},")"),o("\n    at "),e("span",{class:"token keyword"},"async"),o(" ts"),e("span",{class:"token punctuation"},"."),e("span",{class:"token function"},"run"),o(),e("span",{class:"token punctuation"},"("),e("span",{class:"token constant"},"C"),e("span",{class:"token operator"},":"),o("\\Users\\rxliuli\\Code\\Pkg\\liuli"),e("span",{class:"token operator"},"-"),o("tools\\"),e("span",{class:"token punctuation"},"."),o("yarn\\releases\\yarn"),e("span",{class:"token operator"},"-"),o("berry"),e("span",{class:"token punctuation"},"."),o("cjs"),e("span",{class:"token operator"},":"),e("span",{class:"token number"},"211"),e("span",{class:"token operator"},":"),e("span",{class:"token number"},"1846"),e("span",{class:"token punctuation"},")"),o("\n    at "),e("span",{class:"token keyword"},"async"),o(" ts"),e("span",{class:"token punctuation"},"."),e("span",{class:"token function"},"runExit"),o(),e("span",{class:"token punctuation"},"("),e("span",{class:"token constant"},"C"),e("span",{class:"token operator"},":"),o("\\Users\\rxliuli\\Code\\Pkg\\liuli"),e("span",{class:"token operator"},"-"),o("tools\\"),e("span",{class:"token punctuation"},"."),o("yarn\\releases\\yarn"),e("span",{class:"token operator"},"-"),o("berry"),e("span",{class:"token punctuation"},"."),o("cjs"),e("span",{class:"token operator"},":"),e("span",{class:"token number"},"211"),e("span",{class:"token operator"},":"),e("span",{class:"token number"},"2013"),e("span",{class:"token punctuation"},")"),o("\n    at "),e("span",{class:"token keyword"},"async"),o(),e("span",{class:"token function"},"i"),o(),e("span",{class:"token punctuation"},"("),e("span",{class:"token constant"},"C"),e("span",{class:"token operator"},":"),o("\\Users\\rxliuli\\Code\\Pkg\\liuli"),e("span",{class:"token operator"},"-"),o("tools\\"),e("span",{class:"token punctuation"},"."),o("yarn\\releases\\yarn"),e("span",{class:"token operator"},"-"),o("berry"),e("span",{class:"token punctuation"},"."),o("cjs"),e("span",{class:"token operator"},":"),e("span",{class:"token number"},"310"),e("span",{class:"token operator"},":"),e("span",{class:"token number"},"12327"),e("span",{class:"token punctuation"},")"),o("\n    at "),e("span",{class:"token keyword"},"async"),o(),e("span",{class:"token function"},"r"),o(),e("span",{class:"token punctuation"},"("),e("span",{class:"token constant"},"C"),e("span",{class:"token operator"},":"),o("\\Users\\rxliuli\\Code\\Pkg\\liuli"),e("span",{class:"token operator"},"-"),o("tools\\"),e("span",{class:"token punctuation"},"."),o("yarn\\releases\\yarn"),e("span",{class:"token operator"},"-"),o("berry"),e("span",{class:"token punctuation"},"."),o("cjs"),e("span",{class:"token operator"},":"),e("span",{class:"token number"},"310"),e("span",{class:"token operator"},":"),e("span",{class:"token number"},"10567"),e("span",{class:"token punctuation"},")"),o("\n➤ "),e("span",{class:"token constant"},"YN0000"),e("span",{class:"token operator"},":"),o(" Failed "),e("span",{class:"token keyword"},"with"),o(" errors "),e("span",{class:"token keyword"},"in"),o(),e("span",{class:"token number"},"0"),o("s "),e("span",{class:"token number"},"133"),o("ms\n")])]),e("div",{class:"line-numbers"},[e("span",{class:"line-number"},"1"),e("br"),e("span",{class:"line-number"},"2"),e("br"),e("span",{class:"line-number"},"3"),e("br"),e("span",{class:"line-number"},"4"),e("br"),e("span",{class:"line-number"},"5"),e("br"),e("span",{class:"line-number"},"6"),e("br"),e("span",{class:"line-number"},"7"),e("br"),e("span",{class:"line-number"},"8"),e("br"),e("span",{class:"line-number"},"9"),e("br"),e("span",{class:"line-number"},"10"),e("br"),e("span",{class:"line-number"},"11"),e("br"),e("span",{class:"line-number"},"12"),e("br")])],-1),hn=e("p",null,"答案",-1),yn=e("p",null,"必须使用 . 开头的相对路径",-1),gn={href:"https://github.com/yarnpkg/berry/issues/3331#issuecomment-903615924",target:"_blank",rel:"noopener noreferrer"},mn=o("github issue"),fn=e("h2",{id:"yarn-插件后在-bundles-yarnpkg-下而非我们的组织名下面",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#yarn-插件后在-bundles-yarnpkg-下而非我们的组织名下面","aria-hidden":"true"},"#"),o(" yarn 插件后在 bundles/@yarnpkg 下而非我们的组织名下面")],-1),xn=e("p",null,[o("同样是在编写 yarn 插件时遇到的错误，在我们使用 yarn plugin import 安装插件之后，才发现安装的目录是 "),e("em",null,".yarn/plugins/@yarnpkg/plugin-changed.cjs"),o("，这似乎有些不对，因为我们的项目名是 "),e("code",null,"@liuli-util/yarn-plugin-changed"),o("。还是我遗漏了什么配置？")],-1),wn=e("p",null,"复现步骤",-1),jn=e("p",null,"现有的包是怎么做的？",-1),vn={href:"https://github.com/ojkelly/yarn.build/blob/trunk/packages/plugins/plugin-build/package.json#L46-L47",target:"_blank",rel:"noopener noreferrer"},_n=o("yarn.build"),Cn=o(": 使用系统命令手动移动文件，同时替换打包之后的 name 字段"),Un=e("p",null,"答案",-1),Pn=e("p",null,"是 bundler 刻意的行为，无法直接改变。。。",-1),qn=e("h2",{id:"获取系统信息",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#获取系统信息","aria-hidden":"true"},"#"),o(" 获取系统信息")],-1),Ln=e("div",{class:"language-bash ext-sh line-numbers-mode"},[e("pre",{class:"language-bash"},[e("code",null,"npx envinfo --preset jest\n")]),e("div",{class:"line-numbers"},[e("span",{class:"line-number"},"1"),e("br")])],-1),Dn=e("h2",{id:"使用-yarn-patch-制作本地补丁包",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#使用-yarn-patch-制作本地补丁包","aria-hidden":"true"},"#"),o(" 使用 yarn patch 制作本地补丁包")],-1),En={href:"https://yarnpkg.com/cli/patch",target:"_blank",rel:"noopener noreferrer"},Fn=o("官方文档 yarn patch"),An=e("p",null,"动机",-1),Mn=e("p",null,[o("主要是处理一些 npm 模块可能存在小问题但又来不及提 PR 的情况下，在本地修改并生成 git patch 文件，在每次 "),e("code",null,"yarn install"),o(" 时合并这些 patch。")],-1),Nn=e("p",null,"使用步骤",-1),Rn=e("ol",null,[e("li",null,[o("使用 "),e("code",null,"yarn patch winbox"),o(" 生成临时目录")]),e("li",null,"修改目录中的文件"),e("li",null,[o("提交修改并生成 patch "),e("code",null,'yarn patch-commit "C:\\Users\\rxliuli\\AppData\\Local\\Temp\\xfs-f35b52d4\\user" -s'),o("，保存位置在 "),e("em",null,".yarn/patches/")]),e("li",null,[o("修改 package.json 使用 patch 协议 "),e("code",null,'{ "winbox": "patch:winbox@0.2.0#../../../.yarn/patches/winbox-npm-0.2.0-8ddb0784dd" }')]),e("li",null,[o("重新安装依赖 "),e("code",null,"yarn")])],-1),Tn=o("patch-package 目前无法在 yarn2 workspaces 下正常使用，参考："),Bn={href:"https://github.com/ds300/patch-package/issues/132",target:"_blank",rel:"noopener noreferrer"},Gn=o("https://github.com/ds300/patch-package/issues/132"),On=e("h2",{id:"yarn-pack-会忽略-gitignore",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#yarn-pack-会忽略-gitignore","aria-hidden":"true"},"#"),o(" yarn pack 会忽略 .gitignore")],-1),Sn=o("官方将之写死到代码里了，参考: "),Wn={href:"https://github.com/yarnpkg/berry/blob/7ae458b8165ad53a8ef9db0060cbb6de73305768/packages/plugin-pack/sources/packUtils.ts#L26-L39",target:"_blank",rel:"noopener noreferrer"},Yn=o("https://github.com/yarnpkg/berry/blob/7ae458b8165ad53a8ef9db0060cbb6de73305768/packages/plugin-pack/sources/packUtils.ts#L26-L39"),Zn=e("p",null,"是的，yarn pack 永远会忽略它，如果需要，可能需要将之打包到 js 代码里，然后在 postinstall 时写入文件（虽然会炸掉 yarn2 pnp 模式就是了）",-1),In=e("h2",{id:"运行初始化命令但卡死了",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#运行初始化命令但卡死了","aria-hidden":"true"},"#"),o(" 运行初始化命令但卡死了")],-1),$n=e("p",null,"可能会报下面这个错",-1),zn=e("div",{class:"language-bash ext-sh line-numbers-mode"},[e("pre",{class:"language-bash"},[e("code",null,[o("The "),e("span",{class:"token builtin class-name"},"command"),o(" failed "),e("span",{class:"token keyword"},"for"),o(" workspaces that are depended upon by other workspaces"),e("span",{class:"token punctuation"},";"),o(" can't satisfy the dependency graph\n")])]),e("div",{class:"line-numbers"},[e("span",{class:"line-number"},"1"),e("br")])],-1),Hn=e("p",null,[o("检查运行的命令中是否包含递归调用，即在 "),e("code",null,"setup"),o(" 命令中调用了 "),e("code",null,"setup"),o(" 命令")],-1),Jn=e("blockquote",null,[e("p",null,"需要开发类似 yarn.build 的 cli，可以更好的看到到底是哪个模块运行命令卡住了，可以统计一共用了多长时间。")],-1);t.render=function(o,r){const t=n("OutboundLink");return a(),s(l,null,[c,e("ul",null,[p,u,e("li",null,[i,k,d,e("a",b,[h,e(t)])]),e("li",null,[y,g,m,f,x,w,j,e("a",v,[_,e(t)]),C])]),U,P,q,L,D,E,F,A,M,N,R,T,B,G,O,e("blockquote",null,[e("p",null,[e("a",S,[W,e(t)])])]),Y,Z,e("ul",null,[I,e("li",null,[$,e("a",z,[H,e(t)])]),e("li",null,[J,e("a",K,[Q,e(t)]),V]),X]),nn,an,sn,en,ln,on,rn,tn,cn,e("blockquote",null,[e("p",null,[e("a",pn,[un,e(t)])])]),kn,dn,bn,hn,yn,e("blockquote",null,[e("p",null,[e("a",gn,[mn,e(t)])])]),fn,xn,wn,jn,e("ul",null,[e("li",null,[e("a",vn,[_n,e(t)]),Cn])]),Un,Pn,qn,Ln,Dn,e("blockquote",null,[e("p",null,[e("a",En,[Fn,e(t)])])]),An,Mn,Nn,Rn,e("blockquote",null,[e("p",null,[Tn,e("a",Bn,[Gn,e(t)])])]),On,e("blockquote",null,[e("p",null,[Sn,e("a",Wn,[Yn,e(t)])])]),Zn,In,$n,zn,Hn,Jn],64)};export{t as default};
