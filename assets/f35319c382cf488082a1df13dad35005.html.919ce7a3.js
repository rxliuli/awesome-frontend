import{o as s,c as n,F as l,a as e,b as a}from"./app.3399a319.js";const i={},r=e("h2",{id:"场景",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#场景","aria-hidden":"true"},"#"),a(" 场景")],-1),u=e("p",null,"在我们使用 monorepo 将所有的前端项目放到一个项目中后，会面临各种各样的问题，其中的多个通用模块的初始化也会是一个问题。",-1),c=e("p",null,[e("img",{src:"/assets/2779a9f352d849a6bb3c6fa91ca33c48.fcd942dc.svg",alt:"monorepo 模块依赖图.drawio.svg"})],-1),t=e("p",null,"下面是目前实践过的一些解决方案",-1),o=e("ul",null,[e("li",null,"增量构建"),e("li",null,"基于 esbuild"),e("li",null,"不构建 dts")],-1),b=e("h2",{id:"增量构建",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#增量构建","aria-hidden":"true"},"#"),a(" 增量构建")],-1),p=e("p",null,[a("每次修改 libs 中的内容，其他人通过 git 拉取时都需要重新 "),e("code",null,"initialize"),a("，如果知道在哪个包还好，可以仅运行指定包的 "),e("code",null,"initialize"),a(" 命令。如果不知道的话，则需要运行根目录的 "),e("code",null,"initialize"),a(" 命令，这其实是非常缓慢的，因为它会重新运行所有包含 "),e("code",null,"intialize"),a(" 命令的 npm 包，而不管它们是否有变更。")],-1),m=e("ol",null,[e("li",null,"减少 initialize 时间，提高协作的开发体验"),e("li",null,"支持 ci/cd 缓存已构建的 libs，加快构建时间")],-1),d=e("p",null,"需求",-1),h=e("ul",null,[e("li",null,"尽可能地按照依赖图并发执行命令，并且基于 git 变更实现缓存"),e("li",null,"在指定模块依赖的模块执行命令"),e("li",null,"在所有子模块中执行命令")],-1),f=e("p",null,"真实项目构建时间",-1),k=e("ul",null,[e("li",null,[e("code",null,"lerna run"),e("ul",null,[e("li",null,"新项目首次初始化 198.54s"),e("li",null,"非新项目再次初始化 90.17s")])])],-1),g=e("p",null,"吾辈在 yarn-plugin-changed 模块中基于 yarn2 实现了这个功能。",-1),x=e("h2",{id:"基于-esbuild",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#基于-esbuild","aria-hidden":"true"},"#"),a(" 基于 esbuild")],-1),j=e("p",null,"rollup 使用 js 编写，它在使用必须的插件之后打包非常缓慢（可能部分要归结于 tsc 本身也非常慢），而 esbuild 在官方性能测试中要快 10-100 倍，这为性能优化提供了一种思路：将 CPU 密集型的功能使用高性能的语言构建。在使用 esbuild 命令行时，基本上，lib/cli 都能在数百毫秒内完成构建，而其中实际运行构建代码的时间大约只有几十毫秒，大部分时间是在等待 cli 启动。",-1),v=e("p",null,"下面是一个在单模块的性能测试",-1),y=e("p",null,"esbuild cli",-1),z=e("div",{class:"language-bash ext-sh line-numbers-mode"},[e("pre",{class:"language-bash"},[e("code",null,[e("span",{class:"token function"},"time"),a(" esbuild src/bin.ts --bundle --external:esbuild --external:@yarnpkg/cli --platform"),e("span",{class:"token operator"},"="),a("node --outfile"),e("span",{class:"token operator"},"="),a("dist/bin.js --sourcemap "),e("span",{class:"token operator"},"&&"),a(),e("span",{class:"token punctuation"},"\\"),a("\n"),e("span",{class:"token function"},"time"),a(" esbuild src/index.ts --bundle --external:esbuild --external:@yarnpkg/cli --external:fs-extra --platform"),e("span",{class:"token operator"},"="),a("node --format"),e("span",{class:"token operator"},"="),a("cjs --outfile"),e("span",{class:"token operator"},"="),a("dist/index.js --sourcemap "),e("span",{class:"token operator"},"&&"),a(),e("span",{class:"token punctuation"},"\\"),a("\n"),e("span",{class:"token function"},"time"),a(" esbuild src/index.ts --bundle --external:esbuild --external:@yarnpkg/cli --external:fs-extra --platform"),e("span",{class:"token operator"},"="),a("node --format"),e("span",{class:"token operator"},"="),a("esm --outfile"),e("span",{class:"token operator"},"="),a("dist/index.esm.js --sourcemap\n"),e("span",{class:"token comment"},"# 0m0.244s # 15ms"),a("\n"),e("span",{class:"token comment"},"# 0m0.211s # 4ms"),a("\n"),e("span",{class:"token comment"},"# 0m0.212s # 4ms"),a("\n")])]),e("div",{class:"line-numbers"},[e("span",{class:"line-number"},"1"),e("br"),e("span",{class:"line-number"},"2"),e("br"),e("span",{class:"line-number"},"3"),e("br"),e("span",{class:"line-number"},"4"),e("br"),e("span",{class:"line-number"},"5"),e("br"),e("span",{class:"line-number"},"6"),e("br")])],-1),$=e("p",null,"esbuild base nodejs cli",-1),w=e("div",{class:"language-bash ext-sh line-numbers-mode"},[e("pre",{class:"language-bash"},[e("code",null,[e("span",{class:"token function"},"time"),a(" pinefield build cli "),e("span",{class:"token comment"},"# 0m2.276s # 1988ms"),a("\n")])]),e("div",{class:"line-numbers"},[e("span",{class:"line-number"},"1"),e("br")])],-1),C=e("h2",{id:"不构建-dts",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#不构建-dts","aria-hidden":"true"},"#"),a(" 不构建 dts")],-1),F=e("p",null,"为什么不构建 dts？",-1),P=e("p",null,"构建 dts 很慢，至于多慢呢？下面是一个构建 cli 的时间分析",-1),U=e("p",null,"不生成类型定义",-1),q=e("div",{class:"language-bash ext-sh line-numbers-mode"},[e("pre",{class:"language-bash"},[e("code",null,[a("$ "),e("span",{class:"token function"},"time"),a(),e("span",{class:"token function"},"yarn"),a(" build\n√ 构建 cli: 141ms\n√ 构建 esm: 18ms\n√ 构建 cjs: 17ms\n构建完成: 142ms\n\nreal    0m4.000s\nuser    0m0.075s\nsys     0m0.138s\n")])]),e("div",{class:"line-numbers"},[e("span",{class:"line-number"},"1"),e("br"),e("span",{class:"line-number"},"2"),e("br"),e("span",{class:"line-number"},"3"),e("br"),e("span",{class:"line-number"},"4"),e("br"),e("span",{class:"line-number"},"5"),e("br"),e("span",{class:"line-number"},"6"),e("br"),e("span",{class:"line-number"},"7"),e("br"),e("span",{class:"line-number"},"8"),e("br"),e("span",{class:"line-number"},"9"),e("br")])],-1),A=e("p",null,"生成类型定义",-1),B=e("div",{class:"language-bash ext-sh line-numbers-mode"},[e("pre",{class:"language-bash"},[e("code",null,[a("$ "),e("span",{class:"token function"},"time"),a(),e("span",{class:"token function"},"yarn"),a(" build\n√ 构建 cli: 3598ms\n√ 构建 esm: 50ms\n√ 构建 cjs: 3587ms\n√ 生成类型定义: 3602ms\n构建完成: 3614ms\n\nreal    0m7.763s\nuser    0m0.000s\nsys     0m0.197s\n")])]),e("div",{class:"line-numbers"},[e("span",{class:"line-number"},"1"),e("br"),e("span",{class:"line-number"},"2"),e("br"),e("span",{class:"line-number"},"3"),e("br"),e("span",{class:"line-number"},"4"),e("br"),e("span",{class:"line-number"},"5"),e("br"),e("span",{class:"line-number"},"6"),e("br"),e("span",{class:"line-number"},"7"),e("br"),e("span",{class:"line-number"},"8"),e("br"),e("span",{class:"line-number"},"9"),e("br"),e("span",{class:"line-number"},"10"),e("br")])],-1),D=e("p",null,"可以看到，生成类型定义耗费了大量的时间，与使用 esbuild 构建完全不在一个时间量级上。但同时，我们也必须注意到，nodejs 花费的真实时间很多，甚至远超构建本身，也就意味着，nodejs 确实存在性能极限。实际项目中，初始化 15 个模块需要 30s 438ms，而生成 dts 则需要 44s 343ms，单点优化对整体已经很难产生数量级的影响了。",-1);i.render=function(e,a){return s(),n(l,null,[r,u,c,t,o,b,p,m,d,h,f,k,g,x,j,v,y,z,$,w,C,F,P,U,q,A,B,D],64)};export{i as default};
