import{r as n,o as s,c as a,a as t,F as o,b as c}from"./app.7980cf23.js";const e={},p=t("h2",{id:"场景",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#场景","aria-hidden":"true"},"#"),c(" 场景")],-1),l=t("p",null,[c("在前文 "),t("a",{href:"/p/bafce41b0e6840908c5b5452c0fca1db"},"JavaScript 沙箱探索"),c(" 中声明了沙箱的接口，并且给出了一些简单的执行任意第三方 js 脚本的代码，但并未实现完整的 "),t("code",null,"IJavaScriptShadowbox"),c("，下面便讲一下如何基于 quickjs 实现它。")],-1),u=c("quickjs 在 js 的封装库是 "),i={href:"https://github.com/justjake/quickjs-emscripten/",target:"_blank",rel:"noopener noreferrer"},k=c("quickjs-emscripten"),r=c("，基本原理是将 c 编译为 wasm 然后运行在浏览器、nodejs 上，它提供了以下基础的 api。"),b=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"export"),c(),t("span",{class:"token keyword"},"interface"),c(),t("span",{class:"token class-name"},[c("LowLevelJavascriptVm"),t("span",{class:"token operator"},"<"),c("VmHandle"),t("span",{class:"token operator"},">")]),c(),t("span",{class:"token punctuation"},"{"),c("\n  global"),t("span",{class:"token operator"},":"),c(" VmHandle"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token keyword"},"undefined"),t("span",{class:"token operator"},":"),c(" VmHandle"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token keyword"},"typeof"),t("span",{class:"token punctuation"},"("),c("handle"),t("span",{class:"token operator"},":"),c(" VmHandle"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token function"},"getNumber"),t("span",{class:"token punctuation"},"("),c("handle"),t("span",{class:"token operator"},":"),c(" VmHandle"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"number"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token function"},"getString"),t("span",{class:"token punctuation"},"("),c("handle"),t("span",{class:"token operator"},":"),c(" VmHandle"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token function"},"newNumber"),t("span",{class:"token punctuation"},"("),c("value"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"number"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(" VmHandle"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token function"},"newString"),t("span",{class:"token punctuation"},"("),c("value"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(" VmHandle"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token function"},"newObject"),t("span",{class:"token punctuation"},"("),c("prototype"),t("span",{class:"token operator"},"?"),t("span",{class:"token operator"},":"),c(" VmHandle"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(" VmHandle"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token function"},"newFunction"),t("span",{class:"token punctuation"},"("),c("\n    name"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},","),c("\n    value"),t("span",{class:"token operator"},":"),c(" VmFunctionImplementation"),t("span",{class:"token operator"},"<"),c("VmHandle"),t("span",{class:"token operator"},">"),c("\n  "),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(" VmHandle"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token function"},"getProp"),t("span",{class:"token punctuation"},"("),c("handle"),t("span",{class:"token operator"},":"),c(" VmHandle"),t("span",{class:"token punctuation"},","),c(" key"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),c(),t("span",{class:"token operator"},"|"),c(" VmHandle"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(" VmHandle"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token function"},"setProp"),t("span",{class:"token punctuation"},"("),c("handle"),t("span",{class:"token operator"},":"),c(" VmHandle"),t("span",{class:"token punctuation"},","),c(" key"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),c(),t("span",{class:"token operator"},"|"),c(" VmHandle"),t("span",{class:"token punctuation"},","),c(" value"),t("span",{class:"token operator"},":"),c(" VmHandle"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"void"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token function"},"defineProp"),t("span",{class:"token punctuation"},"("),c("\n    handle"),t("span",{class:"token operator"},":"),c(" VmHandle"),t("span",{class:"token punctuation"},","),c("\n    key"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),c(),t("span",{class:"token operator"},"|"),c(" VmHandle"),t("span",{class:"token punctuation"},","),c("\n    descriptor"),t("span",{class:"token operator"},":"),c(" VmPropertyDescriptor"),t("span",{class:"token operator"},"<"),c("VmHandle"),t("span",{class:"token operator"},">"),c("\n  "),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"void"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token function"},"callFunction"),t("span",{class:"token punctuation"},"("),c("\n    func"),t("span",{class:"token operator"},":"),c(" VmHandle"),t("span",{class:"token punctuation"},","),c("\n    thisVal"),t("span",{class:"token operator"},":"),c(" VmHandle"),t("span",{class:"token punctuation"},","),c("\n    "),t("span",{class:"token operator"},"..."),c("args"),t("span",{class:"token operator"},":"),c(" VmHandle"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),c("\n  "),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(" VmCallResult"),t("span",{class:"token operator"},"<"),c("VmHandle"),t("span",{class:"token operator"},">"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),c("code"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(" VmCallResult"),t("span",{class:"token operator"},"<"),c("VmHandle"),t("span",{class:"token operator"},">"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),c("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br")])],-1),m=t("p",null,"下面是一段官方的代码示例",-1),d=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" getQuickJS "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"quickjs-emscripten"'),t("span",{class:"token punctuation"},";"),c("\n\n"),t("span",{class:"token keyword"},"async"),c(),t("span",{class:"token keyword"},"function"),c(),t("span",{class:"token function"},"main"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n  "),t("span",{class:"token keyword"},"const"),c(" QuickJS "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token keyword"},"await"),c(),t("span",{class:"token function"},"getQuickJS"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token keyword"},"const"),c(" vm "),t("span",{class:"token operator"},"="),c(" QuickJS"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"createVm"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n\n  "),t("span",{class:"token keyword"},"const"),c(" world "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"newString"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"world"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"setProp"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),c("global"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"NAME"'),t("span",{class:"token punctuation"},","),c(" world"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  world"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n\n  "),t("span",{class:"token keyword"},"const"),c(" result "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token template-string"},[t("span",{class:"token template-punctuation string"},"`"),t("span",{class:"token string"},'"Hello " + NAME + "!"'),t("span",{class:"token template-punctuation string"},"`")]),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),c("result"),t("span",{class:"token punctuation"},"."),c("error"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token builtin"},"console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"Execution failed:"'),t("span",{class:"token punctuation"},","),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dump"),t("span",{class:"token punctuation"},"("),c("result"),t("span",{class:"token punctuation"},"."),c("error"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    result"),t("span",{class:"token punctuation"},"."),c("error"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"else"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token builtin"},"console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"Success:"'),t("span",{class:"token punctuation"},","),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dump"),t("span",{class:"token punctuation"},"("),c("result"),t("span",{class:"token punctuation"},"."),c("value"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    result"),t("span",{class:"token punctuation"},"."),c("value"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),c("\n\n  vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),c("\n\n"),t("span",{class:"token function"},"main"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br")])],-1),f=c("可以看到，创建 vm 中的变量后还必须留意调用 "),v=t("code",null,"dispose",-1),w=c("，有点像是后端连接数据库时必须注意关闭连接，而这其实是比较繁琐的，尤其是在复杂的情况下。简而言之，它的 api 太过于底层了。在 github issue 中有人创建了 "),y={href:"https://github.com/reearth/quickjs-emscripten-sync",target:"_blank",rel:"noopener noreferrer"},g=c("quickjs-emscripten-sync"),h=c("，这给了吾辈很多灵感，所以吾辈基于 quickjs-emscripten 封装了一些工具函数，辅助而非替代它。"),S=t("h2",{id:"简化底层-api",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#简化底层-api","aria-hidden":"true"},"#"),c(" 简化底层 api")],-1),V=t("p",null,"主要目的有两个",-1),x=t("ul",null,[t("li",null,[c("自动调用 "),t("code",null,"dispose")]),t("li",null,"提供更好的创建 vm 值的方法")],-1),M=t("h3",{id:"自动调用-dispose",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#自动调用-dispose","aria-hidden":"true"},"#"),c(" 自动调用 "),t("code",null,"dispose")],-1),C=t("p",null,[c("主要思路是自动收集所有需要调用 "),t("code",null,"dispose"),c(" 的值，使用高阶函数在 callback 执行完之后自动调用。")],-1),J=t("blockquote",null,[t("p",null,"这里还需要注意避免不需要的多层嵌套代理，主要是考虑到下面更多的底层 api 基于它实现，而它们之间可能存在嵌套调用。")],-1),_=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" QuickJSHandle"),t("span",{class:"token punctuation"},","),c(" QuickJSVm "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"quickjs-emscripten"'),t("span",{class:"token punctuation"},";"),c("\n\n"),t("span",{class:"token keyword"},"const"),c(" QuickJSVmScopeSymbol "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token function"},"Symbol"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"QuickJSVmScope"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n\n"),t("span",{class:"token doc-comment comment"},[c("/**\n * 为 QuickJSVm 添加局部作用域，局部作用域的所有方法调用不再需要手动释放内存\n * "),t("span",{class:"token keyword"},"@param"),c(),t("span",{class:"token parameter"},"vm"),c("\n * "),t("span",{class:"token keyword"},"@param"),c(),t("span",{class:"token parameter"},"handle"),c("\n */")]),c("\n"),t("span",{class:"token keyword"},"export"),c(),t("span",{class:"token keyword"},"function"),c(" withScope"),t("span",{class:"token operator"},"<"),t("span",{class:"token constant"},"F"),c(),t("span",{class:"token keyword"},"extends"),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token operator"},":"),c(" QuickJSVm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token operator"},">"),t("span",{class:"token punctuation"},"("),c("\n  vm"),t("span",{class:"token operator"},":"),c(" QuickJSVm"),t("span",{class:"token punctuation"},","),c("\n  handle"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token constant"},"F"),c("\n"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token punctuation"},"{"),c("\n  value"),t("span",{class:"token operator"},":"),c(" ReturnType"),t("span",{class:"token operator"},"<"),t("span",{class:"token constant"},"F"),t("span",{class:"token operator"},">"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"void"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token punctuation"},"{"),c("\n  "),t("span",{class:"token keyword"},"let"),c(" disposes"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token keyword"},"void"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),c(),t("span",{class:"token operator"},"="),c(),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},";"),c("\n\n  "),t("span",{class:"token keyword"},"function"),c(),t("span",{class:"token function"},"wrap"),t("span",{class:"token punctuation"},"("),c("handle"),t("span",{class:"token operator"},":"),c(" QuickJSHandle"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n    disposes"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"push"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(" handle"),t("span",{class:"token punctuation"},"."),c("alive "),t("span",{class:"token operator"},"&&"),c(" handle"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token keyword"},"return"),c(" handle"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),c("\n\n  "),t("span",{class:"token comment"},"//避免多层代理"),c("\n  "),t("span",{class:"token keyword"},"const"),c(" isProxy "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token operator"},"!"),t("span",{class:"token operator"},"!"),c("Reflect"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"get"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(" QuickJSVmScopeSymbol"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token keyword"},"function"),c(),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),c("isProxy"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n      Reflect"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"get"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(" QuickJSVmScopeSymbol"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n      "),t("span",{class:"token keyword"},"return"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token punctuation"},"}"),c("\n    disposes"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),c("dispose"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token comment"},"//手动释放闭包变量的内存"),c("\n    disposes"),t("span",{class:"token punctuation"},"."),c("length "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),c("\n  "),t("span",{class:"token keyword"},"const"),c(" value "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token function"},"handle"),t("span",{class:"token punctuation"},"("),c("\n    isProxy\n      "),t("span",{class:"token operator"},"?"),c(" vm\n      "),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"new"),c(),t("span",{class:"token class-name"},"Proxy"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"{"),c("\n          "),t("span",{class:"token function"},"get"),t("span",{class:"token punctuation"},"("),c("\n            target"),t("span",{class:"token operator"},":"),c(" QuickJSVm"),t("span",{class:"token punctuation"},","),c("\n            p"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"keyof"),c(" QuickJSVm "),t("span",{class:"token operator"},"|"),c(),t("span",{class:"token keyword"},"typeof"),c(" QuickJSVmScopeSymbol\n          "),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),c(),t("span",{class:"token punctuation"},"{"),c("\n            "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),c("p "),t("span",{class:"token operator"},"==="),c(" QuickJSVmScopeSymbol"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n              "),t("span",{class:"token keyword"},"return"),c(" dispose"),t("span",{class:"token punctuation"},";"),c("\n            "),t("span",{class:"token punctuation"},"}"),c("\n            "),t("span",{class:"token comment"},"//锁定所有方法的 this 值为 QuickJSVm 对象而非 Proxy 对象"),c("\n            "),t("span",{class:"token keyword"},"const"),c(" res "),t("span",{class:"token operator"},"="),c(" Reflect"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"get"),t("span",{class:"token punctuation"},"("),c("target"),t("span",{class:"token punctuation"},","),c(" p"),t("span",{class:"token punctuation"},","),c(" target"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n            "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),c("\n              p"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"startsWith"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"new"'),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"||"),c("\n              "),t("span",{class:"token punctuation"},"["),t("span",{class:"token string"},'"getProp"'),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"unwrapResult"'),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"includes"),t("span",{class:"token punctuation"},"("),c("p"),t("span",{class:"token punctuation"},")"),c("\n            "),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n              "),t("span",{class:"token keyword"},"return"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"..."),c("args"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(" QuickJSHandle "),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n                "),t("span",{class:"token keyword"},"return"),c(),t("span",{class:"token function"},"wrap"),t("span",{class:"token punctuation"},"("),t("span",{class:"token function"},"Reflect"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"apply"),t("span",{class:"token punctuation"},"("),c("res"),t("span",{class:"token punctuation"},","),c(" target"),t("span",{class:"token punctuation"},","),c(" args"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n              "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},";"),c("\n            "),t("span",{class:"token punctuation"},"}"),c("\n            "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"["),t("span",{class:"token string"},'"evalCode"'),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"callFunction"'),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"includes"),t("span",{class:"token punctuation"},"("),c("p"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n              "),t("span",{class:"token keyword"},"return"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"..."),c("args"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n                "),t("span",{class:"token keyword"},"const"),c(" res "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token punctuation"},"("),c("target"),t("span",{class:"token punctuation"},"["),c("p"),t("span",{class:"token punctuation"},"]"),c(),t("span",{class:"token keyword"},"as"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"..."),c("args"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n                disposes"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"push"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n                  "),t("span",{class:"token keyword"},"const"),c(" handle "),t("span",{class:"token operator"},"="),c(" res"),t("span",{class:"token punctuation"},"."),c("error "),t("span",{class:"token operator"},"??"),c(" res"),t("span",{class:"token punctuation"},"."),c("value"),t("span",{class:"token punctuation"},";"),c("\n                  handle"),t("span",{class:"token punctuation"},"."),c("alive "),t("span",{class:"token operator"},"&&"),c(" handle"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n                "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n                "),t("span",{class:"token keyword"},"return"),c(" res"),t("span",{class:"token punctuation"},";"),c("\n              "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},";"),c("\n            "),t("span",{class:"token punctuation"},"}"),c("\n            "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),c(" res "),t("span",{class:"token operator"},"==="),c(),t("span",{class:"token string"},'"function"'),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n              "),t("span",{class:"token keyword"},"return"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"..."),c("args"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n                "),t("span",{class:"token keyword"},"return"),c(),t("span",{class:"token function"},"Reflect"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"apply"),t("span",{class:"token punctuation"},"("),c("res"),t("span",{class:"token punctuation"},","),c(" target"),t("span",{class:"token punctuation"},","),c(" args"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n              "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},";"),c("\n            "),t("span",{class:"token punctuation"},"}"),c("\n            "),t("span",{class:"token keyword"},"return"),c(" res"),t("span",{class:"token punctuation"},";"),c("\n          "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),c("\n        "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),c("\n  "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n\n  "),t("span",{class:"token keyword"},"return"),c(),t("span",{class:"token punctuation"},"{"),c(" value"),t("span",{class:"token punctuation"},","),c(" dispose "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),c("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br"),t("span",{class:"line-number"},"30"),t("br"),t("span",{class:"line-number"},"31"),t("br"),t("span",{class:"line-number"},"32"),t("br"),t("span",{class:"line-number"},"33"),t("br"),t("span",{class:"line-number"},"34"),t("br"),t("span",{class:"line-number"},"35"),t("br"),t("span",{class:"line-number"},"36"),t("br"),t("span",{class:"line-number"},"37"),t("br"),t("span",{class:"line-number"},"38"),t("br"),t("span",{class:"line-number"},"39"),t("br"),t("span",{class:"line-number"},"40"),t("br"),t("span",{class:"line-number"},"41"),t("br"),t("span",{class:"line-number"},"42"),t("br"),t("span",{class:"line-number"},"43"),t("br"),t("span",{class:"line-number"},"44"),t("br"),t("span",{class:"line-number"},"45"),t("br"),t("span",{class:"line-number"},"46"),t("br"),t("span",{class:"line-number"},"47"),t("br"),t("span",{class:"line-number"},"48"),t("br"),t("span",{class:"line-number"},"49"),t("br"),t("span",{class:"line-number"},"50"),t("br"),t("span",{class:"line-number"},"51"),t("br"),t("span",{class:"line-number"},"52"),t("br"),t("span",{class:"line-number"},"53"),t("br"),t("span",{class:"line-number"},"54"),t("br"),t("span",{class:"line-number"},"55"),t("br"),t("span",{class:"line-number"},"56"),t("br"),t("span",{class:"line-number"},"57"),t("br"),t("span",{class:"line-number"},"58"),t("br"),t("span",{class:"line-number"},"59"),t("br"),t("span",{class:"line-number"},"60"),t("br"),t("span",{class:"line-number"},"61"),t("br"),t("span",{class:"line-number"},"62"),t("br"),t("span",{class:"line-number"},"63"),t("br"),t("span",{class:"line-number"},"64"),t("br"),t("span",{class:"line-number"},"65"),t("br"),t("span",{class:"line-number"},"66"),t("br"),t("span",{class:"line-number"},"67"),t("br"),t("span",{class:"line-number"},"68"),t("br"),t("span",{class:"line-number"},"69"),t("br"),t("span",{class:"line-number"},"70"),t("br"),t("span",{class:"line-number"},"71"),t("br"),t("span",{class:"line-number"},"72"),t("br"),t("span",{class:"line-number"},"73"),t("br"),t("span",{class:"line-number"},"74"),t("br"),t("span",{class:"line-number"},"75"),t("br"),t("span",{class:"line-number"},"76"),t("br"),t("span",{class:"line-number"},"77"),t("br")])],-1),I=t("p",null,"使用",-1),L=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token function"},"withScope"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n  "),t("span",{class:"token keyword"},"const"),c(" _hello "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"newFunction"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"hello"'),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token keyword"},"const"),c(" _object "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"newObject"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"setProp"),t("span",{class:"token punctuation"},"("),c("_object"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"hello"'),t("span",{class:"token punctuation"},","),c(" _hello"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"setProp"),t("span",{class:"token punctuation"},"("),c("_object"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"name"'),t("span",{class:"token punctuation"},","),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"newString"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"liuli"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token function"},"expect"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dump"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"getProp"),t("span",{class:"token punctuation"},"("),c("_object"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"hello"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),c("not"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"toBeNull"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"setProp"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),c("global"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"VM_GLOBAL"'),t("span",{class:"token punctuation"},","),c(" _object"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br")])],-1),E=t("p",null,[c("甚至支持嵌套调用，而且仅需要在最外层统一调用 "),t("code",null,"dispose"),c(" 即可")],-1),P=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token function"},"withScope"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c("\n  "),t("span",{class:"token function"},"withScope"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token builtin"},"console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dump"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"unwrapResult"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"1+1"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),c("\n"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br")])],-1),Q=t("h3",{id:"提供更好的创建-vm-值的方法",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#提供更好的创建-vm-值的方法","aria-hidden":"true"},"#"),c(" 提供更好的创建 vm 值的方法")],-1),j=t("p",null,"主要思路是判断创建 vm 变量的类型，自动调用相应的函数，然后返回创建的变量。",-1),B=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" QuickJSHandle"),t("span",{class:"token punctuation"},","),c(" QuickJSVm "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"quickjs-emscripten"'),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" withScope "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"./withScope"'),t("span",{class:"token punctuation"},";"),c("\n\n"),t("span",{class:"token keyword"},"type"),c(),t("span",{class:"token class-name"},"MarshalValue"),c(),t("span",{class:"token operator"},"="),c(),t("span",{class:"token punctuation"},"{"),c(" value"),t("span",{class:"token operator"},":"),c(" QuickJSHandle"),t("span",{class:"token punctuation"},";"),c(),t("span",{class:"token function-variable function"},"dispose"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token keyword"},"void"),c(),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},";"),c("\n\n"),t("span",{class:"token doc-comment comment"},[c("/**\n * 简化使用 QuickJSVm 创建复杂对象的操作\n * "),t("span",{class:"token keyword"},"@param"),c(),t("span",{class:"token parameter"},"vm"),c("\n */")]),c("\n"),t("span",{class:"token keyword"},"export"),c(),t("span",{class:"token keyword"},"function"),c(),t("span",{class:"token function"},"marshal"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token operator"},":"),c(" QuickJSVm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n  "),t("span",{class:"token keyword"},"function"),c(),t("span",{class:"token function"},"marshal"),t("span",{class:"token punctuation"},"("),t("span",{class:"token function-variable function"},"value"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"..."),c("args"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},","),c(" name"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(" MarshalValue"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token keyword"},"function"),c(),t("span",{class:"token function"},"marshal"),t("span",{class:"token punctuation"},"("),c("value"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(" MarshalValue"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token keyword"},"function"),c(),t("span",{class:"token function"},"marshal"),t("span",{class:"token punctuation"},"("),c("value"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},","),c(" name"),t("span",{class:"token operator"},"?"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(" MarshalValue "),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token keyword"},"return"),c(),t("span",{class:"token function"},"withScope"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n      "),t("span",{class:"token keyword"},"function"),c(),t("span",{class:"token function"},"_f"),t("span",{class:"token punctuation"},"("),c("value"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},","),c(" name"),t("span",{class:"token operator"},"?"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(" QuickJSHandle "),t("span",{class:"token punctuation"},"{"),c("\n        "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),c(" value "),t("span",{class:"token operator"},"==="),c(),t("span",{class:"token string"},'"string"'),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n          "),t("span",{class:"token keyword"},"return"),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"newString"),t("span",{class:"token punctuation"},"("),c("value"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token punctuation"},"}"),c("\n        "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),c(" value "),t("span",{class:"token operator"},"==="),c(),t("span",{class:"token string"},'"number"'),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n          "),t("span",{class:"token keyword"},"return"),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"newNumber"),t("span",{class:"token punctuation"},"("),c("value"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token punctuation"},"}"),c("\n        "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),c(" value "),t("span",{class:"token operator"},"==="),c(),t("span",{class:"token string"},'"boolean"'),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n          "),t("span",{class:"token keyword"},"return"),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"unwrapResult"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token template-string"},[t("span",{class:"token template-punctuation string"},"`"),t("span",{class:"token interpolation"},[t("span",{class:"token interpolation-punctuation punctuation"},"${"),c("value"),t("span",{class:"token interpolation-punctuation punctuation"},"}")]),t("span",{class:"token template-punctuation string"},"`")]),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token punctuation"},"}"),c("\n        "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),c("value "),t("span",{class:"token operator"},"==="),c(),t("span",{class:"token keyword"},"undefined"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n          "),t("span",{class:"token keyword"},"return"),c(" vm"),t("span",{class:"token punctuation"},"."),c("undefined"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token punctuation"},"}"),c("\n        "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),c("value "),t("span",{class:"token operator"},"==="),c(),t("span",{class:"token keyword"},"null"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n          "),t("span",{class:"token keyword"},"return"),c(" vm"),t("span",{class:"token punctuation"},"."),c("null"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token punctuation"},"}"),c("\n        "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),c(" value "),t("span",{class:"token operator"},"==="),c(),t("span",{class:"token string"},'"bigint"'),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n          "),t("span",{class:"token keyword"},"return"),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"unwrapResult"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token template-string"},[t("span",{class:"token template-punctuation string"},"`"),t("span",{class:"token string"},"BigInt("),t("span",{class:"token interpolation"},[t("span",{class:"token interpolation-punctuation punctuation"},"${"),c("value"),t("span",{class:"token interpolation-punctuation punctuation"},"}")]),t("span",{class:"token string"},")"),t("span",{class:"token template-punctuation string"},"`")]),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token punctuation"},"}"),c("\n        "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),c(" value "),t("span",{class:"token operator"},"==="),c(),t("span",{class:"token string"},'"function"'),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n          "),t("span",{class:"token keyword"},"return"),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"newFunction"),t("span",{class:"token punctuation"},"("),c("name"),t("span",{class:"token operator"},"!"),t("span",{class:"token punctuation"},","),c(" value"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token punctuation"},"}"),c("\n        "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),c(" value "),t("span",{class:"token operator"},"==="),c(),t("span",{class:"token string"},'"object"'),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n          "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token builtin"},"Array"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"isArray"),t("span",{class:"token punctuation"},"("),c("value"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n            "),t("span",{class:"token keyword"},"const"),c(" _array "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"newArray"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n            value"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),c("v"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n              "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),c(" v "),t("span",{class:"token operator"},"==="),c(),t("span",{class:"token string"},'"function"'),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n                "),t("span",{class:"token keyword"},"throw"),c(),t("span",{class:"token keyword"},"new"),c(),t("span",{class:"token class-name"},"Error"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"数组中禁止包含函数，因为无法指定名字"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n              "),t("span",{class:"token punctuation"},"}"),c("\n              vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"callFunction"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"getProp"),t("span",{class:"token punctuation"},"("),c("_array"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"push"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),c(" _array"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token function"},"_f"),t("span",{class:"token punctuation"},"("),c("v"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n            "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n            "),t("span",{class:"token keyword"},"return"),c(" _array"),t("span",{class:"token punctuation"},";"),c("\n          "),t("span",{class:"token punctuation"},"}"),c("\n          "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),c("value "),t("span",{class:"token keyword"},"instanceof"),c(),t("span",{class:"token class-name"},"Map"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n            "),t("span",{class:"token keyword"},"const"),c(" _map "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"unwrapResult"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"new Map()"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n            value"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),c("v"),t("span",{class:"token punctuation"},","),c(" k"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n              vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"unwrapResult"),t("span",{class:"token punctuation"},"("),c("\n                vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"callFunction"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"getProp"),t("span",{class:"token punctuation"},"("),c("_map"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"set"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),c(" _map"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token function"},"_f"),t("span",{class:"token punctuation"},"("),c("k"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token function"},"_f"),t("span",{class:"token punctuation"},"("),c("v"),t("span",{class:"token punctuation"},","),c(" k"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),c("\n              "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n            "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n            "),t("span",{class:"token keyword"},"return"),c(" _map"),t("span",{class:"token punctuation"},";"),c("\n          "),t("span",{class:"token punctuation"},"}"),c("\n          "),t("span",{class:"token keyword"},"const"),c(" _object "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"newObject"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n          Object"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"entries"),t("span",{class:"token punctuation"},"("),c("value"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"["),c("k"),t("span",{class:"token punctuation"},","),c(" v"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n            vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"setProp"),t("span",{class:"token punctuation"},"("),c("_object"),t("span",{class:"token punctuation"},","),c(" k"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token function"},"_f"),t("span",{class:"token punctuation"},"("),c("v"),t("span",{class:"token punctuation"},","),c(" k"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n          "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n          "),t("span",{class:"token keyword"},"return"),c(" _object"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token punctuation"},"}"),c("\n        "),t("span",{class:"token keyword"},"throw"),c(),t("span",{class:"token keyword"},"new"),c(),t("span",{class:"token class-name"},"Error"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"不支持的类型"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n      "),t("span",{class:"token punctuation"},"}"),c("\n      "),t("span",{class:"token keyword"},"return"),c(),t("span",{class:"token function"},"_f"),t("span",{class:"token punctuation"},"("),c("value"),t("span",{class:"token punctuation"},","),c(" name"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),c("\n\n  "),t("span",{class:"token keyword"},"return"),c(" marshal"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),c("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br"),t("span",{class:"line-number"},"30"),t("br"),t("span",{class:"line-number"},"31"),t("br"),t("span",{class:"line-number"},"32"),t("br"),t("span",{class:"line-number"},"33"),t("br"),t("span",{class:"line-number"},"34"),t("br"),t("span",{class:"line-number"},"35"),t("br"),t("span",{class:"line-number"},"36"),t("br"),t("span",{class:"line-number"},"37"),t("br"),t("span",{class:"line-number"},"38"),t("br"),t("span",{class:"line-number"},"39"),t("br"),t("span",{class:"line-number"},"40"),t("br"),t("span",{class:"line-number"},"41"),t("br"),t("span",{class:"line-number"},"42"),t("br"),t("span",{class:"line-number"},"43"),t("br"),t("span",{class:"line-number"},"44"),t("br"),t("span",{class:"line-number"},"45"),t("br"),t("span",{class:"line-number"},"46"),t("br"),t("span",{class:"line-number"},"47"),t("br"),t("span",{class:"line-number"},"48"),t("br"),t("span",{class:"line-number"},"49"),t("br"),t("span",{class:"line-number"},"50"),t("br"),t("span",{class:"line-number"},"51"),t("br"),t("span",{class:"line-number"},"52"),t("br"),t("span",{class:"line-number"},"53"),t("br"),t("span",{class:"line-number"},"54"),t("br"),t("span",{class:"line-number"},"55"),t("br"),t("span",{class:"line-number"},"56"),t("br"),t("span",{class:"line-number"},"57"),t("br"),t("span",{class:"line-number"},"58"),t("br"),t("span",{class:"line-number"},"59"),t("br"),t("span",{class:"line-number"},"60"),t("br"),t("span",{class:"line-number"},"61"),t("br"),t("span",{class:"line-number"},"62"),t("br"),t("span",{class:"line-number"},"63"),t("br"),t("span",{class:"line-number"},"64"),t("br"),t("span",{class:"line-number"},"65"),t("br"),t("span",{class:"line-number"},"66"),t("br"),t("span",{class:"line-number"},"67"),t("br"),t("span",{class:"line-number"},"68"),t("br"),t("span",{class:"line-number"},"69"),t("br"),t("span",{class:"line-number"},"70"),t("br")])],-1),T=t("p",null,"使用",-1),H=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"const"),c(" mockHello "),t("span",{class:"token operator"},"="),c(" jest"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"fn"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"const"),c(" now "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token keyword"},"new"),c(),t("span",{class:"token class-name"},"Date"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"const"),c(),t("span",{class:"token punctuation"},"{"),c(" value"),t("span",{class:"token punctuation"},","),c(" dispose "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token operator"},"="),c(),t("span",{class:"token function"},"marshal"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),c("\n  name"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token string"},'"liuli"'),t("span",{class:"token punctuation"},","),c("\n  age"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token number"},"1"),t("span",{class:"token punctuation"},","),c("\n  sex"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token boolean"},"false"),t("span",{class:"token punctuation"},","),c("\n  hobby"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token punctuation"},"["),t("span",{class:"token number"},"1"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token number"},"2"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token number"},"3"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},","),c("\n  account"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token punctuation"},"{"),c("\n    username"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token string"},'"li"'),t("span",{class:"token punctuation"},","),c("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),c("\n  hello"),t("span",{class:"token operator"},":"),c(" mockHello"),t("span",{class:"token punctuation"},","),c("\n  map"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"new"),c(),t("span",{class:"token class-name"},"Map"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"set"),t("span",{class:"token punctuation"},"("),t("span",{class:"token number"},"1"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"a"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),c("\n  date"),t("span",{class:"token operator"},":"),c(" now"),t("span",{class:"token punctuation"},","),c("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\nvm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"setProp"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),c("global"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"vm_global"'),t("span",{class:"token punctuation"},","),c(" value"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"function"),c(),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),c("code"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n  "),t("span",{class:"token keyword"},"return"),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"unwrapResult"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),c("code"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"consume"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dump"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"bind"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),c("\n"),t("span",{class:"token function"},"expect"),t("span",{class:"token punctuation"},"("),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"vm_global.name"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"toBe"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"liuli"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token function"},"expect"),t("span",{class:"token punctuation"},"("),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"vm_global.age"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"toBe"),t("span",{class:"token punctuation"},"("),t("span",{class:"token number"},"1"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token function"},"expect"),t("span",{class:"token punctuation"},"("),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"vm_global.sex"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"toBe"),t("span",{class:"token punctuation"},"("),t("span",{class:"token boolean"},"false"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token function"},"expect"),t("span",{class:"token punctuation"},"("),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"vm_global.hobby"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"toEqual"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"["),t("span",{class:"token number"},"1"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token number"},"2"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token number"},"3"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token function"},"expect"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"new"),c(),t("span",{class:"token class-name"},"Date"),t("span",{class:"token punctuation"},"("),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"vm_global.date"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"toEqual"),t("span",{class:"token punctuation"},"("),c("now"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token function"},"expect"),t("span",{class:"token punctuation"},"("),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"vm_global.account.username"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"toEqual"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"li"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"vm_global.hello()"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token function"},"expect"),t("span",{class:"token punctuation"},"("),c("mockHello"),t("span",{class:"token punctuation"},"."),c("mock"),t("span",{class:"token punctuation"},"."),c("calls"),t("span",{class:"token punctuation"},"."),c("length"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"toBe"),t("span",{class:"token punctuation"},"("),t("span",{class:"token number"},"1"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token function"},"expect"),t("span",{class:"token punctuation"},"("),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"vm_global.map.size"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"toBe"),t("span",{class:"token punctuation"},"("),t("span",{class:"token number"},"1"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token function"},"expect"),t("span",{class:"token punctuation"},"("),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"vm_global.map.get(1)"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"toBe"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"a"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br")])],-1),G=c("目前支持的类型与 "),q={href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Structured_clone_algorithm",target:"_blank",rel:"noopener noreferrer"},A=c("JavaScript 结构化克隆算法"),O=c(" 对比，后者在很多地方（iframe/web worker/worker_threads）均有使用"),F=t("table",null,[t("thead",null,[t("tr",null,[t("th",null,"对象类型"),t("th",null,"quickjs"),t("th",null,"结构化克隆"),t("th",null,"注意")])]),t("tbody",null,[t("tr",null,[t("td",null,"所有的原始类型"),t("td",null,"✔️"),t("td",null,"❌"),t("td",null,"symbols 除外")]),t("tr",null,[t("td",null,"Function"),t("td",null,"✔️"),t("td",null,"✔️"),t("td")]),t("tr",null,[t("td",null,"Array"),t("td",null,"✔️"),t("td",null,"✔️"),t("td")]),t("tr",null,[t("td",null,"Object"),t("td",null,"✔️"),t("td",null,"✔️"),t("td",null,"仅包括普通对象（如对象字面量）")]),t("tr",null,[t("td",null,"Map"),t("td",null,"✔️"),t("td",null,"✔️"),t("td")]),t("tr",null,[t("td",null,"Set"),t("td",null,"✔️"),t("td",null,"✔️"),t("td")]),t("tr",null,[t("td",null,"Date"),t("td",null,"✔️"),t("td",null,"✔️"),t("td")]),t("tr",null,[t("td",null,"Error"),t("td",null,"❌"),t("td",null,"❌"),t("td")]),t("tr",null,[t("td",null,"Boolean"),t("td",null,"❌"),t("td",null,"✔️"),t("td",null,"对象")]),t("tr",null,[t("td",null,"String"),t("td",null,"❌"),t("td",null,"✔️"),t("td",null,"对象")]),t("tr",null,[t("td",null,"RegExp"),t("td",null,"❌"),t("td",null,"✔️"),t("td",null,"lastIndex 字段不会被保留。")]),t("tr",null,[t("td",null,"Blob"),t("td",null,"❌"),t("td",null,"✔️"),t("td")]),t("tr",null,[t("td",null,"File"),t("td",null,"❌"),t("td",null,"✔️"),t("td")]),t("tr",null,[t("td",null,"FileList"),t("td",null,"❌"),t("td",null,"✔️"),t("td")]),t("tr",null,[t("td",null,"ArrayBuffer"),t("td",null,"❌"),t("td",null,"✔️"),t("td")]),t("tr",null,[t("td",null,"ArrayBufferView"),t("td",null,"❌"),t("td",null,"✔️"),t("td",null,"这基本上意味着所有的类型化数组")]),t("tr",null,[t("td",null,"ImageData"),t("td",null,"❌"),t("td",null,"✔️"),t("td")])])],-1),R=t("blockquote",null,[t("p",null,"以上不支持的非常见类型并非 quickjs 不支持，仅仅是 marshal 暂未支持。")],-1),N=t("h2",{id:"实现-console-settimeout-setinterval-等常见-api",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#实现-console-settimeout-setinterval-等常见-api","aria-hidden":"true"},"#"),c(" 实现 console/setTimeout/setInterval 等常见 api")],-1),D=t("p",null,"由于 console/setTimeout/setInterval 均不是 js 语言级别的 api（但是浏览器、nodejs 均实现了），所以吾辈必须手动实现并注入它们。",-1),K=t("h3",{id:"实现-console",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#实现-console","aria-hidden":"true"},"#"),c(" 实现 console")],-1),W=t("p",null,"基本思路：为 vm 注入全局 console 对象，将参数 dump 之后转发到真正的 console api",-1),z=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" QuickJSVm "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"quickjs-emscripten"'),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" marshal "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"../util/marshal"'),t("span",{class:"token punctuation"},";"),c("\n\n"),t("span",{class:"token keyword"},"export"),c(),t("span",{class:"token keyword"},"interface"),c(),t("span",{class:"token class-name"},"IVmConsole"),c(),t("span",{class:"token punctuation"},"{"),c("\n  "),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"..."),c("args"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"void"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token function"},"info"),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"..."),c("args"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"void"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token function"},"warn"),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"..."),c("args"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"void"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token function"},"error"),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"..."),c("args"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"void"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),c("\n\n"),t("span",{class:"token doc-comment comment"},[c("/**\n * 定义 vm 中的 console api\n * "),t("span",{class:"token keyword"},"@param"),c(),t("span",{class:"token parameter"},"vm"),c("\n * "),t("span",{class:"token keyword"},"@param"),c(),t("span",{class:"token parameter"},"logger"),c("\n */")]),c("\n"),t("span",{class:"token keyword"},"export"),c(),t("span",{class:"token keyword"},"function"),c(),t("span",{class:"token function"},"defineConsole"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token operator"},":"),c(" QuickJSVm"),t("span",{class:"token punctuation"},","),c(" logger"),t("span",{class:"token operator"},":"),c(" IVmConsole"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n  "),t("span",{class:"token keyword"},"const"),c(" fields "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token punctuation"},"["),t("span",{class:"token string"},'"log"'),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"info"'),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"warn"'),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"error"'),t("span",{class:"token punctuation"},"]"),c(),t("span",{class:"token keyword"},"as"),c(),t("span",{class:"token keyword"},"const"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token keyword"},"const"),c(" dump "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dump"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"bind"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token keyword"},"const"),c(),t("span",{class:"token punctuation"},"{"),c(" value"),t("span",{class:"token punctuation"},","),c(" dispose "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token operator"},"="),c(),t("span",{class:"token function"},"marshal"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"("),c("\n    fields"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"reduce"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),c("res"),t("span",{class:"token punctuation"},","),c(" k"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n      res"),t("span",{class:"token punctuation"},"["),c("k"),t("span",{class:"token punctuation"},"]"),c(),t("span",{class:"token operator"},"="),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"..."),c("args"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n        logger"),t("span",{class:"token punctuation"},"["),c("k"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"..."),c("args"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"map"),t("span",{class:"token punctuation"},"("),c("dump"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n      "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},";"),c("\n      "),t("span",{class:"token keyword"},"return"),c(" res"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"{"),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"as"),c(" Record"),t("span",{class:"token operator"},"<"),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token builtin"},"Function"),t("span",{class:"token operator"},">"),t("span",{class:"token punctuation"},")"),c("\n  "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"setProp"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),c("global"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"console"'),t("span",{class:"token punctuation"},","),c(" value"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),c("\n\n"),t("span",{class:"token keyword"},"export"),c(),t("span",{class:"token keyword"},"class"),c(),t("span",{class:"token class-name"},"BasicVmConsole"),c(),t("span",{class:"token keyword"},"implements"),c(),t("span",{class:"token class-name"},"IVmConsole"),c(),t("span",{class:"token punctuation"},"{"),c("\n  "),t("span",{class:"token function"},"error"),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"..."),c("args"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"void"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token builtin"},"console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"error"),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"..."),c("args"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),c("\n\n  "),t("span",{class:"token function"},"info"),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"..."),c("args"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"void"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token builtin"},"console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"info"),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"..."),c("args"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),c("\n\n  "),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"..."),c("args"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"void"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token builtin"},"console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"..."),c("args"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),c("\n\n  "),t("span",{class:"token function"},"warn"),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"..."),c("args"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"void"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token builtin"},"console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"warn"),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"..."),c("args"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),c("\n"),t("span",{class:"token punctuation"},"}"),c("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br"),t("span",{class:"line-number"},"30"),t("br"),t("span",{class:"line-number"},"31"),t("br"),t("span",{class:"line-number"},"32"),t("br"),t("span",{class:"line-number"},"33"),t("br"),t("span",{class:"line-number"},"34"),t("br"),t("span",{class:"line-number"},"35"),t("br"),t("span",{class:"line-number"},"36"),t("br"),t("span",{class:"line-number"},"37"),t("br"),t("span",{class:"line-number"},"38"),t("br"),t("span",{class:"line-number"},"39"),t("br"),t("span",{class:"line-number"},"40"),t("br"),t("span",{class:"line-number"},"41"),t("br"),t("span",{class:"line-number"},"42"),t("br"),t("span",{class:"line-number"},"43"),t("br"),t("span",{class:"line-number"},"44"),t("br"),t("span",{class:"line-number"},"45"),t("br"),t("span",{class:"line-number"},"46"),t("br"),t("span",{class:"line-number"},"47"),t("br")])],-1),$=t("p",null,"使用",-1),U=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token function"},"defineConsole"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token keyword"},"new"),c(),t("span",{class:"token class-name"},"BasicVmConsole"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br")])],-1),X=t("h3",{id:"实现-settimeout",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#实现-settimeout","aria-hidden":"true"},"#"),c(" 实现 setTimeout")],-1),Y=t("p",null,"基本思路",-1),Z=t("p",null,[t("img",{src:"/assets/f4568d723eb942838d7a068d46f721a1.153f9ace.svg",alt:"基于 quickjs 实现 setTimeout 与 clearTimeout.drawio.svg"})],-1),nn=t("ol",null,[t("li",null,[c("为 vm 注入全局 "),t("code",null,"setTimeout/clearTimeout"),c(" 函数")]),t("li",null,[c("setTimeout "),t("ol",null,[t("li",null,[c("将传过来的 "),t("code",null,"callbackFunc"),c(" 注册为 vm 全局变量")]),t("li",null,[c("在系统层执行 "),t("code",null,"setTimeout")]),t("li",null,[c("将 "),t("code",null,"clearTimeoutId => timeoutId"),c(" 写到 map，返回一个 "),t("code",null,"clearTimeoutId")]),t("li",null,"执行刚刚注册的全局 vm 变量，并清除回调")])]),t("li",null,[c("clearTimeout: 根据 "),t("code",null,"clearTimeoutId"),c(" 在系统层调用真实的 "),t("code",null,"clearTimeout")])],-1),sn=t("blockquote",null,[t("p",null,"不直接返回 setTimeout 返回值的原因在于在 nodejs 中返回值是一个对象而非一个数字，所以需要使用 map 兼容")],-1),an=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" QuickJSVm "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"quickjs-emscripten"'),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" withScope "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"../util/withScope"'),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" VmSetInterval "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"./defineSetInterval"'),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" deleteKey "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"../util/deleteKey"'),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" CallbackIdGenerator "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"@webos/ipc-main"'),t("span",{class:"token punctuation"},";"),c("\n\n"),t("span",{class:"token doc-comment comment"},[c("/**\n * 注入 setTimeout 方法\n * 需要在注入后调用 "),t("span",{class:"token punctuation"},"{"),t("span",{class:"token keyword"},"@link"),c(" defineEventLoop"),t("span",{class:"token punctuation"},"}"),c(" 让 vm 的事件循环跑起来\n * "),t("span",{class:"token keyword"},"@param"),c(),t("span",{class:"token parameter"},"vm"),c("\n */")]),c("\n"),t("span",{class:"token keyword"},"export"),c(),t("span",{class:"token keyword"},"function"),c(),t("span",{class:"token function"},"defineSetTimeout"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token operator"},":"),c(" QuickJSVm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(" VmSetInterval "),t("span",{class:"token punctuation"},"{"),c("\n  "),t("span",{class:"token keyword"},"const"),c(" callbackMap "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token keyword"},"new"),c(),t("span",{class:"token class-name"},[c("Map"),t("span",{class:"token operator"},"<"),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token operator"},">")]),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token keyword"},"function"),c(),t("span",{class:"token function"},"clear"),t("span",{class:"token punctuation"},"("),c("id"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token function"},"withScope"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n      "),t("span",{class:"token function"},"deleteKey"),t("span",{class:"token punctuation"},"("),c("\n        vm"),t("span",{class:"token punctuation"},","),c("\n        vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"unwrapResult"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token template-string"},[t("span",{class:"token template-punctuation string"},"`"),t("span",{class:"token string"},"VM_GLOBAL.setTimeoutCallback"),t("span",{class:"token template-punctuation string"},"`")]),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),c("\n        id\n      "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token function"},"clearInterval"),t("span",{class:"token punctuation"},"("),c("callbackMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"get"),t("span",{class:"token punctuation"},"("),c("id"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    callbackMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"delete"),t("span",{class:"token punctuation"},"("),c("id"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),c("\n  "),t("span",{class:"token function"},"withScope"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token keyword"},"const"),c(" vmGlobal "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"getProp"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),c("global"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"VM_GLOBAL"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token keyword"},"type"),t("span",{class:"token function"},"of"),t("span",{class:"token punctuation"},"("),c("vmGlobal"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"==="),c(),t("span",{class:"token string"},'"undefined"'),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n      "),t("span",{class:"token keyword"},"throw"),c(),t("span",{class:"token keyword"},"new"),c(),t("span",{class:"token class-name"},"Error"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"VM_GLOBAL 不存在，需要先执行 defineVmGlobal"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token punctuation"},"}"),c("\n    vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"setProp"),t("span",{class:"token punctuation"},"("),c("vmGlobal"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"setTimeoutCallback"'),t("span",{class:"token punctuation"},","),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"newObject"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"setProp"),t("span",{class:"token punctuation"},"("),c("\n      vm"),t("span",{class:"token punctuation"},"."),c("global"),t("span",{class:"token punctuation"},","),c("\n      "),t("span",{class:"token string"},'"setTimeout"'),t("span",{class:"token punctuation"},","),c("\n      vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"newFunction"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"setTimeout"'),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("callback"),t("span",{class:"token punctuation"},","),c(" ms"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n        "),t("span",{class:"token keyword"},"const"),c(" id "),t("span",{class:"token operator"},"="),c(" CallbackIdGenerator"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"generate"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token comment"},"//此处已经是异步了，必须再包一层"),c("\n        "),t("span",{class:"token function"},"withScope"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n          "),t("span",{class:"token keyword"},"const"),c(" callbacks "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"unwrapResult"),t("span",{class:"token punctuation"},"("),c("\n            vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"VM_GLOBAL.setTimeoutCallback"'),t("span",{class:"token punctuation"},")"),c("\n          "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n          vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"setProp"),t("span",{class:"token punctuation"},"("),c("callbacks"),t("span",{class:"token punctuation"},","),c(" id"),t("span",{class:"token punctuation"},","),c(" callback"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n          "),t("span",{class:"token comment"},"//此处还是异步的，必须再包一层"),c("\n          "),t("span",{class:"token keyword"},"const"),c(" timeout "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token function"},"setTimeout"),t("span",{class:"token punctuation"},"("),c("\n            "),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c("\n              "),t("span",{class:"token function"},"withScope"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n                "),t("span",{class:"token keyword"},"const"),c(" callbacks "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"unwrapResult"),t("span",{class:"token punctuation"},"("),c("\n                  vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token template-string"},[t("span",{class:"token template-punctuation string"},"`"),t("span",{class:"token string"},"VM_GLOBAL.setTimeoutCallback"),t("span",{class:"token template-punctuation string"},"`")]),t("span",{class:"token punctuation"},")"),c("\n                "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n                "),t("span",{class:"token keyword"},"const"),c(" callback "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"getProp"),t("span",{class:"token punctuation"},"("),c("callbacks"),t("span",{class:"token punctuation"},","),c(" id"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n                vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"callFunction"),t("span",{class:"token punctuation"},"("),c("callback"),t("span",{class:"token punctuation"},","),c(" vm"),t("span",{class:"token punctuation"},"."),c("null"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n                callbackMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"delete"),t("span",{class:"token punctuation"},"("),c("id"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n              "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),c("\n            vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dump"),t("span",{class:"token punctuation"},"("),c("ms"),t("span",{class:"token punctuation"},")"),c("\n          "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n          callbackMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"set"),t("span",{class:"token punctuation"},"("),c("id"),t("span",{class:"token punctuation"},","),c(" timeout"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token keyword"},"return"),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"newString"),t("span",{class:"token punctuation"},"("),c("id"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n      "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),c("\n    "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"setProp"),t("span",{class:"token punctuation"},"("),c("\n      vm"),t("span",{class:"token punctuation"},"."),c("global"),t("span",{class:"token punctuation"},","),c("\n      "),t("span",{class:"token string"},'"clearTimeout"'),t("span",{class:"token punctuation"},","),c("\n      vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"newFunction"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"clearTimeout"'),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("id"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token function"},"clear"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dump"),t("span",{class:"token punctuation"},"("),c("id"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),c("\n    "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n\n  "),t("span",{class:"token keyword"},"return"),c(),t("span",{class:"token punctuation"},"{"),c("\n    callbackMap"),t("span",{class:"token punctuation"},","),c("\n    "),t("span",{class:"token function"},"clear"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n      "),t("span",{class:"token punctuation"},"["),t("span",{class:"token operator"},"..."),c("callbackMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"keys"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),c("clear"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),c("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),c("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br"),t("span",{class:"line-number"},"30"),t("br"),t("span",{class:"line-number"},"31"),t("br"),t("span",{class:"line-number"},"32"),t("br"),t("span",{class:"line-number"},"33"),t("br"),t("span",{class:"line-number"},"34"),t("br"),t("span",{class:"line-number"},"35"),t("br"),t("span",{class:"line-number"},"36"),t("br"),t("span",{class:"line-number"},"37"),t("br"),t("span",{class:"line-number"},"38"),t("br"),t("span",{class:"line-number"},"39"),t("br"),t("span",{class:"line-number"},"40"),t("br"),t("span",{class:"line-number"},"41"),t("br"),t("span",{class:"line-number"},"42"),t("br"),t("span",{class:"line-number"},"43"),t("br"),t("span",{class:"line-number"},"44"),t("br"),t("span",{class:"line-number"},"45"),t("br"),t("span",{class:"line-number"},"46"),t("br"),t("span",{class:"line-number"},"47"),t("br"),t("span",{class:"line-number"},"48"),t("br"),t("span",{class:"line-number"},"49"),t("br"),t("span",{class:"line-number"},"50"),t("br"),t("span",{class:"line-number"},"51"),t("br"),t("span",{class:"line-number"},"52"),t("br"),t("span",{class:"line-number"},"53"),t("br"),t("span",{class:"line-number"},"54"),t("br"),t("span",{class:"line-number"},"55"),t("br"),t("span",{class:"line-number"},"56"),t("br"),t("span",{class:"line-number"},"57"),t("br"),t("span",{class:"line-number"},"58"),t("br"),t("span",{class:"line-number"},"59"),t("br"),t("span",{class:"line-number"},"60"),t("br"),t("span",{class:"line-number"},"61"),t("br"),t("span",{class:"line-number"},"62"),t("br"),t("span",{class:"line-number"},"63"),t("br"),t("span",{class:"line-number"},"64"),t("br"),t("span",{class:"line-number"},"65"),t("br"),t("span",{class:"line-number"},"66"),t("br"),t("span",{class:"line-number"},"67"),t("br"),t("span",{class:"line-number"},"68"),t("br"),t("span",{class:"line-number"},"69"),t("br"),t("span",{class:"line-number"},"70"),t("br"),t("span",{class:"line-number"},"71"),t("br"),t("span",{class:"line-number"},"72"),t("br"),t("span",{class:"line-number"},"73"),t("br")])],-1),tn=t("p",null,"使用",-1),on=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"const"),c(" vmSetTimeout "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token function"},"defineSetTimeout"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token function"},"withScope"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n  vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token template-string"},[t("span",{class:"token template-punctuation string"},"`"),t("span",{class:"token string"},"\n      const begin = Date.now()\n      setInterval(() => {\n        console.log(Date.now() - begin)\n      }, 100)\n    "),t("span",{class:"token template-punctuation string"},"`")]),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\nvmSetTimeout"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"clear"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br")])],-1),cn=t("h3",{id:"实现-setinterval",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#实现-setinterval","aria-hidden":"true"},"#"),c(" 实现 setInterval")],-1),en=t("p",null,"基本上，与实现 setTimeout 流程差不多",-1),pn=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" QuickJSVm "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"quickjs-emscripten"'),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" withScope "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"../util/withScope"'),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" deleteKey "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"../util/deleteKey"'),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" CallbackIdGenerator "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"@webos/ipc-main"'),t("span",{class:"token punctuation"},";"),c("\n\n"),t("span",{class:"token keyword"},"export"),c(),t("span",{class:"token keyword"},"interface"),c(),t("span",{class:"token class-name"},"VmSetInterval"),c(),t("span",{class:"token punctuation"},"{"),c("\n  callbackMap"),t("span",{class:"token operator"},":"),c(" Map"),t("span",{class:"token operator"},"<"),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token operator"},">"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token function"},"clear"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"void"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),c("\n\n"),t("span",{class:"token doc-comment comment"},[c("/**\n * 注入 setInterval 方法\n * 需要在注入后调用 "),t("span",{class:"token punctuation"},"{"),t("span",{class:"token keyword"},"@link"),c(" defineEventLoop"),t("span",{class:"token punctuation"},"}"),c(" 让 vm 的事件循环跑起来\n * "),t("span",{class:"token keyword"},"@param"),c(),t("span",{class:"token parameter"},"vm"),c("\n */")]),c("\n"),t("span",{class:"token keyword"},"export"),c(),t("span",{class:"token keyword"},"function"),c(),t("span",{class:"token function"},"defineSetInterval"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token operator"},":"),c(" QuickJSVm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(" VmSetInterval "),t("span",{class:"token punctuation"},"{"),c("\n  "),t("span",{class:"token keyword"},"const"),c(" callbackMap "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token keyword"},"new"),c(),t("span",{class:"token class-name"},[c("Map"),t("span",{class:"token operator"},"<"),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token operator"},">")]),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token keyword"},"function"),c(),t("span",{class:"token function"},"clear"),t("span",{class:"token punctuation"},"("),c("id"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token function"},"withScope"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n      "),t("span",{class:"token function"},"deleteKey"),t("span",{class:"token punctuation"},"("),c("\n        vm"),t("span",{class:"token punctuation"},","),c("\n        vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"unwrapResult"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token template-string"},[t("span",{class:"token template-punctuation string"},"`"),t("span",{class:"token string"},"VM_GLOBAL.setTimeoutCallback"),t("span",{class:"token template-punctuation string"},"`")]),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),c("\n        id\n      "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token function"},"clearInterval"),t("span",{class:"token punctuation"},"("),c("callbackMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"get"),t("span",{class:"token punctuation"},"("),c("id"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    callbackMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"delete"),t("span",{class:"token punctuation"},"("),c("id"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),c("\n  "),t("span",{class:"token function"},"withScope"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token keyword"},"const"),c(" vmGlobal "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"getProp"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),c("global"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"VM_GLOBAL"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token keyword"},"type"),t("span",{class:"token function"},"of"),t("span",{class:"token punctuation"},"("),c("vmGlobal"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"==="),c(),t("span",{class:"token string"},'"undefined"'),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n      "),t("span",{class:"token keyword"},"throw"),c(),t("span",{class:"token keyword"},"new"),c(),t("span",{class:"token class-name"},"Error"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"VM_GLOBAL 不存在，需要先执行 defineVmGlobal"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token punctuation"},"}"),c("\n    vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"setProp"),t("span",{class:"token punctuation"},"("),c("vmGlobal"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"setIntervalCallback"'),t("span",{class:"token punctuation"},","),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"newObject"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"setProp"),t("span",{class:"token punctuation"},"("),c("\n      vm"),t("span",{class:"token punctuation"},"."),c("global"),t("span",{class:"token punctuation"},","),c("\n      "),t("span",{class:"token string"},'"setInterval"'),t("span",{class:"token punctuation"},","),c("\n      vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"newFunction"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"setInterval"'),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("callback"),t("span",{class:"token punctuation"},","),c(" ms"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n        "),t("span",{class:"token keyword"},"const"),c(" id "),t("span",{class:"token operator"},"="),c(" CallbackIdGenerator"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"generate"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token comment"},"//此处已经是异步了，必须再包一层"),c("\n        "),t("span",{class:"token function"},"withScope"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n          "),t("span",{class:"token keyword"},"const"),c(" callbacks "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"unwrapResult"),t("span",{class:"token punctuation"},"("),c("\n            vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"VM_GLOBAL.setIntervalCallback"'),t("span",{class:"token punctuation"},")"),c("\n          "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n          vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"setProp"),t("span",{class:"token punctuation"},"("),c("callbacks"),t("span",{class:"token punctuation"},","),c(" id"),t("span",{class:"token punctuation"},","),c(" callback"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n          "),t("span",{class:"token keyword"},"const"),c(" interval "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token function"},"setInterval"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n            "),t("span",{class:"token function"},"withScope"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n              vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"callFunction"),t("span",{class:"token punctuation"},"("),c("\n                vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"unwrapResult"),t("span",{class:"token punctuation"},"("),c("\n                  vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token template-string"},[t("span",{class:"token template-punctuation string"},"`"),t("span",{class:"token string"},"VM_GLOBAL.setIntervalCallback['"),t("span",{class:"token interpolation"},[t("span",{class:"token interpolation-punctuation punctuation"},"${"),c("id"),t("span",{class:"token interpolation-punctuation punctuation"},"}")]),t("span",{class:"token string"},"']"),t("span",{class:"token template-punctuation string"},"`")]),t("span",{class:"token punctuation"},")"),c("\n                "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),c("\n                vm"),t("span",{class:"token punctuation"},"."),c("null\n              "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n            "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n          "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dump"),t("span",{class:"token punctuation"},"("),c("ms"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n          callbackMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"set"),t("span",{class:"token punctuation"},"("),c("id"),t("span",{class:"token punctuation"},","),c(" interval"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token keyword"},"return"),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"newString"),t("span",{class:"token punctuation"},"("),c("id"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n      "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),c("\n    "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"setProp"),t("span",{class:"token punctuation"},"("),c("\n      vm"),t("span",{class:"token punctuation"},"."),c("global"),t("span",{class:"token punctuation"},","),c("\n      "),t("span",{class:"token string"},'"clearInterval"'),t("span",{class:"token punctuation"},","),c("\n      vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"newFunction"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"clearInterval"'),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("id"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token function"},"clear"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dump"),t("span",{class:"token punctuation"},"("),c("id"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),c("\n    "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n\n  "),t("span",{class:"token keyword"},"return"),c(),t("span",{class:"token punctuation"},"{"),c("\n    callbackMap"),t("span",{class:"token punctuation"},","),c("\n    "),t("span",{class:"token function"},"clear"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n      "),t("span",{class:"token punctuation"},"["),t("span",{class:"token operator"},"..."),c("callbackMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"keys"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),c("clear"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),c("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),c("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br"),t("span",{class:"line-number"},"30"),t("br"),t("span",{class:"line-number"},"31"),t("br"),t("span",{class:"line-number"},"32"),t("br"),t("span",{class:"line-number"},"33"),t("br"),t("span",{class:"line-number"},"34"),t("br"),t("span",{class:"line-number"},"35"),t("br"),t("span",{class:"line-number"},"36"),t("br"),t("span",{class:"line-number"},"37"),t("br"),t("span",{class:"line-number"},"38"),t("br"),t("span",{class:"line-number"},"39"),t("br"),t("span",{class:"line-number"},"40"),t("br"),t("span",{class:"line-number"},"41"),t("br"),t("span",{class:"line-number"},"42"),t("br"),t("span",{class:"line-number"},"43"),t("br"),t("span",{class:"line-number"},"44"),t("br"),t("span",{class:"line-number"},"45"),t("br"),t("span",{class:"line-number"},"46"),t("br"),t("span",{class:"line-number"},"47"),t("br"),t("span",{class:"line-number"},"48"),t("br"),t("span",{class:"line-number"},"49"),t("br"),t("span",{class:"line-number"},"50"),t("br"),t("span",{class:"line-number"},"51"),t("br"),t("span",{class:"line-number"},"52"),t("br"),t("span",{class:"line-number"},"53"),t("br"),t("span",{class:"line-number"},"54"),t("br"),t("span",{class:"line-number"},"55"),t("br"),t("span",{class:"line-number"},"56"),t("br"),t("span",{class:"line-number"},"57"),t("br"),t("span",{class:"line-number"},"58"),t("br"),t("span",{class:"line-number"},"59"),t("br"),t("span",{class:"line-number"},"60"),t("br"),t("span",{class:"line-number"},"61"),t("br"),t("span",{class:"line-number"},"62"),t("br"),t("span",{class:"line-number"},"63"),t("br"),t("span",{class:"line-number"},"64"),t("br"),t("span",{class:"line-number"},"65"),t("br"),t("span",{class:"line-number"},"66"),t("br"),t("span",{class:"line-number"},"67"),t("br"),t("span",{class:"line-number"},"68"),t("br"),t("span",{class:"line-number"},"69"),t("br"),t("span",{class:"line-number"},"70"),t("br"),t("span",{class:"line-number"},"71"),t("br"),t("span",{class:"line-number"},"72"),t("br"),t("span",{class:"line-number"},"73"),t("br"),t("span",{class:"line-number"},"74"),t("br")])],-1),ln=t("h3",{id:"实现事件循环",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#实现事件循环","aria-hidden":"true"},"#"),c(" 实现事件循环")],-1),un=t("p",null,[c("但有一点麻烦的是，quickjs-emscripten 不会自动执行事件循环，即 Promise 在 resolve 之后不会自动执行下一步。官方提供了 "),t("code",null,"executePendingJobs"),c(" 方法让我们手动执行事件循环，如下所示")],-1),kn=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"const"),c(),t("span",{class:"token punctuation"},"{"),c(" log "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token operator"},"="),c(),t("span",{class:"token function"},"defineMockConsole"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token function"},"withScope"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n  vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token template-string"},[t("span",{class:"token template-punctuation string"},"`"),t("span",{class:"token string"},"Promise.resolve().then(()=>console.log(1))"),t("span",{class:"token template-punctuation string"},"`")]),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token function"},"expect"),t("span",{class:"token punctuation"},"("),c("log"),t("span",{class:"token punctuation"},"."),c("mock"),t("span",{class:"token punctuation"},"."),c("calls"),t("span",{class:"token punctuation"},"."),c("length"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"toBe"),t("span",{class:"token punctuation"},"("),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\nvm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"executePendingJobs"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token function"},"expect"),t("span",{class:"token punctuation"},"("),c("log"),t("span",{class:"token punctuation"},"."),c("mock"),t("span",{class:"token punctuation"},"."),c("calls"),t("span",{class:"token punctuation"},"."),c("length"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"toBe"),t("span",{class:"token punctuation"},"("),t("span",{class:"token number"},"1"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br")])],-1),rn=t("p",null,[c("所以我们实现可以使用一个自动调用 "),t("code",null,"executePendingJobs"),c(" 的函数")],-1),bn=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" QuickJSVm "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"quickjs-emscripten"'),t("span",{class:"token punctuation"},";"),c("\n\n"),t("span",{class:"token keyword"},"export"),c(),t("span",{class:"token keyword"},"interface"),c(),t("span",{class:"token class-name"},"VmEventLoop"),c(),t("span",{class:"token punctuation"},"{"),c("\n  "),t("span",{class:"token function"},"clear"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"void"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),c("\n\n"),t("span",{class:"token doc-comment comment"},[c("/**\n * 定义 vm 中的事件循环机制，尝试循环执行等待的异步操作\n * "),t("span",{class:"token keyword"},"@param"),c(),t("span",{class:"token parameter"},"vm"),c("\n */")]),c("\n"),t("span",{class:"token keyword"},"export"),c(),t("span",{class:"token keyword"},"function"),c(),t("span",{class:"token function"},"defineEventLoop"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token operator"},":"),c(" QuickJSVm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n  "),t("span",{class:"token keyword"},"const"),c(" interval "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token function"},"setInterval"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n    vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"executePendingJobs"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token number"},"100"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token keyword"},"return"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token function"},"clear"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n      "),t("span",{class:"token function"},"clearInterval"),t("span",{class:"token punctuation"},"("),c("interval"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),c("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),c("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br")])],-1),mn=t("p",null,[c("现在只要调用 defineEventLoop 即会循环执行 "),t("code",null,"executePendingJobs"),c(" 函数了")],-1),dn=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"const"),c(),t("span",{class:"token punctuation"},"{"),c(" log "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token operator"},"="),c(),t("span",{class:"token function"},"defineMockConsole"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"const"),c(" eventLoop "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token function"},"defineEventLoop"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"try"),c(),t("span",{class:"token punctuation"},"{"),c("\n  "),t("span",{class:"token function"},"withScope"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n    vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token template-string"},[t("span",{class:"token template-punctuation string"},"`"),t("span",{class:"token string"},"Promise.resolve().then(()=>console.log(1))"),t("span",{class:"token template-punctuation string"},"`")]),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token function"},"expect"),t("span",{class:"token punctuation"},"("),c("log"),t("span",{class:"token punctuation"},"."),c("mock"),t("span",{class:"token punctuation"},"."),c("calls"),t("span",{class:"token punctuation"},"."),c("length"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"toBe"),t("span",{class:"token punctuation"},"("),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token keyword"},"await"),c(),t("span",{class:"token function"},"wait"),t("span",{class:"token punctuation"},"("),t("span",{class:"token number"},"100"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token function"},"expect"),t("span",{class:"token punctuation"},"("),c("log"),t("span",{class:"token punctuation"},"."),c("mock"),t("span",{class:"token punctuation"},"."),c("calls"),t("span",{class:"token punctuation"},"."),c("length"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"toBe"),t("span",{class:"token punctuation"},"("),t("span",{class:"token number"},"1"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"finally"),c(),t("span",{class:"token punctuation"},"{"),c("\n  eventLoop"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"clear"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),c("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br")])],-1),fn=t("h2",{id:"实现沙箱与系统之间的通信",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#实现沙箱与系统之间的通信","aria-hidden":"true"},"#"),c(" 实现沙箱与系统之间的通信")],-1),vn=t("p",null,[c("现在，我们沙箱还欠缺的就是通信机制了，下面我们便实现一个 "),t("code",null,"EventEmiiter"),c("。")],-1),wn=t("p",null,[c("核心是让系统层和沙箱都实现 EventEmitter，quickjs 允许我们向沙箱中注入方法，所以我们可以注入一个 Map 和 "),t("code",null,"emitMain"),c(" 函数。让沙箱既能够向 Map 中注册事件以供系统层调用，也能通过 "),t("code",null,"emitMain"),c(" 向系统层发送事件。")],-1),yn=t("p",null,[t("img",{src:"/assets/ff279700bc3646e68b53ba833dce9a5f.f3fd4baf.svg",alt:"沙箱与系统之间的通信.drawio.svg"})],-1),gn=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" QuickJSHandle"),t("span",{class:"token punctuation"},","),c(" QuickJSVm "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"quickjs-emscripten"'),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" marshal "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"../util/marshal"'),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" withScope "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"../util/withScope"'),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" IEventEmitter "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"@webos/ipc-main"'),t("span",{class:"token punctuation"},";"),c("\n\n"),t("span",{class:"token keyword"},"export"),c(),t("span",{class:"token keyword"},"type"),c(),t("span",{class:"token class-name"},"VmMessageChannel"),c(),t("span",{class:"token operator"},"="),c(" IEventEmitter "),t("span",{class:"token operator"},"&"),c(),t("span",{class:"token punctuation"},"{"),c("\n  listenerMap"),t("span",{class:"token operator"},":"),c(" Map"),t("span",{class:"token operator"},"<"),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),c("msg"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token keyword"},"void"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token operator"},">"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},";"),c("\n\n"),t("span",{class:"token doc-comment comment"},[c("/**\n * 定义消息通信\n * "),t("span",{class:"token keyword"},"@param"),c(),t("span",{class:"token parameter"},"vm"),c("\n */")]),c("\n"),t("span",{class:"token keyword"},"export"),c(),t("span",{class:"token keyword"},"function"),c(),t("span",{class:"token function"},"defineMessageChannel"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token operator"},":"),c(" QuickJSVm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(" VmMessageChannel "),t("span",{class:"token punctuation"},"{"),c("\n  "),t("span",{class:"token keyword"},"const"),c(" res "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token function"},"withScope"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token keyword"},"const"),c(" vmGlobal "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"getProp"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),c("global"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"VM_GLOBAL"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token keyword"},"type"),t("span",{class:"token function"},"of"),t("span",{class:"token punctuation"},"("),c("vmGlobal"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"==="),c(),t("span",{class:"token string"},'"undefined"'),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n      "),t("span",{class:"token keyword"},"throw"),c(),t("span",{class:"token keyword"},"new"),c(),t("span",{class:"token class-name"},"Error"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"VM_GLOBAL 不存在，需要先执行 defineVmGlobal"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token punctuation"},"}"),c("\n    "),t("span",{class:"token keyword"},"const"),c(" listenerMap "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token keyword"},"new"),c(),t("span",{class:"token class-name"},[c("Map"),t("span",{class:"token operator"},"<"),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),c("msg"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>")]),c(),t("span",{class:"token keyword"},"void"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token operator"},">"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token keyword"},"const"),c(" messagePort "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token function"},"marshal"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),c("\n      "),t("span",{class:"token comment"},"//region vm 进程回调函数定义"),c("\n      listenerMap"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"new"),c(),t("span",{class:"token class-name"},"Map"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),c("\n      "),t("span",{class:"token comment"},"//给 vm 进程用的"),c("\n      "),t("span",{class:"token function"},"emitMain"),t("span",{class:"token punctuation"},"("),c("channel"),t("span",{class:"token operator"},":"),c(" QuickJSHandle"),t("span",{class:"token punctuation"},","),c(" msg"),t("span",{class:"token operator"},":"),c(" QuickJSHandle"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n        "),t("span",{class:"token keyword"},"const"),c(" key "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dump"),t("span",{class:"token punctuation"},"("),c("channel"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token keyword"},"const"),c(" value "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dump"),t("span",{class:"token punctuation"},"("),c("msg"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"!"),c("listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"has"),t("span",{class:"token punctuation"},"("),c("key"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n          "),t("span",{class:"token builtin"},"console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"主进程没有监听 api: "'),t("span",{class:"token punctuation"},","),c(" key"),t("span",{class:"token punctuation"},","),c(" value"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n          "),t("span",{class:"token keyword"},"return"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token punctuation"},"}"),c("\n        listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"get"),t("span",{class:"token punctuation"},"("),c("key"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},"!"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),c("fn"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n          "),t("span",{class:"token keyword"},"try"),c(),t("span",{class:"token punctuation"},"{"),c("\n            "),t("span",{class:"token function"},"fn"),t("span",{class:"token punctuation"},"("),c("value"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n          "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"catch"),c(),t("span",{class:"token punctuation"},"("),c("e"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n            "),t("span",{class:"token builtin"},"console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"error"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"执行回调函数发生错误: "'),t("span",{class:"token punctuation"},","),c(" e"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n          "),t("span",{class:"token punctuation"},"}"),c("\n        "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n      "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),c("\n      "),t("span",{class:"token comment"},"//endregion"),c("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"setProp"),t("span",{class:"token punctuation"},"("),c("vmGlobal"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"MessagePort"'),t("span",{class:"token punctuation"},","),c(" messagePort"),t("span",{class:"token punctuation"},"."),c("value"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token comment"},"//给主进程用的"),c("\n    "),t("span",{class:"token keyword"},"function"),c(),t("span",{class:"token function"},"emitVM"),t("span",{class:"token punctuation"},"("),c("channel"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},","),c(" msg"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n      "),t("span",{class:"token function"},"withScope"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n        "),t("span",{class:"token keyword"},"const"),c(" _map "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"unwrapResult"),t("span",{class:"token punctuation"},"("),c("\n          vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"VM_GLOBAL.MessagePort.listenerMap"'),t("span",{class:"token punctuation"},")"),c("\n        "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token keyword"},"const"),c(" _get "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"getProp"),t("span",{class:"token punctuation"},"("),c("_map"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"get"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token keyword"},"const"),c(" _array "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"unwrapResult"),t("span",{class:"token punctuation"},"("),c("\n          vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"callFunction"),t("span",{class:"token punctuation"},"("),c("_get"),t("span",{class:"token punctuation"},","),c(" _map"),t("span",{class:"token punctuation"},","),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"newString"),t("span",{class:"token punctuation"},"("),c("channel"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),c("\n        "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"!"),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dump"),t("span",{class:"token punctuation"},"("),c("_array"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n          "),t("span",{class:"token keyword"},"return"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token punctuation"},"}"),c("\n        "),t("span",{class:"token keyword"},"for"),c(),t("span",{class:"token punctuation"},"("),c("\n          "),t("span",{class:"token keyword"},"let"),c(" i "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},","),c(" length "),t("span",{class:"token operator"},"="),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dump"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"getProp"),t("span",{class:"token punctuation"},"("),c("_array"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token string"},'"length"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n          i "),t("span",{class:"token operator"},"<"),c(" length"),t("span",{class:"token punctuation"},";"),c("\n          i"),t("span",{class:"token operator"},"++"),c("\n        "),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n          vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"callFunction"),t("span",{class:"token punctuation"},"("),c("\n            vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"getProp"),t("span",{class:"token punctuation"},"("),c("_array"),t("span",{class:"token punctuation"},","),c(" vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"newNumber"),t("span",{class:"token punctuation"},"("),c("i"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),c("\n            vm"),t("span",{class:"token punctuation"},"."),c("null"),t("span",{class:"token punctuation"},","),c("\n            "),t("span",{class:"token function"},"marshal"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"("),c("msg"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),c("value\n          "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token punctuation"},"}"),c("\n      "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token punctuation"},"}"),c("\n    "),t("span",{class:"token keyword"},"return"),c(),t("span",{class:"token punctuation"},"{"),c("\n      emit"),t("span",{class:"token operator"},":"),c(" emitVM"),t("span",{class:"token punctuation"},","),c("\n      "),t("span",{class:"token function"},"offByChannel"),t("span",{class:"token punctuation"},"("),c("channel"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"void"),c(),t("span",{class:"token punctuation"},"{"),c("\n        listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"delete"),t("span",{class:"token punctuation"},"("),c("channel"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n      "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),c("\n      "),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),c("channel"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token function-variable function"},"handle"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token punctuation"},"("),c("data"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token keyword"},"void"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"void"),c(),t("span",{class:"token punctuation"},"{"),c("\n        "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"!"),c("listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"has"),t("span",{class:"token punctuation"},"("),c("channel"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n          listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"set"),t("span",{class:"token punctuation"},"("),c("channel"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n        "),t("span",{class:"token punctuation"},"}"),c("\n        listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"get"),t("span",{class:"token punctuation"},"("),c("channel"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},"!"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"push"),t("span",{class:"token punctuation"},"("),c("handle"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n      "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),c("\n      listenerMap"),t("span",{class:"token punctuation"},","),c("\n    "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"as"),c(" VmMessageChannel"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  res"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token keyword"},"return"),c(" res"),t("span",{class:"token punctuation"},"."),c("value"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),c("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br"),t("span",{class:"line-number"},"30"),t("br"),t("span",{class:"line-number"},"31"),t("br"),t("span",{class:"line-number"},"32"),t("br"),t("span",{class:"line-number"},"33"),t("br"),t("span",{class:"line-number"},"34"),t("br"),t("span",{class:"line-number"},"35"),t("br"),t("span",{class:"line-number"},"36"),t("br"),t("span",{class:"line-number"},"37"),t("br"),t("span",{class:"line-number"},"38"),t("br"),t("span",{class:"line-number"},"39"),t("br"),t("span",{class:"line-number"},"40"),t("br"),t("span",{class:"line-number"},"41"),t("br"),t("span",{class:"line-number"},"42"),t("br"),t("span",{class:"line-number"},"43"),t("br"),t("span",{class:"line-number"},"44"),t("br"),t("span",{class:"line-number"},"45"),t("br"),t("span",{class:"line-number"},"46"),t("br"),t("span",{class:"line-number"},"47"),t("br"),t("span",{class:"line-number"},"48"),t("br"),t("span",{class:"line-number"},"49"),t("br"),t("span",{class:"line-number"},"50"),t("br"),t("span",{class:"line-number"},"51"),t("br"),t("span",{class:"line-number"},"52"),t("br"),t("span",{class:"line-number"},"53"),t("br"),t("span",{class:"line-number"},"54"),t("br"),t("span",{class:"line-number"},"55"),t("br"),t("span",{class:"line-number"},"56"),t("br"),t("span",{class:"line-number"},"57"),t("br"),t("span",{class:"line-number"},"58"),t("br"),t("span",{class:"line-number"},"59"),t("br"),t("span",{class:"line-number"},"60"),t("br"),t("span",{class:"line-number"},"61"),t("br"),t("span",{class:"line-number"},"62"),t("br"),t("span",{class:"line-number"},"63"),t("br"),t("span",{class:"line-number"},"64"),t("br"),t("span",{class:"line-number"},"65"),t("br"),t("span",{class:"line-number"},"66"),t("br"),t("span",{class:"line-number"},"67"),t("br"),t("span",{class:"line-number"},"68"),t("br"),t("span",{class:"line-number"},"69"),t("br"),t("span",{class:"line-number"},"70"),t("br"),t("span",{class:"line-number"},"71"),t("br"),t("span",{class:"line-number"},"72"),t("br"),t("span",{class:"line-number"},"73"),t("br"),t("span",{class:"line-number"},"74"),t("br"),t("span",{class:"line-number"},"75"),t("br"),t("span",{class:"line-number"},"76"),t("br"),t("span",{class:"line-number"},"77"),t("br"),t("span",{class:"line-number"},"78"),t("br"),t("span",{class:"line-number"},"79"),t("br"),t("span",{class:"line-number"},"80"),t("br"),t("span",{class:"line-number"},"81"),t("br"),t("span",{class:"line-number"},"82"),t("br"),t("span",{class:"line-number"},"83"),t("br"),t("span",{class:"line-number"},"84"),t("br"),t("span",{class:"line-number"},"85"),t("br")])],-1),hn=t("blockquote",null,[t("p",null,"可以看到，我们除了实现了 IEventEmitter，还额外添加了字段 listenerMap，这主要是希望向上层暴露更多细节，便于在需要的时候（例如清理全部注册的事件）可以直接实现。")],-1),Sn=t("p",null,"使用",-1),Vn=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token function"},"defineVmGlobal"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"const"),c(" messageChannel "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token function"},"defineMessageChannel"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"const"),c(" mockFn "),t("span",{class:"token operator"},"="),c(" jest"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"fn"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\nmessageChannel"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"hello"'),t("span",{class:"token punctuation"},","),c(" mockFn"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token function"},"withScope"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n  vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),t("span",{class:"token template-string"},[t("span",{class:"token template-punctuation string"},"`"),t("span",{class:"token string"},"\nclass QuickJSEventEmitter {\n    emit(channel, data) {\n        VM_GLOBAL.MessagePort.emitMain(channel, data);\n    }\n    on(channel, handle) {\n        if (!VM_GLOBAL.MessagePort.listenerMap.has(channel)) {\n            VM_GLOBAL.MessagePort.listenerMap.set(channel, []);\n        }\n        VM_GLOBAL.MessagePort.listenerMap.get(channel).push(handle);\n    }\n    offByChannel(channel) {\n        VM_GLOBAL.MessagePort.listenerMap.delete(channel);\n    }\n}\n\nconst em = new QuickJSEventEmitter()\nem.emit('hello', 'liuli')\n"),t("span",{class:"token template-punctuation string"},"`")]),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token function"},"expect"),t("span",{class:"token punctuation"},"("),c("mockFn"),t("span",{class:"token punctuation"},"."),c("mock"),t("span",{class:"token punctuation"},"."),c("calls"),t("span",{class:"token punctuation"},"["),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},"["),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"toBe"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"liuli"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\nmessageChannel"),t("span",{class:"token punctuation"},"."),c("listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"clear"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br")])],-1),xn=t("h2",{id:"实现-ijavascriptshadowbox",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#实现-ijavascriptshadowbox","aria-hidden":"true"},"#"),c(" 实现 IJavaScriptShadowbox")],-1),Mn=t("p",null,[c("最终，我们以上实现的功能集合起来，便实现了 "),t("code",null,"IJavaScriptShadowbox")],-1),Cn=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" IJavaScriptShadowbox "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"./IJavaScriptShadowbox"'),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c(" getQuickJS"),t("span",{class:"token punctuation"},","),c(" QuickJS"),t("span",{class:"token punctuation"},","),c(" QuickJSVm "),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"quickjs-emscripten"'),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"import"),c(),t("span",{class:"token punctuation"},"{"),c("\n  BasicVmConsole"),t("span",{class:"token punctuation"},","),c("\n  defineConsole"),t("span",{class:"token punctuation"},","),c("\n  defineEventLoop"),t("span",{class:"token punctuation"},","),c("\n  defineMessageChannel"),t("span",{class:"token punctuation"},","),c("\n  defineSetInterval"),t("span",{class:"token punctuation"},","),c("\n  defineSetTimeout"),t("span",{class:"token punctuation"},","),c("\n  defineVmGlobal"),t("span",{class:"token punctuation"},","),c("\n  VmEventLoop"),t("span",{class:"token punctuation"},","),c("\n  VmMessageChannel"),t("span",{class:"token punctuation"},","),c("\n  VmSetInterval"),t("span",{class:"token punctuation"},","),c("\n  withScope"),t("span",{class:"token punctuation"},","),c("\n"),t("span",{class:"token punctuation"},"}"),c(),t("span",{class:"token keyword"},"from"),c(),t("span",{class:"token string"},'"@webos/quickjs-emscripten-utils"'),t("span",{class:"token punctuation"},";"),c("\n\n"),t("span",{class:"token keyword"},"export"),c(),t("span",{class:"token keyword"},"class"),c(),t("span",{class:"token class-name"},"QuickJSShadowbox"),c(),t("span",{class:"token keyword"},"implements"),c(),t("span",{class:"token class-name"},"IJavaScriptShadowbox"),c(),t("span",{class:"token punctuation"},"{"),c("\n  "),t("span",{class:"token keyword"},"private"),c(" vmMessageChannel"),t("span",{class:"token operator"},":"),c(" VmMessageChannel"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token keyword"},"private"),c(" vmEventLoop"),t("span",{class:"token operator"},":"),c(" VmEventLoop"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token keyword"},"private"),c(" vmSetInterval"),t("span",{class:"token operator"},":"),c(" VmSetInterval"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token keyword"},"private"),c(" vmSetTimeout"),t("span",{class:"token operator"},":"),c(" VmSetInterval"),t("span",{class:"token punctuation"},";"),c("\n\n  "),t("span",{class:"token keyword"},"private"),c(),t("span",{class:"token function"},"constructor"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"readonly"),c(" vm"),t("span",{class:"token operator"},":"),c(" QuickJSVm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token function"},"defineConsole"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token keyword"},"new"),c(),t("span",{class:"token class-name"},"BasicVmConsole"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token function"},"defineVmGlobal"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),c("vmSetTimeout "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token function"},"defineSetTimeout"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),c("vmSetInterval "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token function"},"defineSetInterval"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),c("vmEventLoop "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token function"},"defineEventLoop"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),c("vmMessageChannel "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token function"},"defineMessageChannel"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),c("\n\n  "),t("span",{class:"token function"},"destroy"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"void"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),c("vmMessageChannel"),t("span",{class:"token punctuation"},"."),c("listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"clear"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),c("vmEventLoop"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"clear"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),c("vmSetInterval"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"clear"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),c("vmSetTimeout"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"clear"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),c("\n\n  "),t("span",{class:"token function"},"eval"),t("span",{class:"token punctuation"},"("),c("code"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"void"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token function"},"withScope"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),c("vm"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n      vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"unwrapResult"),t("span",{class:"token punctuation"},"("),c("vm"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"evalCode"),t("span",{class:"token punctuation"},"("),c("code"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"dispose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),c("\n\n  "),t("span",{class:"token function"},"emit"),t("span",{class:"token punctuation"},"("),c("channel"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},","),c(" data"),t("span",{class:"token operator"},"?"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"void"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),c("vmMessageChannel"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"emit"),t("span",{class:"token punctuation"},"("),c("channel"),t("span",{class:"token punctuation"},","),c(" data"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),c("\n\n  "),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),c("channel"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token function-variable function"},"handle"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token punctuation"},"("),c("data"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token keyword"},"void"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token keyword"},"void"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),c("vmMessageChannel"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),c("channel"),t("span",{class:"token punctuation"},","),c(" handle"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),c("\n\n  "),t("span",{class:"token function"},"offByChannel"),t("span",{class:"token punctuation"},"("),c("channel"),t("span",{class:"token operator"},":"),c(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),c("vmMessageChannel"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"offByChannel"),t("span",{class:"token punctuation"},"("),c("channel"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),c("\n\n  "),t("span",{class:"token keyword"},"private"),c(),t("span",{class:"token keyword"},"static"),c(" quickJS"),t("span",{class:"token operator"},":"),c(" QuickJS"),t("span",{class:"token punctuation"},";"),c("\n\n  "),t("span",{class:"token keyword"},"static"),c(),t("span",{class:"token keyword"},"async"),c(),t("span",{class:"token function"},"create"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n    "),t("span",{class:"token keyword"},"if"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"!"),c("QuickJSShadowbox"),t("span",{class:"token punctuation"},"."),c("quickJS"),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n      QuickJSShadowbox"),t("span",{class:"token punctuation"},"."),c("quickJS "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token keyword"},"await"),c(),t("span",{class:"token function"},"getQuickJS"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n    "),t("span",{class:"token punctuation"},"}"),c("\n    "),t("span",{class:"token keyword"},"return"),c(),t("span",{class:"token keyword"},"new"),c(),t("span",{class:"token class-name"},"QuickJSShadowbox"),t("span",{class:"token punctuation"},"("),c("QuickJSShadowbox"),t("span",{class:"token punctuation"},"."),c("quickJS"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"createVm"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),c("\n\n  "),t("span",{class:"token keyword"},"static"),c(),t("span",{class:"token function"},"destroy"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token punctuation"},"{"),c("\n    QuickJSShadowbox"),t("span",{class:"token punctuation"},"."),c("quickJS "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token keyword"},"null"),c(),t("span",{class:"token keyword"},"as"),c(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},";"),c("\n  "),t("span",{class:"token punctuation"},"}"),c("\n"),t("span",{class:"token punctuation"},"}"),c("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br"),t("span",{class:"line-number"},"30"),t("br"),t("span",{class:"line-number"},"31"),t("br"),t("span",{class:"line-number"},"32"),t("br"),t("span",{class:"line-number"},"33"),t("br"),t("span",{class:"line-number"},"34"),t("br"),t("span",{class:"line-number"},"35"),t("br"),t("span",{class:"line-number"},"36"),t("br"),t("span",{class:"line-number"},"37"),t("br"),t("span",{class:"line-number"},"38"),t("br"),t("span",{class:"line-number"},"39"),t("br"),t("span",{class:"line-number"},"40"),t("br"),t("span",{class:"line-number"},"41"),t("br"),t("span",{class:"line-number"},"42"),t("br"),t("span",{class:"line-number"},"43"),t("br"),t("span",{class:"line-number"},"44"),t("br"),t("span",{class:"line-number"},"45"),t("br"),t("span",{class:"line-number"},"46"),t("br"),t("span",{class:"line-number"},"47"),t("br"),t("span",{class:"line-number"},"48"),t("br"),t("span",{class:"line-number"},"49"),t("br"),t("span",{class:"line-number"},"50"),t("br"),t("span",{class:"line-number"},"51"),t("br"),t("span",{class:"line-number"},"52"),t("br"),t("span",{class:"line-number"},"53"),t("br"),t("span",{class:"line-number"},"54"),t("br"),t("span",{class:"line-number"},"55"),t("br"),t("span",{class:"line-number"},"56"),t("br"),t("span",{class:"line-number"},"57"),t("br"),t("span",{class:"line-number"},"58"),t("br"),t("span",{class:"line-number"},"59"),t("br"),t("span",{class:"line-number"},"60"),t("br"),t("span",{class:"line-number"},"61"),t("br"),t("span",{class:"line-number"},"62"),t("br"),t("span",{class:"line-number"},"63"),t("br"),t("span",{class:"line-number"},"64"),t("br"),t("span",{class:"line-number"},"65"),t("br"),t("span",{class:"line-number"},"66"),t("br"),t("span",{class:"line-number"},"67"),t("br"),t("span",{class:"line-number"},"68"),t("br"),t("span",{class:"line-number"},"69"),t("br"),t("span",{class:"line-number"},"70"),t("br")])],-1),Jn=t("p",null,"在系统层使用",-1),_n=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"const"),c(" shadowbox "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token keyword"},"await"),c(" QuickJSShadowbox"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"create"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token keyword"},"const"),c(" mockConsole "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token function"},"defineMockConsole"),t("span",{class:"token punctuation"},"("),c("shadowbox"),t("span",{class:"token punctuation"},"."),c("vm"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\nshadowbox"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"eval"),t("span",{class:"token punctuation"},"("),c("code"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\nshadowbox"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"emit"),t("span",{class:"token punctuation"},"("),c("AppChannelEnum"),t("span",{class:"token punctuation"},"."),c("Open"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token function"},"expect"),t("span",{class:"token punctuation"},"("),c("mockConsole"),t("span",{class:"token punctuation"},"."),c("log"),t("span",{class:"token punctuation"},"."),c("mock"),t("span",{class:"token punctuation"},"."),c("calls"),t("span",{class:"token punctuation"},"["),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},"["),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"toBe"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"open"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\nshadowbox"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"emit"),t("span",{class:"token punctuation"},"("),c("WindowChannelEnum"),t("span",{class:"token punctuation"},"."),c("AllClose"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token function"},"expect"),t("span",{class:"token punctuation"},"("),c("mockConsole"),t("span",{class:"token punctuation"},"."),c("log"),t("span",{class:"token punctuation"},"."),c("mock"),t("span",{class:"token punctuation"},"."),c("calls"),t("span",{class:"token punctuation"},"["),t("span",{class:"token number"},"1"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},"["),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"toBe"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"all close"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\nshadowbox"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"destroy"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br")])],-1),In=t("p",null,"在沙箱使用",-1),Ln=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"const"),c(" eventEmitter "),t("span",{class:"token operator"},"="),c(),t("span",{class:"token keyword"},"new"),c(),t("span",{class:"token class-name"},"QuickJSEventEmitter"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\neventEmitter"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),c("AppChannelEnum"),t("span",{class:"token punctuation"},"."),c("Open"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token keyword"},"async"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n  "),t("span",{class:"token builtin"},"console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"open"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\neventEmitter"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),c("WindowChannelEnum"),t("span",{class:"token punctuation"},"."),c("AllClose"),t("span",{class:"token punctuation"},","),c(),t("span",{class:"token keyword"},"async"),c(),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),c(),t("span",{class:"token operator"},"=>"),c(),t("span",{class:"token punctuation"},"{"),c("\n  "),t("span",{class:"token builtin"},"console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"all close"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),c("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br")])],-1),En=t("h2",{id:"目前-quickjs-沙箱的限制",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#目前-quickjs-沙箱的限制","aria-hidden":"true"},"#"),c(" 目前 quickjs 沙箱的限制")],-1),Pn=t("p",null,"下面是目前实现的一些限制，也是以后可以继续改进的点",-1),Qn=t("ul",null,[t("li",null,[t("code",null,"console"),c(" 仅支持常见的 "),t("code",null,"log/info/warn/error"),c(" 方法")]),t("li",null,[t("code",null,"setTimeout/setInterval"),c(" 事件循环时间没有保证，目前大约在 100ms 调用一次")]),t("li",null,"无法使用 chrome devtool 调试，也不会处理 sourcemap（figma 至今的开发体验仍然如此，后面可能添加开关支持在 web worker 中调试）"),t("li",null,"vm 中出现错误不会将错误抛出来并打印在控制台"),t("li",null,[c("各个 api 调用的顺序与清理顺序必须手动保证是相反的，例如 vm 创建必须在 "),t("code",null,"defineSetTimeout"),c(" 之前，而 "),t("code",null,"defineSetTimeout"),c(" 的清理函数调用必须在 "),t("code",null,"vm.dispose"),c(" 之前")]),t("li",null,[c("不能在 "),t("code",null,"messageChannel.on"),c(" 回调中同步调用 "),t("code",null,"vm.dispose"),c("，因为是同步调用的")])],-1);e.render=function(c,e){const jn=n("OutboundLink");return s(),a(o,null,[p,l,t("p",null,[u,t("a",i,[k,t(jn)]),r]),b,m,d,t("p",null,[f,v,w,t("a",y,[g,t(jn)]),h]),S,V,x,M,C,J,_,I,L,E,P,Q,j,B,T,H,t("p",null,[G,t("a",q,[A,t(jn)]),O]),F,R,N,D,K,W,z,$,U,X,Y,Z,nn,sn,an,tn,on,cn,en,pn,ln,un,kn,rn,bn,mn,dn,fn,vn,wn,yn,gn,hn,Sn,Vn,xn,Mn,Cn,Jn,_n,In,Ln,En,Pn,Qn],64)};export{e as default};
