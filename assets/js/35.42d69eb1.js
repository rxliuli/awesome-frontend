(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{418:function(t,e,a){"use strict";a.r(e);var r=a(44),s=Object(r.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#场景"}},[t._v("#")]),t._v(" 场景")]),t._v(" "),a("blockquote",[a("p",[a("a",{attrs:{href:"https://www.npmjs.com/package/gh-pages",target:"_blank",rel:"noopener noreferrer"}},[t._v("gh-pages"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("之前就有在使用 gh-pages 这个库，但由于名字并未想到它如此强大，甚至支持发布代码到任意 git 仓库。换言之，它可以将任意本地文件发布到远端 git 仓库，而不需要自己处理各种乱七八糟的问题。")]),t._v(" "),a("h2",{attrs:{id:"问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[t._v("#")]),t._v(" 问题")]),t._v(" "),a("p",[t._v("首先说一下我们之前前后端分离项目的发布流程")]),t._v(" "),a("ol",[a("li",[t._v("修改打包的 webpack 脚本以支持引用 cdn 上的资源（本质上是修改路径）")]),t._v(" "),a("li",[t._v("打包静态资源文件")]),t._v(" "),a("li",[t._v("找到前端静态资源发布项目，切换到指定分支")]),t._v(" "),a("li",[t._v("复制静态资源到特定目录")]),t._v(" "),a("li",[a("code",[t._v("git commit && git push")])]),t._v(" "),a("li",[t._v("如果要发布 cdn 则再次对 cdn 仓库同样如此操作")]),t._v(" "),a("li",[t._v("通知后端发布生产环境，进行验证")])]),t._v(" "),a("p",[t._v("这其中涉及到几个重要痛点")]),t._v(" "),a("ol",[a("li",[t._v("修改 webpack 配置，它极高的复杂度甚至产生了 "),a("a",{attrs:{href:"https://www.zhihu.com/question/267908710",target:"_blank",rel:"noopener noreferrer"}},[t._v("webpack 配置工程师"),a("OutboundLink")],1),t._v(" 这一职业岗位。")]),t._v(" "),a("li",[t._v("处理文件复制提交 git 信息，有可能操作错误，每次发布生产都是一次心理上的考验")]),t._v(" "),a("li",[t._v("发布失败难以快速解决，重新发布又需要手动再走一遍流程，所以有了我之前说过的发布一次要半个钟的事实")])]),t._v(" "),a("h2",{attrs:{id:"解决"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决"}},[t._v("#")]),t._v(" 解决")]),t._v(" "),a("p",[t._v("不难看出，这本质上还是因为发布没有自动化带来的问题。但是，在 DevOps 还不存在的情况下，gh-pages 能够自动化下面的两步，同时，像 "),a("code",[t._v("create-react-app/vue-cli")]),t._v(" 这种基于 webpack 进行高层次封装的工具提供了 "),a("code",[t._v("PUBLIC_PATH")]),t._v(" 的概念，能够通过环境变量指定 "),a("code",[t._v("index.html")]),t._v(" 入口引用的其他静态资源的基本路径，即便不去碰 webpack 也可以处理第一个问题了。")]),t._v(" "),a("blockquote",[a("p",[a("a",{attrs:{href:"https://create-react-app.dev/docs/using-the-public-folder/",target:"_blank",rel:"noopener noreferrer"}},[t._v("react"),a("OutboundLink")],1),t._v(", "),a("a",{attrs:{href:"https://cli.vuejs.org/zh/config/#publicpath",target:"_blank",rel:"noopener noreferrer"}},[t._v("vue"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("大致过程如下")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("在项目中添加依赖 "),a("code",[t._v("yarn add -D env-cmd gh-pages")])])]),t._v(" "),a("li",[a("p",[t._v("在打包生产环境的资源时指定环境变量 "),a("code",[t._v("PUBLIC_URL=[cdn 发布后的远端基本路径]")])])]),t._v(" "),a("li",[a("p",[t._v("添加发布 script 命令")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"deploy"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"yarn build:prod && yarn deploy:cdn && yarn deploy:publish"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"deploy:publish"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"gh-pages -d [本地目录] -e [远端 git 目录] -r [远端 git 地址] -b [远端 git 分支]"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"deploy:cdn"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"gh-pages -d [本地目录] -e [远端 git 目录] -r [远端 git 地址] -b [远端 git 分支]"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])])]),t._v(" "),a("p",[t._v("现在，发布生产环境只需要两个步骤")]),t._v(" "),a("ol",[a("li",[t._v("运行 "),a("code",[t._v("deploy")]),t._v(" 命令")]),t._v(" "),a("li",[t._v("通知后端发布 cdn/静态资源目录")])]),t._v(" "),a("p",[t._v("虽然仍未能解决前后端不分离的项目，但，至少解决了所有新项目的发布问题了，不是么？")]),t._v(" "),a("blockquote",[a("p",[t._v("这里有一个项目已经如此实现，可以进行参考："),a("a",{attrs:{href:"https://git.code.tencent.com/bingli_front/website-static",target:"_blank",rel:"noopener noreferrer"}},[t._v("website-static"),a("OutboundLink")],1)])]),t._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("p",[t._v("还是需要擅用工具，如果能够掌握更好的工具，效率的提高和自己的痛苦程度都能有极大的改善！")])])}),[],!1,null,null,null);e.default=s.exports}}]);