import{r as n,o as s,c as a,a as t,F as e,b as o}from"./app.b503e00a.js";const l={},p=t("h2",{id:"问题",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#问题","aria-hidden":"true"},"#"),o(" 问题")],-1),c=t("p",null,"兼容问题是由于使用了平台特定的功能导致，会导致下面几种情况",-1),r=t("ul",null,[t("li",null,"不同的模块化规范：rollup 打包时指定"),t("li",null,"平台限定的代码：例如包含不同平台的适配代码"),t("li",null,[o("平台限定的依赖：例如在 nodejs 需要填充 "),t("code",null,"fetch/FormData")]),t("li",null,[o("平台限定的类型定义：例如浏览器中的 "),t("code",null,"Blob"),o(" 和 nodejs 中的 "),t("code",null,"Buffer")])],-1),u=t("h2",{id:"不同的模块化规范",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#不同的模块化规范","aria-hidden":"true"},"#"),o(" 不同的模块化规范")],-1),i=t("p",null,"这是很常见的一件事，现在就已经有包括 cjs/amd/iife/umd/esm 多种规范了，所以支持它们（或者说，至少支持主流的 cjs/esm）也成为必须做的一件事。幸运的是，打包工具 rollup 提供了相应的配置支持不同格式的输出文件。",-1),k={href:"https://github.com/rxliuli/cross-platform-lib-demo/tree/master/apps/multiple-module-format",target:"_blank",rel:"noopener noreferrer"},d=o("GitHub 示例项目"),b=t("p",null,"形如",-1),m=t("div",{class:"language-javascript ext-js line-numbers-mode"},[t("pre",{class:"language-javascript"},[t("code",null,[t("span",{class:"token comment"},"// rollup.config.js"),o("\n"),t("span",{class:"token keyword"},"export"),o(),t("span",{class:"token keyword"},"default"),o(),t("span",{class:"token function"},"defineConfig"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),o("\n  input"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"src/index.ts"'),t("span",{class:"token punctuation"},","),o("\n  output"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token punctuation"},"["),o("\n    "),t("span",{class:"token punctuation"},"{"),o(" format"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"cjs"'),t("span",{class:"token punctuation"},","),o(" file"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"dist/index.js"'),t("span",{class:"token punctuation"},","),o(" sourcemap"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token boolean"},"true"),o(),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),o("\n    "),t("span",{class:"token punctuation"},"{"),o(" format"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"esm"'),t("span",{class:"token punctuation"},","),o(" file"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"dist/index.esm.js"'),t("span",{class:"token punctuation"},","),o(" sourcemap"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token boolean"},"true"),o(),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),o("\n  "),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},","),o("\n  plugins"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token punctuation"},"["),t("span",{class:"token function"},"typescript"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},","),o("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br")])],-1),f=t("p",null,"然后在 package.json 中指定即可",-1),g=t("div",{class:"language-json ext-json line-numbers-mode"},[t("pre",{class:"language-json"},[t("code",null,[t("span",{class:"token punctuation"},"{"),o("\n  "),t("span",{class:"token property"},'"main"'),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"dist/index.js"'),t("span",{class:"token punctuation"},","),o("\n  "),t("span",{class:"token property"},'"module"'),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"dist/index.esm.js"'),t("span",{class:"token punctuation"},","),o("\n  "),t("span",{class:"token property"},'"types"'),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"dist/index.d.ts"'),o("\n"),t("span",{class:"token punctuation"},"}"),o("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br")])],-1),y=o("许多库都支持 cjs/esm，例如 "),w={href:"https://github.com/rollup/rollup/blob/master/package.json",target:"_blank",rel:"noopener noreferrer"},h=o("rollup"),j=o("，但也有仅支持 esm 的库，例如 "),x={href:"https://github.com/unifiedjs",target:"_blank",rel:"noopener noreferrer"},v=o("unified.js 系列"),A=t("h2",{id:"平台限定的代码",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#平台限定的代码","aria-hidden":"true"},"#"),o(" 平台限定的代码")],-1),B=t("ul",null,[t("li",null,[o("通过不同的入口文件打包不同的出口文件，并通过 "),t("code",null,"browser"),o(" 指定环境相关的代码，例如 "),t("code",null,"dist/browser.js"),o("/"),t("code",null,"dist/node.js"),o("：使用时需要注意打包工具（将成本转嫁给使用者）")]),t("li",null,"使用代码判断运行环境动态加载")],-1),T=t("table",null,[t("thead",null,[t("tr",null,[t("th",null,"对比"),t("th",null,"不同出口"),t("th",null,"代码判断")])]),t("tbody",null,[t("tr",null,[t("td",null,"优点"),t("td",null,"代码隔离的更彻底"),t("td",null,"不依赖于打包工具行为")]),t("tr",null,[t("td"),t("td",null,"最终代码仅包含当前环境的代码"),t("td")]),t("tr",null,[t("td",null,"缺点"),t("td",null,"依赖于使用者的打包工具的行为"),t("td",null,"判断环境的代码可能并不准确")]),t("tr",null,[t("td"),t("td"),t("td",null,"最终代码包含所有代码，只是选择性加载")])])],-1),q=o("axios 结合以上两种方式实现了浏览器、nodejs 支持，但同时导致有着两种方式的缺点而且有点迷惑行为，参考 "),_={href:"https://github.com/axios/axios/blob/e9965bfafc82d8b42765705061b9ebe2d5532493/dist/axios.js#L872-L882",target:"_blank",rel:"noopener noreferrer"},C=o("getDefaultAdapter"),H=o("。例如在 jsdom 环境会认为是浏览器环境，参考 "),G={href:"https://github.com/axios/axios/issues/1180",target:"_blank",rel:"noopener noreferrer"},N=o("detect jest and use http adapter instead of XMLHTTPRequest"),P=t("h3",{id:"通过不同的入口文件打包不同的出口文件",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#通过不同的入口文件打包不同的出口文件","aria-hidden":"true"},"#"),o(" 通过不同的入口文件打包不同的出口文件")],-1),V={href:"https://github.com/rxliuli/cross-platform-lib-demo/tree/master/apps/platform-specific-code-multiple-bundle",target:"_blank",rel:"noopener noreferrer"},D=o("GitHub 示例项目"),L=t("div",{class:"language-javascript ext-js line-numbers-mode"},[t("pre",{class:"language-javascript"},[t("code",null,[t("span",{class:"token comment"},"// rollup.config.js"),o("\n"),t("span",{class:"token keyword"},"export"),o(),t("span",{class:"token keyword"},"default"),o(),t("span",{class:"token function"},"defineConfig"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),o("\n  input"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token punctuation"},"["),t("span",{class:"token string"},'"src/index.ts"'),t("span",{class:"token punctuation"},","),o(),t("span",{class:"token string"},'"src/browser.ts"'),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},","),o("\n  output"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token punctuation"},"["),o("\n    "),t("span",{class:"token punctuation"},"{"),o(" dir"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"dist/cjs"'),t("span",{class:"token punctuation"},","),o(" format"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"cjs"'),t("span",{class:"token punctuation"},","),o(" sourcemap"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token boolean"},"true"),o(),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),o("\n    "),t("span",{class:"token punctuation"},"{"),o(" dir"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"dist/esm"'),t("span",{class:"token punctuation"},","),o(" format"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"esm"'),t("span",{class:"token punctuation"},","),o(" sourcemap"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token boolean"},"true"),o(),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),o("\n  "),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},","),o("\n  plugins"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token punctuation"},"["),t("span",{class:"token function"},"typescript"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},","),o("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br")])],-1),R=t("div",{class:"language-json ext-json line-numbers-mode"},[t("pre",{class:"language-json"},[t("code",null,[t("span",{class:"token punctuation"},"{"),o("\n  "),t("span",{class:"token property"},'"main"'),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"dist/cjs/index.js"'),t("span",{class:"token punctuation"},","),o("\n  "),t("span",{class:"token property"},'"module"'),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"dist/esm/index.js"'),t("span",{class:"token punctuation"},","),o("\n  "),t("span",{class:"token property"},'"types"'),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"dist/index.d.ts"'),t("span",{class:"token punctuation"},","),o("\n  "),t("span",{class:"token property"},'"browser"'),t("span",{class:"token operator"},":"),o(),t("span",{class:"token punctuation"},"{"),o("\n    "),t("span",{class:"token property"},'"dist/cjs/index.js"'),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"dist/cjs/browser.js"'),t("span",{class:"token punctuation"},","),o("\n    "),t("span",{class:"token property"},'"dist/esm/index.js"'),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"dist/esm/browser.js"'),o("\n  "),t("span",{class:"token punctuation"},"}"),o("\n"),t("span",{class:"token punctuation"},"}"),o("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br")])],-1),F=t("h3",{id:"使用代码判断运行环境动态加载",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#使用代码判断运行环境动态加载","aria-hidden":"true"},"#"),o(" 使用代码判断运行环境动态加载")],-1),E={href:"https://github.com/rxliuli/cross-platform-lib-demo/tree/master/apps/platform-specific-code-dynamic-judgment",target:"_blank",rel:"noopener noreferrer"},I=o("GitHub 示例项目"),M=t("p",null,[o("基本上就是在代码中判断然后 "),t("code",null,"await import"),o(" 而已")],-1),O=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"import"),o(),t("span",{class:"token punctuation"},"{"),o(" BaseAdapter "),t("span",{class:"token punctuation"},"}"),o(),t("span",{class:"token keyword"},"from"),o(),t("span",{class:"token string"},'"./adapters/BaseAdapter"'),t("span",{class:"token punctuation"},";"),o("\n"),t("span",{class:"token keyword"},"import"),o(),t("span",{class:"token punctuation"},"{"),o(" Class "),t("span",{class:"token punctuation"},"}"),o(),t("span",{class:"token keyword"},"from"),o(),t("span",{class:"token string"},'"type-fest"'),t("span",{class:"token punctuation"},";"),o("\n\n"),t("span",{class:"token keyword"},"export"),o(),t("span",{class:"token keyword"},"class"),o(),t("span",{class:"token class-name"},"Adapter"),o(),t("span",{class:"token keyword"},"implements"),o(),t("span",{class:"token class-name"},"BaseAdapter"),o(),t("span",{class:"token punctuation"},"{"),o("\n  "),t("span",{class:"token keyword"},"private"),o(" adapter"),t("span",{class:"token operator"},"?"),t("span",{class:"token operator"},":"),o(" BaseAdapter"),t("span",{class:"token punctuation"},";"),o("\n  "),t("span",{class:"token keyword"},"private"),o(),t("span",{class:"token keyword"},"async"),o(),t("span",{class:"token function"},"init"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token punctuation"},"{"),o("\n    "),t("span",{class:"token keyword"},"if"),o(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),o("adapter"),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token punctuation"},"{"),o("\n      "),t("span",{class:"token keyword"},"return"),t("span",{class:"token punctuation"},";"),o("\n    "),t("span",{class:"token punctuation"},"}"),o("\n    "),t("span",{class:"token keyword"},"let"),o(" Adapter"),t("span",{class:"token operator"},":"),o(" Class"),t("span",{class:"token operator"},"<"),o("BaseAdapter"),t("span",{class:"token operator"},">"),t("span",{class:"token punctuation"},";"),o("\n    "),t("span",{class:"token keyword"},"if"),o(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),o(" fetch "),t("span",{class:"token operator"},"==="),o(),t("span",{class:"token string"},'"undefined"'),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token punctuation"},"{"),o("\n      Adapter "),t("span",{class:"token operator"},"="),o(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"await"),o(),t("span",{class:"token keyword"},"import"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"./adapters/NodeAdapter"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),o("NodeAdapter"),t("span",{class:"token punctuation"},";"),o("\n    "),t("span",{class:"token punctuation"},"}"),o(),t("span",{class:"token keyword"},"else"),o(),t("span",{class:"token punctuation"},"{"),o("\n      Adapter "),t("span",{class:"token operator"},"="),o(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"await"),o(),t("span",{class:"token keyword"},"import"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"./adapters/BrowserAdapter"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),o("BrowserAdapter"),t("span",{class:"token punctuation"},";"),o("\n    "),t("span",{class:"token punctuation"},"}"),o("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),o("adapter "),t("span",{class:"token operator"},"="),o(),t("span",{class:"token keyword"},"new"),o(),t("span",{class:"token class-name"},"Adapter"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n  "),t("span",{class:"token punctuation"},"}"),o("\n  "),t("span",{class:"token keyword"},"async"),o(),t("span",{class:"token generic-function"},[t("span",{class:"token function"},"get"),t("span",{class:"token generic class-name"},[t("span",{class:"token operator"},"<"),t("span",{class:"token constant"},"T"),t("span",{class:"token operator"},">")])]),t("span",{class:"token punctuation"},"("),o("url"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token builtin"},"Promise"),t("span",{class:"token operator"},"<"),t("span",{class:"token constant"},"T"),t("span",{class:"token operator"},">"),o(),t("span",{class:"token punctuation"},"{"),o("\n    "),t("span",{class:"token keyword"},"await"),o(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"init"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n    "),t("span",{class:"token keyword"},"return"),o(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),o("adapter"),t("span",{class:"token operator"},"!"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"get"),t("span",{class:"token punctuation"},"("),o("url"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n  "),t("span",{class:"token punctuation"},"}"),o("\n"),t("span",{class:"token punctuation"},"}"),o("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br")])],-1),X=t("div",{class:"language-javascript ext-js line-numbers-mode"},[t("pre",{class:"language-javascript"},[t("code",null,[t("span",{class:"token comment"},"// rollup.config.js"),o("\n"),t("span",{class:"token keyword"},"export"),o(),t("span",{class:"token keyword"},"default"),o(),t("span",{class:"token function"},"defineConfig"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),o("\n  input"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"src/index.ts"'),t("span",{class:"token punctuation"},","),o("\n  output"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token punctuation"},"{"),o(" dir"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"dist"'),t("span",{class:"token punctuation"},","),o(" format"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"cjs"'),t("span",{class:"token punctuation"},","),o(" sourcemap"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token boolean"},"true"),o(),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),o("\n  plugins"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token punctuation"},"["),t("span",{class:"token function"},"typescript"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},","),o("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br")])],-1),z=o("注: vitejs 无法捆绑处理这种包，因为 nodejs 原生包在浏览器环境确实不存在，这是一个已知错误，参考："),J={href:"https://github.com/aws-amplify/amplify-js/issues/7499",target:"_blank",rel:"noopener noreferrer"},K=o("Cannot use amplify-js in browser environment (breaking vite/snowpack/esbuild)"),Q=o("。"),S=t("h2",{id:"平台限定的依赖",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#平台限定的依赖","aria-hidden":"true"},"#"),o(" 平台限定的依赖")],-1),U=t("ul",null,[t("li",null,[o("直接 "),t("code",null,"import"),o(" 依赖使用：会导致在不同的环境炸掉（例如 "),t("code",null,"node-fetch"),o(" 在浏览器就会炸掉）")]),t("li",null,[o("在代码中判断运行时通过 "),t("code",null,"require"),o(" 动态 引入依赖：会导致即便用不到，也仍然会被打包加载")]),t("li",null,[o("在代码中判断运行时通过 "),t("code",null,"import()"),o(" 动态引入依赖：会导致代码分割，依赖作为单独的文件选择性加载")]),t("li",null,[o("通过不同的入口文件打包不同的出口文件，例如 "),t("code",null,"dist/browser.js"),o("/"),t("code",null,"dist/node.js"),o("：使用时需要注意（将成本转嫁给使用者）")]),t("li",null,[o("声明 "),t("code",null,"peerDependencies"),o(" 可选依赖，让使用者自行填充：使用时需要注意（将成本转嫁给使用者）")])],-1),W=t("table",null,[t("thead",null,[t("tr",null,[t("th",null,"对比"),t("th",null,"require"),t("th",null,"import")])]),t("tbody",null,[t("tr",null,[t("td",null,"是否一定会加载"),t("td",null,"是"),t("td",null,"否")]),t("tr",null,[t("td",null,"是否需要开发者注意"),t("td",null,"否"),t("td",null,"否")]),t("tr",null,[t("td",null,"是否会多次加载"),t("td",null,"否"),t("td",null,"是")]),t("tr",null,[t("td",null,"是否同步"),t("td",null,"是"),t("td",null,"否")]),t("tr",null,[t("td",null,"rollup 支持"),t("td",null,"是"),t("td",null,"是")])])],-1),Y=t("h2",{id:"在代码中判断运行时通过-require-动态引入依赖",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#在代码中判断运行时通过-require-动态引入依赖","aria-hidden":"true"},"#"),o(" 在代码中判断运行时通过 "),t("code",null,"require"),o(" 动态引入依赖")],-1),Z={href:"https://github.com/rxliuli/cross-platform-lib-demo/tree/master/apps/platform-specific-lib-require",target:"_blank",rel:"noopener noreferrer"},$=o("GitHub 项目示例"),nn=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token comment"},"// src/adapters/BaseAdapter.ts"),o("\n"),t("span",{class:"token keyword"},"import"),o(),t("span",{class:"token punctuation"},"{"),o(" BaseAdapter "),t("span",{class:"token punctuation"},"}"),o(),t("span",{class:"token keyword"},"from"),o(),t("span",{class:"token string"},'"./BaseAdapter"'),t("span",{class:"token punctuation"},";"),o("\n\n"),t("span",{class:"token keyword"},"export"),o(),t("span",{class:"token keyword"},"class"),o(),t("span",{class:"token class-name"},"BrowserAdapter"),o(),t("span",{class:"token keyword"},"implements"),o(),t("span",{class:"token class-name"},"BaseAdapter"),o(),t("span",{class:"token punctuation"},"{"),o("\n  "),t("span",{class:"token keyword"},"private"),o(),t("span",{class:"token keyword"},"static"),o(),t("span",{class:"token function"},"init"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token punctuation"},"{"),o("\n    "),t("span",{class:"token keyword"},"if"),o(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),o(" fetch "),t("span",{class:"token operator"},"==="),o(),t("span",{class:"token string"},'"undefined"'),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token punctuation"},"{"),o("\n      "),t("span",{class:"token keyword"},"const"),o(" globalVar"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token builtin"},"any"),o(),t("span",{class:"token operator"},"="),o("\n        "),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),o(" globalThis "),t("span",{class:"token operator"},"!=="),o(),t("span",{class:"token string"},'"undefined"'),o(),t("span",{class:"token operator"},"&&"),o(" globalThis"),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token operator"},"||"),o("\n        "),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),o(" self "),t("span",{class:"token operator"},"!=="),o(),t("span",{class:"token string"},'"undefined"'),o(),t("span",{class:"token operator"},"&&"),o(" self"),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token operator"},"||"),o("\n        "),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),o(" global "),t("span",{class:"token operator"},"!=="),o(),t("span",{class:"token string"},'"undefined"'),o(),t("span",{class:"token operator"},"&&"),o(" global"),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token operator"},"||"),o("\n        "),t("span",{class:"token punctuation"},"{"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},";"),o("\n      "),t("span",{class:"token comment"},"// 关键在于这里的动态 require"),o("\n      Reflect"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"set"),t("span",{class:"token punctuation"},"("),o("globalVar"),t("span",{class:"token punctuation"},","),o(),t("span",{class:"token string"},'"fetch"'),t("span",{class:"token punctuation"},","),o(),t("span",{class:"token keyword"},"require"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"node-fetch"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),o("default"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n    "),t("span",{class:"token punctuation"},"}"),o("\n  "),t("span",{class:"token punctuation"},"}"),o("\n\n  "),t("span",{class:"token keyword"},"async"),o(),t("span",{class:"token generic-function"},[t("span",{class:"token function"},"get"),t("span",{class:"token generic class-name"},[t("span",{class:"token operator"},"<"),t("span",{class:"token constant"},"T"),t("span",{class:"token operator"},">")])]),t("span",{class:"token punctuation"},"("),o("url"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token builtin"},"Promise"),t("span",{class:"token operator"},"<"),t("span",{class:"token constant"},"T"),t("span",{class:"token operator"},">"),o(),t("span",{class:"token punctuation"},"{"),o("\n    BrowserAdapter"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"init"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n    "),t("span",{class:"token keyword"},"return"),o(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"await"),o(),t("span",{class:"token function"},"fetch"),t("span",{class:"token punctuation"},"("),o("url"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"json"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n  "),t("span",{class:"token punctuation"},"}"),o("\n"),t("span",{class:"token punctuation"},"}"),o("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br")])],-1),sn=t("p",null,[t("img",{src:"/assets/1a7d05ea9c1e4978bcc540c2eb8cca6f.dd94cd9e.png",alt:"1624018106300"})],-1),an=t("h2",{id:"在代码中判断运行时通过-import-动态引入依赖",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#在代码中判断运行时通过-import-动态引入依赖","aria-hidden":"true"},"#"),o(" 在代码中判断运行时通过 "),t("code",null,"import()"),o(" 动态引入依赖")],-1),tn={href:"https://github.com/rxliuli/cross-platform-lib-demo/tree/master/apps/platform-specific-lib-import",target:"_blank",rel:"noopener noreferrer"},en=o("GitHub 项目示例"),on=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token comment"},"// src/adapters/BaseAdapter.ts"),o("\n"),t("span",{class:"token keyword"},"import"),o(),t("span",{class:"token punctuation"},"{"),o(" BaseAdapter "),t("span",{class:"token punctuation"},"}"),o(),t("span",{class:"token keyword"},"from"),o(),t("span",{class:"token string"},'"./BaseAdapter"'),t("span",{class:"token punctuation"},";"),o("\n\n"),t("span",{class:"token keyword"},"export"),o(),t("span",{class:"token keyword"},"class"),o(),t("span",{class:"token class-name"},"BrowserAdapter"),o(),t("span",{class:"token keyword"},"implements"),o(),t("span",{class:"token class-name"},"BaseAdapter"),o(),t("span",{class:"token punctuation"},"{"),o("\n  "),t("span",{class:"token comment"},"// 注意，这里变成异步的函数了"),o("\n  "),t("span",{class:"token keyword"},"private"),o(),t("span",{class:"token keyword"},"static"),o(),t("span",{class:"token keyword"},"async"),o(),t("span",{class:"token function"},"init"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token punctuation"},"{"),o("\n    "),t("span",{class:"token keyword"},"if"),o(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),o(" fetch "),t("span",{class:"token operator"},"==="),o(),t("span",{class:"token string"},'"undefined"'),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token punctuation"},"{"),o("\n      "),t("span",{class:"token keyword"},"const"),o(" globalVar"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token builtin"},"any"),o(),t("span",{class:"token operator"},"="),o("\n        "),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),o(" globalThis "),t("span",{class:"token operator"},"!=="),o(),t("span",{class:"token string"},'"undefined"'),o(),t("span",{class:"token operator"},"&&"),o(" globalThis"),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token operator"},"||"),o("\n        "),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),o(" self "),t("span",{class:"token operator"},"!=="),o(),t("span",{class:"token string"},'"undefined"'),o(),t("span",{class:"token operator"},"&&"),o(" self"),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token operator"},"||"),o("\n        "),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),o(" global "),t("span",{class:"token operator"},"!=="),o(),t("span",{class:"token string"},'"undefined"'),o(),t("span",{class:"token operator"},"&&"),o(" global"),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token operator"},"||"),o("\n        "),t("span",{class:"token punctuation"},"{"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},";"),o("\n      Reflect"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"set"),t("span",{class:"token punctuation"},"("),o("globalVar"),t("span",{class:"token punctuation"},","),o(),t("span",{class:"token string"},'"fetch"'),t("span",{class:"token punctuation"},","),o(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"await"),o(),t("span",{class:"token keyword"},"import"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"node-fetch"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),o("default"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n    "),t("span",{class:"token punctuation"},"}"),o("\n  "),t("span",{class:"token punctuation"},"}"),o("\n\n  "),t("span",{class:"token keyword"},"async"),o(),t("span",{class:"token generic-function"},[t("span",{class:"token function"},"get"),t("span",{class:"token generic class-name"},[t("span",{class:"token operator"},"<"),t("span",{class:"token constant"},"T"),t("span",{class:"token operator"},">")])]),t("span",{class:"token punctuation"},"("),o("url"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token builtin"},"Promise"),t("span",{class:"token operator"},"<"),t("span",{class:"token constant"},"T"),t("span",{class:"token operator"},">"),o(),t("span",{class:"token punctuation"},"{"),o("\n    "),t("span",{class:"token keyword"},"await"),o(" BrowserAdapter"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"init"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n    "),t("span",{class:"token keyword"},"return"),o(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"await"),o(),t("span",{class:"token function"},"fetch"),t("span",{class:"token punctuation"},"("),o("url"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"json"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n  "),t("span",{class:"token punctuation"},"}"),o("\n"),t("span",{class:"token punctuation"},"}"),o("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br")])],-1),ln=t("p",null,"打包结果",-1),pn=t("p",null,[t("img",{src:"/assets/a5134edf1c7b4742aed1a0914faa45ad.b11aa7b0.png",alt:"1624018026889"})],-1),cn=t("h3",{id:"遇到的一些子问题",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#遇到的一些子问题","aria-hidden":"true"},"#"),o(" 遇到的一些子问题")],-1),rn=t("ul",null,[t("li",null,[t("p",null,"怎么判断是否存在全局变量"),t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"typeof"),o(" fetch "),t("span",{class:"token operator"},"==="),o(),t("span",{class:"token string"},'"undefined"'),t("span",{class:"token punctuation"},";"),o("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br")])])]),t("li",null,[t("p",null,"怎么为不同环境的全局变量写入 ployfill"),t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"const"),o(" globalVar"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token builtin"},"any"),o(),t("span",{class:"token operator"},"="),o("\n  "),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),o(" globalThis "),t("span",{class:"token operator"},"!=="),o(),t("span",{class:"token string"},'"undefined"'),o(),t("span",{class:"token operator"},"&&"),o(" globalThis"),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token operator"},"||"),o("\n  "),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),o(" self "),t("span",{class:"token operator"},"!=="),o(),t("span",{class:"token string"},'"undefined"'),o(),t("span",{class:"token operator"},"&&"),o(" self"),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token operator"},"||"),o("\n  "),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),o(" global "),t("span",{class:"token operator"},"!=="),o(),t("span",{class:"token string"},'"undefined"'),o(),t("span",{class:"token operator"},"&&"),o(" global"),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token operator"},"||"),o("\n  "),t("span",{class:"token punctuation"},"{"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},";"),o("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br")])])]),t("li",null,[t("p",null,[t("code",null,"TypeError: Right-hand side of 'instanceof' is not callable"),o(": 主要是 axios 会判断 "),t("code",null,"FormData"),o("，而 "),t("code",null,"form-data"),o(" 则存在默认导出，所以需要使用 "),t("code",null,"(await import('form-data')).default"),o("（吾辈总有种在给自己挖坑的感觉） "),t("img",{src:"/assets/2085a6a480124ea8b0fdddf4877f75c7.2b8abf69.png",alt:"1622828175546"})])])],-1),un=o("使用者在使用 rollup 打包时可能会遇到兼容性的问题，实际上就是需要选择内联到代码还是单独打包成一个文件，参考："),kn={href:"https://rollupjs.org/guide/en/#inlinedynamicimports",target:"_blank",rel:"noopener noreferrer"},dn=o("https://rollupjs.org/guide/en/#inlinedynamicimports"),bn=t("p",null,"内联 => 外联",-1),mn=t("div",{class:"language-javascript ext-js line-numbers-mode"},[t("pre",{class:"language-javascript"},[t("code",null,[t("span",{class:"token comment"},"// 内联"),o("\n"),t("span",{class:"token keyword"},"export"),o(),t("span",{class:"token keyword"},"default"),o(),t("span",{class:"token punctuation"},"{"),o("\n  output"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token punctuation"},"{"),o("\n    file"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"dist/extension.js"'),t("span",{class:"token punctuation"},","),o("\n    format"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"cjs"'),t("span",{class:"token punctuation"},","),o("\n    sourcemap"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token boolean"},"true"),t("span",{class:"token punctuation"},","),o("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),o("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},";"),o("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br")])],-1),fn=t("div",{class:"language-javascript ext-js line-numbers-mode"},[t("pre",{class:"language-javascript"},[t("code",null,[t("span",{class:"token comment"},"// 外联"),o("\n"),t("span",{class:"token keyword"},"export"),o(),t("span",{class:"token keyword"},"default"),o(),t("span",{class:"token punctuation"},"{"),o("\n  output"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token punctuation"},"{"),o("\n    dir"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"dist"'),t("span",{class:"token punctuation"},","),o("\n    format"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"cjs"'),t("span",{class:"token punctuation"},","),o("\n    sourcemap"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token boolean"},"true"),t("span",{class:"token punctuation"},","),o("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),o("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},";"),o("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br")])],-1),gn=t("h2",{id:"平台限定的类型定义",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#平台限定的类型定义","aria-hidden":"true"},"#"),o(" 平台限定的类型定义")],-1),yn=t("p",null,"以下解决方案本质上都是多个 bundle",-1),wn=t("ul",null,[t("li",null,"混合类型定义。例如 axios"),t("li",null,[o("打包不同的出口文件和类型定义，要求使用者自行指定需要的文件。例如通过 "),t("code",null,"module/node"),o("/"),t("code",null,"module/browser"),o(" 加载不同的功能（其实和插件系统非常接近，无非是否分离多个模块罢了）")]),t("li",null,"使用插件系统将不同环境的适配代码分离为多个子模块。例如 remark.js 社区")],-1),hn=t("table",null,[t("thead",null,[t("tr",null,[t("th",null,"对比"),t("th",null,"多个类型定义文件"),t("th",null,"混合类型定义"),t("th",null,"多模块")])]),t("tbody",null,[t("tr",null,[t("td",null,"优点"),t("td",null,"环境指定更明确"),t("td",null,"统一入口"),t("td",null,"环境指定更明确")]),t("tr",null,[t("td",null,"缺点"),t("td",null,"需要使用者自行选择"),t("td",null,"类型定义冗余"),t("td",null,"需要使用者自行选择")]),t("tr",null,[t("td"),t("td",null,"dependencies 冗余"),t("td"),t("td",null,"维护起来相对麻烦（尤其是维护者不是一个人的时候）")])])],-1),jn=t("h3",{id:"打包不同的出口文件和类型定义-要求使用者自行指定需要的文件",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#打包不同的出口文件和类型定义-要求使用者自行指定需要的文件","aria-hidden":"true"},"#"),o(" 打包不同的出口文件和类型定义，要求使用者自行指定需要的文件")],-1),xn={href:"https://github.com/rxliuli/cross-platform-lib-demo/tree/master/apps/platform-specific-type-definition-multiple-bundle",target:"_blank",rel:"noopener noreferrer"},vn=o("GitHub 项目示例"),An=t("p",null,"主要是在核心代码做一层抽象，然后将平台特定的代码抽离出去单独打包。",-1),Bn=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token comment"},"// src/index.ts"),o("\n"),t("span",{class:"token keyword"},"import"),o(),t("span",{class:"token punctuation"},"{"),o(" BaseAdapter "),t("span",{class:"token punctuation"},"}"),o(),t("span",{class:"token keyword"},"from"),o(),t("span",{class:"token string"},'"./adapters/BaseAdapter"'),t("span",{class:"token punctuation"},";"),o("\n\n"),t("span",{class:"token keyword"},"export"),o(),t("span",{class:"token keyword"},"class"),o(),t("span",{class:"token class-name"},[o("Adapter"),t("span",{class:"token operator"},"<"),t("span",{class:"token constant"},"T"),t("span",{class:"token operator"},">")]),o(),t("span",{class:"token keyword"},"implements"),o(),t("span",{class:"token class-name"},[o("BaseAdapter"),t("span",{class:"token operator"},"<"),t("span",{class:"token constant"},"T"),t("span",{class:"token operator"},">")]),o(),t("span",{class:"token punctuation"},"{"),o("\n  upload"),t("span",{class:"token operator"},":"),o(" BaseAdapter"),t("span",{class:"token operator"},"<"),t("span",{class:"token constant"},"T"),t("span",{class:"token operator"},">"),t("span",{class:"token punctuation"},"["),t("span",{class:"token string"},'"upload"'),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},";"),o("\n\n  "),t("span",{class:"token function"},"constructor"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"private"),o(" base"),t("span",{class:"token operator"},":"),o(" BaseAdapter"),t("span",{class:"token operator"},"<"),t("span",{class:"token constant"},"T"),t("span",{class:"token operator"},">"),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token punctuation"},"{"),o("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),o("upload "),t("span",{class:"token operator"},"="),o(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),o("base"),t("span",{class:"token punctuation"},"."),o("upload"),t("span",{class:"token punctuation"},";"),o("\n  "),t("span",{class:"token punctuation"},"}"),o("\n"),t("span",{class:"token punctuation"},"}"),o("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br")])],-1),Tn=t("div",{class:"language-javascript ext-js line-numbers-mode"},[t("pre",{class:"language-javascript"},[t("code",null,[t("span",{class:"token comment"},"// rollup.config.js"),o("\n\n"),t("span",{class:"token keyword"},"export"),o(),t("span",{class:"token keyword"},"default"),o(),t("span",{class:"token function"},"defineConfig"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"["),o("\n  "),t("span",{class:"token punctuation"},"{"),o("\n    input"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"src/index.ts"'),t("span",{class:"token punctuation"},","),o("\n    output"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token punctuation"},"["),o("\n      "),t("span",{class:"token punctuation"},"{"),o(" dir"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"dist/cjs"'),t("span",{class:"token punctuation"},","),o(" format"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"cjs"'),t("span",{class:"token punctuation"},","),o(" sourcemap"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token boolean"},"true"),o(),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),o("\n      "),t("span",{class:"token punctuation"},"{"),o(" dir"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"dist/esm"'),t("span",{class:"token punctuation"},","),o(" format"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"esm"'),t("span",{class:"token punctuation"},","),o(" sourcemap"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token boolean"},"true"),o(),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),o("\n    "),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},","),o("\n    plugins"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token punctuation"},"["),t("span",{class:"token function"},"typescript"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},","),o("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),o("\n  "),t("span",{class:"token punctuation"},"{"),o("\n    input"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token punctuation"},"["),t("span",{class:"token string"},'"src/adapters/BrowserAdapter.ts"'),t("span",{class:"token punctuation"},","),o(),t("span",{class:"token string"},'"src/adapters/NodeAdapter.ts"'),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},","),o("\n    output"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token punctuation"},"["),o("\n      "),t("span",{class:"token punctuation"},"{"),o(" dir"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"dist/cjs/adapters"'),t("span",{class:"token punctuation"},","),o(" format"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"cjs"'),t("span",{class:"token punctuation"},","),o(" sourcemap"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token boolean"},"true"),o(),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),o("\n      "),t("span",{class:"token punctuation"},"{"),o(" dir"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"dist/esm/adapters"'),t("span",{class:"token punctuation"},","),o(" format"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token string"},'"esm"'),t("span",{class:"token punctuation"},","),o(" sourcemap"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token boolean"},"true"),o(),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),o("\n    "),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},","),o("\n    plugins"),t("span",{class:"token operator"},":"),o(),t("span",{class:"token punctuation"},"["),t("span",{class:"token function"},"typescript"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},","),o("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),o("\n"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br")])],-1),qn=t("p",null,"使用者示例",-1),_n=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"import"),o(),t("span",{class:"token punctuation"},"{"),o(" Adapter "),t("span",{class:"token punctuation"},"}"),o(),t("span",{class:"token keyword"},"from"),o(),t("span",{class:"token string"},'"platform-specific-type-definition-multiple-bundle"'),t("span",{class:"token punctuation"},";"),o("\n\n"),t("span",{class:"token keyword"},"import"),o(),t("span",{class:"token punctuation"},"{"),o(" BrowserAdapter "),t("span",{class:"token punctuation"},"}"),o(),t("span",{class:"token keyword"},"from"),o(),t("span",{class:"token string"},'"platform-specific-type-definition-multiple-bundle/dist/esm/adapters/BrowserAdapter"'),t("span",{class:"token punctuation"},";"),o("\n"),t("span",{class:"token keyword"},"export"),o(),t("span",{class:"token keyword"},"async"),o(),t("span",{class:"token keyword"},"function"),o(),t("span",{class:"token function"},"browser"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token punctuation"},"{"),o("\n  "),t("span",{class:"token keyword"},"const"),o(" adapter "),t("span",{class:"token operator"},"="),o(),t("span",{class:"token keyword"},"new"),o(),t("span",{class:"token class-name"},"Adapter"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"new"),o(),t("span",{class:"token class-name"},"BrowserAdapter"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n  "),t("span",{class:"token builtin"},"console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"browser: "'),t("span",{class:"token punctuation"},","),o(),t("span",{class:"token keyword"},"await"),o(" adapter"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"upload"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"new"),o(),t("span",{class:"token class-name"},"Blob"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n"),t("span",{class:"token punctuation"},"}"),o("\n\n"),t("span",{class:"token comment"},"// import { NodeAdapter } from 'platform-specific-type-definition-multiple-bundle/dist/esm/adapters/NodeAdapter'"),o("\n"),t("span",{class:"token comment"},"// export async function node() {"),o("\n"),t("span",{class:"token comment"},"//   const adapter = new Adapter(new NodeAdapter())"),o("\n"),t("span",{class:"token comment"},"//   console.log('node: ', await adapter.upload(new Buffer(10)))"),o("\n"),t("span",{class:"token comment"},"// }"),o("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br")])],-1),Cn=t("h3",{id:"使用插件系统将不同环境的适配代码分离为多个子模块",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#使用插件系统将不同环境的适配代码分离为多个子模块","aria-hidden":"true"},"#"),o(" 使用插件系统将不同环境的适配代码分离为多个子模块")],-1),Hn=t("p",null,[o("简单来说，如果你希望将运行时依赖分散到不同的子模块中（例如上面那个 "),t("code",null,"node-fetch"),o("），或者你的插件 API 非常强大，那么便可以将一些"),t("strong",null,"官方"),o("适配代码分离为插件子模块。")],-1),Gn=t("h2",{id:"选择",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#选择","aria-hidden":"true"},"#"),o(" 选择")],-1),Nn=t("p",null,[t("img",{src:"/assets/1fb8606dac2c487eafca45ecc4e3a9a3.1de3ff6b.svg",alt:"兼容 nodejs 与浏览器的库的技术方案选择.drawio.svg"})],-1);l.render=function(o,l){const Pn=n("OutboundLink");return s(),a(e,null,[p,c,r,u,i,t("blockquote",null,[t("p",null,[t("a",k,[d,t(Pn)])])]),b,m,f,g,t("blockquote",null,[t("p",null,[y,t("a",w,[h,t(Pn)]),j,t("a",x,[v,t(Pn)])])]),A,B,T,t("blockquote",null,[t("p",null,[q,t("a",_,[C,t(Pn)]),H,t("a",G,[N,t(Pn)])])]),P,t("blockquote",null,[t("p",null,[t("a",V,[D,t(Pn)])])]),L,R,F,t("blockquote",null,[t("p",null,[t("a",E,[I,t(Pn)])])]),M,O,X,t("blockquote",null,[t("p",null,[z,t("a",J,[K,t(Pn)]),Q])]),S,U,W,Y,t("blockquote",null,[t("p",null,[t("a",Z,[$,t(Pn)])])]),nn,sn,an,t("blockquote",null,[t("p",null,[t("a",tn,[en,t(Pn)])])]),on,ln,pn,cn,rn,t("p",null,[un,t("a",kn,[dn,t(Pn)])]),bn,mn,fn,gn,yn,wn,hn,jn,t("blockquote",null,[t("p",null,[t("a",xn,[vn,t(Pn)])])]),An,Bn,Tn,qn,_n,Cn,Hn,Gn,Nn],64)};export{l as default};
