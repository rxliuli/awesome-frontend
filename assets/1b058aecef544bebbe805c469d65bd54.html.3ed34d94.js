import{r as n,o as s,c as a,a as t,F as o,b as e}from"./app.f01b6bc8.js";const c={},p=t("h2",{id:"场景",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#场景","aria-hidden":"true"},"#"),e(" 场景")],-1),l=e("在前文 "),u=t("a",{href:"/p/c0232eb08d0f4fb5a1ed997bbd04e130"},"基于 quickjs 封装 JavaScript 沙箱",-1),i=e(" 已经基于 quickjs 实现了一个沙箱，这里再基于 web worker 实现备用方案。如果你不知道 web worker 是什么或者从未了解过，可以查看 "),r={href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API",target:"_blank",rel:"noopener noreferrer"},k=e("Web Workers API"),b=e("。简而言之，它是一个浏览器实现的多线程，可以运行一段代码在另一个线程，并且提供与之通信的功能。"),m=t("h2",{id:"实现-ijavascriptshadowbox",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#实现-ijavascriptshadowbox","aria-hidden":"true"},"#"),e(" 实现 IJavaScriptShadowbox")],-1),d=t("p",null,[e("事实上，web worker 提供了 event emitter 的 api，即 "),t("code",null,"postMessage/onmessage"),e("，所以实现非常简单。")],-1),w=t("p",null,[e("实现分为两部分，一部分是在主线程实现 "),t("code",null,"IJavaScriptShadowbox"),e("，另一部分则是需要在 web worker 线程实现 "),t("code",null,"IEventEmitter")],-1),h=t("h3",{id:"主线程的实现",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#主线程的实现","aria-hidden":"true"},"#"),e(" 主线程的实现")],-1),f=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"import"),e(),t("span",{class:"token punctuation"},"{"),e(" IJavaScriptShadowbox "),t("span",{class:"token punctuation"},"}"),e(),t("span",{class:"token keyword"},"from"),e(),t("span",{class:"token string"},'"./IJavaScriptShadowbox"'),t("span",{class:"token punctuation"},";"),e("\n\n"),t("span",{class:"token keyword"},"export"),e(),t("span",{class:"token keyword"},"class"),e(),t("span",{class:"token class-name"},"WebWorkerShadowbox"),e(),t("span",{class:"token keyword"},"implements"),e(),t("span",{class:"token class-name"},"IJavaScriptShadowbox"),e(),t("span",{class:"token punctuation"},"{"),e("\n  "),t("span",{class:"token function"},"destroy"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"void"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("worker"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"terminate"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token punctuation"},"}"),e("\n\n  "),t("span",{class:"token keyword"},"private"),e(" worker"),t("span",{class:"token operator"},"!"),t("span",{class:"token operator"},":"),e(" Worker"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token function"},"eval"),t("span",{class:"token punctuation"},"("),e("code"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"void"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token keyword"},"const"),e(" blob "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},"Blob"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"["),e("code"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token punctuation"},"{"),e(" type"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"application/javascript"'),e(),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("worker "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},"Worker"),t("span",{class:"token punctuation"},"("),t("span",{class:"token constant"},"URL"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"createObjectURL"),t("span",{class:"token punctuation"},"("),e("blob"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token punctuation"},"{"),e("\n      credentials"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"include"'),t("span",{class:"token punctuation"},","),e("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("worker"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"addEventListener"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"message"'),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token punctuation"},"("),e("ev"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"=>"),e(),t("span",{class:"token punctuation"},"{"),e("\n      "),t("span",{class:"token keyword"},"const"),e(" msg "),t("span",{class:"token operator"},"="),e(" ev"),t("span",{class:"token punctuation"},"."),e("data "),t("span",{class:"token keyword"},"as"),e(),t("span",{class:"token punctuation"},"{"),e(" channel"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},";"),e(" data"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"any"),e(),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},";"),e("\n      "),t("span",{class:"token comment"},"// console.log('msg.data: ', msg)"),e("\n      "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"!"),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"has"),t("span",{class:"token punctuation"},"("),e("msg"),t("span",{class:"token punctuation"},"."),e("channel"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n        "),t("span",{class:"token keyword"},"return"),t("span",{class:"token punctuation"},";"),e("\n      "),t("span",{class:"token punctuation"},"}"),e("\n      "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"get"),t("span",{class:"token punctuation"},"("),e("msg"),t("span",{class:"token punctuation"},"."),e("channel"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},"!"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),e("handle"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"=>"),e(),t("span",{class:"token punctuation"},"{"),e("\n        "),t("span",{class:"token function"},"handle"),t("span",{class:"token punctuation"},"("),e("msg"),t("span",{class:"token punctuation"},"."),e("data"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n      "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token punctuation"},"}"),e("\n\n  "),t("span",{class:"token keyword"},"private"),e(),t("span",{class:"token keyword"},"readonly"),e(" listenerMap "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},[e("Map"),t("span",{class:"token operator"},"<"),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),e("data"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"=>")]),e(),t("span",{class:"token keyword"},"void"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token operator"},">"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token function"},"emit"),t("span",{class:"token punctuation"},"("),e("channel"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},","),e(" data"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"void"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("worker"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"postMessage"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n      channel"),t("span",{class:"token operator"},":"),e(" channel"),t("span",{class:"token punctuation"},","),e("\n      data"),t("span",{class:"token punctuation"},","),e("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token punctuation"},"}"),e("\n  "),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),e("channel"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token function-variable function"},"handle"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token punctuation"},"("),e("data"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"=>"),e(),t("span",{class:"token keyword"},"void"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"void"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"!"),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"has"),t("span",{class:"token punctuation"},"("),e("channel"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"set"),t("span",{class:"token punctuation"},"("),e("channel"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n    "),t("span",{class:"token punctuation"},"}"),e("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"get"),t("span",{class:"token punctuation"},"("),e("channel"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},"!"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"push"),t("span",{class:"token punctuation"},"("),e("handle"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token punctuation"},"}"),e("\n  "),t("span",{class:"token function"},"offByChannel"),t("span",{class:"token punctuation"},"("),e("channel"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"void"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"delete"),t("span",{class:"token punctuation"},"("),e("channel"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token punctuation"},"}"),e("\n"),t("span",{class:"token punctuation"},"}"),e("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br"),t("span",{class:"line-number"},"30"),t("br"),t("span",{class:"line-number"},"31"),t("br"),t("span",{class:"line-number"},"32"),t("br"),t("span",{class:"line-number"},"33"),t("br"),t("span",{class:"line-number"},"34"),t("br"),t("span",{class:"line-number"},"35"),t("br"),t("span",{class:"line-number"},"36"),t("br"),t("span",{class:"line-number"},"37"),t("br"),t("span",{class:"line-number"},"38"),t("br"),t("span",{class:"line-number"},"39"),t("br"),t("span",{class:"line-number"},"40"),t("br"),t("span",{class:"line-number"},"41"),t("br"),t("span",{class:"line-number"},"42"),t("br")])],-1),y=t("h3",{id:"web-worker-线程的实现",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#web-worker-线程的实现","aria-hidden":"true"},"#"),e(" web worker 线程的实现")],-1),g=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"import"),e(),t("span",{class:"token punctuation"},"{"),e(" IEventEmitter "),t("span",{class:"token punctuation"},"}"),e(),t("span",{class:"token keyword"},"from"),e(),t("span",{class:"token string"},'"./IEventEmitter"'),t("span",{class:"token punctuation"},";"),e("\n\n"),t("span",{class:"token keyword"},"export"),e(),t("span",{class:"token keyword"},"class"),e(),t("span",{class:"token class-name"},"WebWorkerEventEmitter"),e(),t("span",{class:"token keyword"},"implements"),e(),t("span",{class:"token class-name"},"IEventEmitter"),e(),t("span",{class:"token punctuation"},"{"),e("\n  "),t("span",{class:"token keyword"},"private"),e(),t("span",{class:"token keyword"},"readonly"),e(" listenerMap "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},[e("Map"),t("span",{class:"token operator"},"<"),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),e("data"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"=>")]),e(),t("span",{class:"token keyword"},"void"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token operator"},">"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n\n  "),t("span",{class:"token function"},"emit"),t("span",{class:"token punctuation"},"("),e("channel"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},","),e(" data"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"void"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token function"},"postMessage"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n      channel"),t("span",{class:"token operator"},":"),e(" channel"),t("span",{class:"token punctuation"},","),e("\n      data"),t("span",{class:"token punctuation"},","),e("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token punctuation"},"}"),e("\n\n  "),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),e("channel"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token function-variable function"},"handle"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token punctuation"},"("),e("data"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"any"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"=>"),e(),t("span",{class:"token keyword"},"void"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"void"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"!"),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"has"),t("span",{class:"token punctuation"},"("),e("channel"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"set"),t("span",{class:"token punctuation"},"("),e("channel"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n    "),t("span",{class:"token punctuation"},"}"),e("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"get"),t("span",{class:"token punctuation"},"("),e("channel"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},"!"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"push"),t("span",{class:"token punctuation"},"("),e("handle"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token punctuation"},"}"),e("\n\n  "),t("span",{class:"token function"},"offByChannel"),t("span",{class:"token punctuation"},"("),e("channel"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"void"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"delete"),t("span",{class:"token punctuation"},"("),e("channel"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token punctuation"},"}"),e("\n\n  "),t("span",{class:"token function"},"init"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token function-variable function"},"onmessage"),e(),t("span",{class:"token operator"},"="),e(),t("span",{class:"token punctuation"},"("),e("ev"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"=>"),e(),t("span",{class:"token punctuation"},"{"),e("\n      "),t("span",{class:"token keyword"},"const"),e(" msg "),t("span",{class:"token operator"},"="),e(" ev"),t("span",{class:"token punctuation"},"."),e("data "),t("span",{class:"token keyword"},"as"),e(),t("span",{class:"token punctuation"},"{"),e(" channel"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},";"),e(" data"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"any"),e(),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},";"),e("\n      "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"!"),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"has"),t("span",{class:"token punctuation"},"("),e("msg"),t("span",{class:"token punctuation"},"."),e("channel"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n        "),t("span",{class:"token keyword"},"return"),t("span",{class:"token punctuation"},";"),e("\n      "),t("span",{class:"token punctuation"},"}"),e("\n      "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"get"),t("span",{class:"token punctuation"},"("),e("msg"),t("span",{class:"token punctuation"},"."),e("channel"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},"!"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),e("handle"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"=>"),e(),t("span",{class:"token punctuation"},"{"),e("\n        "),t("span",{class:"token function"},"handle"),t("span",{class:"token punctuation"},"("),e("msg"),t("span",{class:"token punctuation"},"."),e("data"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n      "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token punctuation"},"}"),e("\n\n  "),t("span",{class:"token function"},"destroy"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("listenerMap"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"clear"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n    onmessage "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"null"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token punctuation"},"}"),e("\n"),t("span",{class:"token punctuation"},"}"),e("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br"),t("span",{class:"line-number"},"30"),t("br"),t("span",{class:"line-number"},"31"),t("br"),t("span",{class:"line-number"},"32"),t("br"),t("span",{class:"line-number"},"33"),t("br"),t("span",{class:"line-number"},"34"),t("br"),t("span",{class:"line-number"},"35"),t("br"),t("span",{class:"line-number"},"36"),t("br"),t("span",{class:"line-number"},"37"),t("br"),t("span",{class:"line-number"},"38"),t("br"),t("span",{class:"line-number"},"39"),t("br"),t("span",{class:"line-number"},"40"),t("br")])],-1),v=t("h2",{id:"使用-webworkershadowbox-webworkereventemitter",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#使用-webworkershadowbox-webworkereventemitter","aria-hidden":"true"},"#"),e(" 使用 WebWorkerShadowbox/WebWorkerEventEmitter")],-1),S=t("p",null,"主线程代码",-1),x=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"const"),e(" shadowbox"),t("span",{class:"token operator"},":"),e(" IJavaScriptShadowbox "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},"WebWorkerShadowbox"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\nshadowbox"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"hello"'),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token punctuation"},"("),e("name"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"=>"),e(),t("span",{class:"token punctuation"},"{"),e("\n  "),t("span",{class:"token builtin"},"console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token template-string"},[t("span",{class:"token template-punctuation string"},"`"),t("span",{class:"token string"},"hello "),t("span",{class:"token interpolation"},[t("span",{class:"token interpolation-punctuation punctuation"},"${"),e("name"),t("span",{class:"token interpolation-punctuation punctuation"},"}")]),t("span",{class:"token template-punctuation string"},"`")]),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n"),t("span",{class:"token comment"},"// 这里的 code 指的是下面 web worker 线程的代码"),e("\nshadowbox"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"eval"),t("span",{class:"token punctuation"},"("),e("code"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\nshadowbox"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"emit"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"open"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br")])],-1),W=t("p",null,"web worker 线程代码",-1),M=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"const"),e(" em "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},"WebWorkerEventEmitter"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\nem"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"open"'),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"=>"),e(" em"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"emit"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"hello"'),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token string"},'"liuli"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br")])],-1),E=t("p",null,"下面是代码的执行流程示意图",-1),I=t("p",null,[t("img",{src:"/assets/ad55b7b6016f4e099a2df120df913a2c.bbe0dd0b.svg",alt:"web worker 沙箱实现使用示例代码的执行流程.drawio.svg"})],-1),j=t("h2",{id:"限制-web-worker-全局-api",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#限制-web-worker-全局-api","aria-hidden":"true"},"#"),e(" 限制 web worker 全局 api")],-1),P=t("p",null,"经大佬 JackWoeker 提醒，web worker 有许多不安全的 api，所以必须限制，包含但不限于以下 api",-1),L=t("ul",null,[t("li",null,[t("code",null,"fetch")]),t("li",null,[t("code",null,"indexedDB")]),t("li",null,[t("code",null,"performance")])],-1),_=t("p",null,[e("事实上，web worker 默认自带了 "),t("strong",null,"276"),e(" 个全局 api，可能比我们想象中多很多。")],-1),J=t("p",null,[t("img",{src:"/assets/65fcc537ed0349ccbe722d5eb2a8c228.9aede7a7.png",alt:"Snipaste_2021-10-24_23-05-18"})],-1),B=e("有篇 "),C={href:"http://www.cs.columbia.edu/~simha/spyjs.ccs15.pdf",target:"_blank",rel:"noopener noreferrer"},R=e("文章"),A=e(" 阐述了如何在 web 上通过 "),G=t("code",null,"performance/SharedArrayBuffer",-1),O=e(" api 做侧信道攻击，即便现在 "),T=t("code",null,"SharedArrayBuffer",-1),F=e(" api 现在浏览器默认已经禁用了，但天知道还有没有其他方法。所以最安全的方法是设置一个 api 白名单，然后删除掉非白名单的 api。"),N=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token comment"},"// whitelistWorkerGlobalScope.ts"),e("\n"),t("span",{class:"token doc-comment comment"},"/**\n * 设定 web worker 运行时白名单，ban 掉所有不安全的 api\n */"),e("\n"),t("span",{class:"token keyword"},"export"),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token function"},"whitelistWorkerGlobalScope"),t("span",{class:"token punctuation"},"("),e("list"),t("span",{class:"token operator"},":"),e(" PropertyKey"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  "),t("span",{class:"token keyword"},"const"),e(" whitelist "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},"Set"),t("span",{class:"token punctuation"},"("),e("list"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token keyword"},"const"),e(" all "),t("span",{class:"token operator"},"="),e(" Reflect"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"ownKeys"),t("span",{class:"token punctuation"},"("),e("globalThis"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  all"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),e("k"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"=>"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("whitelist"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"has"),t("span",{class:"token punctuation"},"("),e("k"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      "),t("span",{class:"token keyword"},"return"),t("span",{class:"token punctuation"},";"),e("\n    "),t("span",{class:"token punctuation"},"}"),e("\n    "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("k "),t("span",{class:"token operator"},"==="),e(),t("span",{class:"token string"},'"window"'),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      "),t("span",{class:"token builtin"},"console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"window: "'),t("span",{class:"token punctuation"},","),e(" k"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n    "),t("span",{class:"token punctuation"},"}"),e("\n    Reflect"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"deleteProperty"),t("span",{class:"token punctuation"},"("),e("globalThis"),t("span",{class:"token punctuation"},","),e(" k"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n"),t("span",{class:"token punctuation"},"}"),e("\n\n"),t("span",{class:"token doc-comment comment"},"/**\n * 全局值的白名单\n */"),e("\n"),t("span",{class:"token keyword"},"const"),e(" whitelist"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token punctuation"},"("),e("\n  "),t("span",{class:"token operator"},"|"),e(),t("span",{class:"token keyword"},"keyof"),e(),t("span",{class:"token keyword"},"typeof"),e(" global\n  "),t("span",{class:"token operator"},"|"),e(),t("span",{class:"token keyword"},"keyof"),e(" WindowOrWorkerGlobalScope\n  "),t("span",{class:"token operator"},"|"),e(),t("span",{class:"token string"},'"console"'),e("\n"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),e(),t("span",{class:"token operator"},"="),e(),t("span",{class:"token punctuation"},"["),e("\n  "),t("span",{class:"token string"},'"globalThis"'),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token string"},'"console"'),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token string"},'"setTimeout"'),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token string"},'"clearTimeout"'),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token string"},'"setInterval"'),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token string"},'"clearInterval"'),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token string"},'"postMessage"'),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token string"},'"onmessage"'),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token string"},'"Reflect"'),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token string"},'"Array"'),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token string"},'"Map"'),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token string"},'"Set"'),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token string"},'"Function"'),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token string"},'"Object"'),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token string"},'"Boolean"'),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token string"},'"String"'),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token string"},'"Number"'),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token string"},'"Math"'),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token string"},'"Date"'),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token string"},'"JSON"'),t("span",{class:"token punctuation"},","),e("\n"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},";"),e("\n\n"),t("span",{class:"token function"},"whitelistWorkerGlobalScope"),t("span",{class:"token punctuation"},"("),e("whitelist"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br"),t("span",{class:"line-number"},"30"),t("br"),t("span",{class:"line-number"},"31"),t("br"),t("span",{class:"line-number"},"32"),t("br"),t("span",{class:"line-number"},"33"),t("br"),t("span",{class:"line-number"},"34"),t("br"),t("span",{class:"line-number"},"35"),t("br"),t("span",{class:"line-number"},"36"),t("br"),t("span",{class:"line-number"},"37"),t("br"),t("span",{class:"line-number"},"38"),t("br"),t("span",{class:"line-number"},"39"),t("br"),t("span",{class:"line-number"},"40"),t("br"),t("span",{class:"line-number"},"41"),t("br"),t("span",{class:"line-number"},"42"),t("br"),t("span",{class:"line-number"},"43"),t("br"),t("span",{class:"line-number"},"44"),t("br"),t("span",{class:"line-number"},"45"),t("br"),t("span",{class:"line-number"},"46"),t("br"),t("span",{class:"line-number"},"47"),t("br"),t("span",{class:"line-number"},"48"),t("br"),t("span",{class:"line-number"},"49"),t("br")])],-1),q=t("p",null,"然后在执行第三方代码前先执行上面的代码",-1),z=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"import"),e(" beforeCode "),t("span",{class:"token keyword"},"from"),e(),t("span",{class:"token string"},'"./whitelistWorkerGlobalScope.js?raw"'),t("span",{class:"token punctuation"},";"),e("\n\n"),t("span",{class:"token keyword"},"export"),e(),t("span",{class:"token keyword"},"class"),e(),t("span",{class:"token class-name"},"WebWorkerShadowbox"),e(),t("span",{class:"token keyword"},"implements"),e(),t("span",{class:"token class-name"},"IJavaScriptShadowbox"),e(),t("span",{class:"token punctuation"},"{"),e("\n  "),t("span",{class:"token function"},"destroy"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"void"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("worker"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"terminate"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token punctuation"},"}"),e("\n\n  "),t("span",{class:"token keyword"},"private"),e(" worker"),t("span",{class:"token operator"},"!"),t("span",{class:"token operator"},":"),e(" Worker"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token function"},"eval"),t("span",{class:"token punctuation"},"("),e("code"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"void"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token comment"},"// 这行是关键"),e("\n    "),t("span",{class:"token keyword"},"const"),e(" blob "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},"Blob"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"["),e("beforeCode "),t("span",{class:"token operator"},"+"),e(),t("span",{class:"token string"},'"\\n"'),e(),t("span",{class:"token operator"},"+"),e(" code"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token punctuation"},"{"),e("\n      type"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"application/javascript"'),t("span",{class:"token punctuation"},","),e("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n    "),t("span",{class:"token comment"},"// 其他代码。。。"),e("\n  "),t("span",{class:"token punctuation"},"}"),e("\n"),t("span",{class:"token punctuation"},"}"),e("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br")])],-1),D=t("p",null,[e("由于我们使用 ts 编写源码，所以还必须将 ts 打包为 js bundle，然后通过 vite 的 "),t("code",null,"?raw"),e(" 作为字符串引入，下面吾辈写了一个简单的插件来完成这件事。")],-1),K=t("div",{class:"language-typescript ext-ts line-numbers-mode"},[t("pre",{class:"language-typescript"},[t("code",null,[t("span",{class:"token keyword"},"import"),e(),t("span",{class:"token punctuation"},"{"),e(" defineConfig"),t("span",{class:"token punctuation"},","),e(" Plugin "),t("span",{class:"token punctuation"},"}"),e(),t("span",{class:"token keyword"},"from"),e(),t("span",{class:"token string"},'"vite"'),t("span",{class:"token punctuation"},";"),e("\n"),t("span",{class:"token keyword"},"import"),e(" reactRefresh "),t("span",{class:"token keyword"},"from"),e(),t("span",{class:"token string"},'"@vitejs/plugin-react-refresh"'),t("span",{class:"token punctuation"},";"),e("\n"),t("span",{class:"token keyword"},"import"),e(" checker "),t("span",{class:"token keyword"},"from"),e(),t("span",{class:"token string"},'"vite-plugin-checker"'),t("span",{class:"token punctuation"},";"),e("\n"),t("span",{class:"token keyword"},"import"),e(),t("span",{class:"token punctuation"},"{"),e(" build "),t("span",{class:"token punctuation"},"}"),e(),t("span",{class:"token keyword"},"from"),e(),t("span",{class:"token string"},'"esbuild"'),t("span",{class:"token punctuation"},";"),e("\n"),t("span",{class:"token keyword"},"import"),e(),t("span",{class:"token operator"},"*"),e(),t("span",{class:"token keyword"},"as"),e(" path "),t("span",{class:"token keyword"},"from"),e(),t("span",{class:"token string"},'"path"'),t("span",{class:"token punctuation"},";"),e("\n\n"),t("span",{class:"token keyword"},"export"),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token function"},"buildScript"),t("span",{class:"token punctuation"},"("),e("scriptList"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),t("span",{class:"token operator"},":"),e(" Plugin "),t("span",{class:"token punctuation"},"{"),e("\n  "),t("span",{class:"token keyword"},"const"),e(" _scriptList "),t("span",{class:"token operator"},"="),e(" scriptList"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"map"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),e("src"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"=>"),e(" path"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"resolve"),t("span",{class:"token punctuation"},"("),e("src"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token keyword"},"async"),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token function"},"buildScript"),t("span",{class:"token punctuation"},"("),e("src"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token builtin"},"string"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token keyword"},"await"),e(),t("span",{class:"token function"},"build"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n      entryPoints"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token punctuation"},"["),e("src"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},","),e("\n      outfile"),t("span",{class:"token operator"},":"),e(" src"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"slice"),t("span",{class:"token punctuation"},"("),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},","),e(" src"),t("span",{class:"token punctuation"},"."),e("length "),t("span",{class:"token operator"},"-"),e(),t("span",{class:"token number"},"2"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"+"),e(),t("span",{class:"token string"},'"js"'),t("span",{class:"token punctuation"},","),e("\n      format"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"iife"'),t("span",{class:"token punctuation"},","),e("\n      bundle"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token boolean"},"true"),t("span",{class:"token punctuation"},","),e("\n      platform"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"browser"'),t("span",{class:"token punctuation"},","),e("\n      sourcemap"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"inline"'),t("span",{class:"token punctuation"},","),e("\n      allowOverwrite"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token boolean"},"true"),t("span",{class:"token punctuation"},","),e("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n    "),t("span",{class:"token builtin"},"console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"构建完成: "'),t("span",{class:"token punctuation"},","),e(" path"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"relative"),t("span",{class:"token punctuation"},"("),e("path"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"resolve"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),e(" src"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token punctuation"},"}"),e("\n  "),t("span",{class:"token keyword"},"return"),e(),t("span",{class:"token punctuation"},"{"),e("\n    name"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"vite-plugin-build-script"'),t("span",{class:"token punctuation"},","),e("\n\n    "),t("span",{class:"token keyword"},"async"),e(),t("span",{class:"token function"},"configureServer"),t("span",{class:"token punctuation"},"("),e("server"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      server"),t("span",{class:"token punctuation"},"."),e("watcher"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"add"),t("span",{class:"token punctuation"},"("),e("_scriptList"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n      "),t("span",{class:"token keyword"},"const"),e(" scriptSet "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},"Set"),t("span",{class:"token punctuation"},"("),e("_scriptList"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n      server"),t("span",{class:"token punctuation"},"."),e("watcher"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"change"'),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token punctuation"},"("),e("filePath"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"=>"),e(),t("span",{class:"token punctuation"},"{"),e("\n        "),t("span",{class:"token comment"},"// console.log('change: ', filePath)"),e("\n        "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("scriptSet"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"has"),t("span",{class:"token punctuation"},"("),e("filePath"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n          "),t("span",{class:"token function"},"buildScript"),t("span",{class:"token punctuation"},"("),e("filePath"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n        "),t("span",{class:"token punctuation"},"}"),e("\n      "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n    "),t("span",{class:"token keyword"},"async"),e(),t("span",{class:"token function"},"buildStart"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      "),t("span",{class:"token comment"},"// console.log('buildStart: ', this.meta.watchMode)"),e("\n      "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("meta"),t("span",{class:"token punctuation"},"."),e("watchMode"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n        _scriptList"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),e("src"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"=>"),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"addWatchFile"),t("span",{class:"token punctuation"},"("),e("src"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n      "),t("span",{class:"token punctuation"},"}"),e("\n      "),t("span",{class:"token keyword"},"await"),e(),t("span",{class:"token builtin"},"Promise"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"all"),t("span",{class:"token punctuation"},"("),e("_scriptList"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"map"),t("span",{class:"token punctuation"},"("),e("buildScript"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},";"),e("\n"),t("span",{class:"token punctuation"},"}"),e("\n\n"),t("span",{class:"token comment"},"// https://vitejs.dev/config/"),e("\n"),t("span",{class:"token keyword"},"export"),e(),t("span",{class:"token keyword"},"default"),e(),t("span",{class:"token function"},"defineConfig"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n  plugins"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token punctuation"},"["),e("\n    "),t("span",{class:"token function"},"reactRefresh"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),e("\n    "),t("span",{class:"token function"},"checker"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e(),t("span",{class:"token keyword"},"type"),e("script"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token boolean"},"true"),e(),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),e("\n    "),t("span",{class:"token function"},"buildScript"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"["),e("path"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"resolve"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"src/utils/app/whitelistWorkerGlobalScope.ts"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},","),e("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br"),t("span",{class:"line-number"},"30"),t("br"),t("span",{class:"line-number"},"31"),t("br"),t("span",{class:"line-number"},"32"),t("br"),t("span",{class:"line-number"},"33"),t("br"),t("span",{class:"line-number"},"34"),t("br"),t("span",{class:"line-number"},"35"),t("br"),t("span",{class:"line-number"},"36"),t("br"),t("span",{class:"line-number"},"37"),t("br"),t("span",{class:"line-number"},"38"),t("br"),t("span",{class:"line-number"},"39"),t("br"),t("span",{class:"line-number"},"40"),t("br"),t("span",{class:"line-number"},"41"),t("br"),t("span",{class:"line-number"},"42"),t("br"),t("span",{class:"line-number"},"43"),t("br"),t("span",{class:"line-number"},"44"),t("br"),t("span",{class:"line-number"},"45"),t("br"),t("span",{class:"line-number"},"46"),t("br"),t("span",{class:"line-number"},"47"),t("br"),t("span",{class:"line-number"},"48"),t("br"),t("span",{class:"line-number"},"49"),t("br"),t("span",{class:"line-number"},"50"),t("br"),t("span",{class:"line-number"},"51"),t("br")])],-1),U=t("p",null,"现在，我们可以看到 web worker 中的全局 api 只有白名单中的那些了。",-1),$=t("p",null,[t("img",{src:"/assets/3d18e37a137740f1a99f94e602925021.03a6b779.png",alt:"1635097498575"})],-1),H=t("h2",{id:"web-worker-沙箱的主要优势",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#web-worker-沙箱的主要优势","aria-hidden":"true"},"#"),e(" web worker 沙箱的主要优势")],-1),Q=t("ul",null,[t("li",null,"可以直接使用 chrome devtool 调试"),t("li",null,[e("直接支持 "),t("code",null,"console/setTimeout/setInterval"),e(" api")]),t("li",null,"直接支持消息通信的 api")],-1);c.render=function(e,c){const V=n("OutboundLink");return s(),a(o,null,[p,t("p",null,[l,u,i,t("a",r,[k,t(V)]),b]),m,d,w,h,f,y,g,v,S,x,W,M,E,I,j,P,L,_,J,t("p",null,[B,t("a",C,[R,t(V)]),A,G,O,T,F]),N,q,z,D,K,U,$,H,Q],64)};export{c as default};
